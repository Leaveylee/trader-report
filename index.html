<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易員報告書</title>
    
    <!-- PWA 相關設定 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFE4D6">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="交易員報告書">

    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 引入 SheetJS (xlsx) CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans TC', sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #FFF3E6 0%, #FFE4D6 100%);
            padding: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 2rem;
            width: 90%;
            max-width: 1200px; /* 調整寬度以適應新增區塊 */
            margin: 0 auto;
            box-shadow: 0 8px 32px rgba(184, 134, 113, 0.1);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid rgba(184, 110, 82, 0.2);
            border-radius: 8px;
            background: white;
            color: #444;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #B86E52;
            box-shadow: 0 0 0 2px rgba(184, 110, 82, 0.1);
        }

        .button {
            background: linear-gradient(135deg, #E67E51 0%, #F1945E 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(230, 126, 81, 0.2);
        }

        .delete-button {
            color: #dc2626;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .delete-button:hover {
            color: #b91c1c;
        }

        /* 新增細線樣式 */
        .divider {
            border-bottom: 1px solid #e5e7eb; /* Tailwind 的 gray-200 */
            margin: 0.5rem 0;
        }

        /* 表格樣式調整 */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            /* 允許文字換行 */
            white-space: normal;
            word-break: break-word;
        }

        th {
            background-color: #f9fafb; /* Tailwind 的 gray-50 */
            font-weight: 600;
        }

        /* 模態框樣式 */
        .modal {
            display: flex;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .hidden {
            display: none;
        }

        /* 自定義頂部滾動條樣式 */
        .scrollbar-top {
            height: 16px; /* 標準滾動條高度 */
            margin-bottom: 8px; /* 與表格之間的間距 */
        }

        #topScrollbarContent {
            height: 1px; /* 只需要足夠的高度來顯示滾動條 */
        }

        /* 隱藏頂部滾動條的內容 */
        #topScrollbarContent::after {
            content: "";
            display: block;
            width: 100%;
            height: 1px;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1 class="text-2xl font-bold text-center mb-8 text-[#B86E52]">
            交易員報告書
        </h1>

        <!-- 策略、外部條件和手動日期範圍篩選 -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                篩選條件
            </label>
            <div class="flex space-x-4">
                <!-- 策略篩選 -->
                <div class="flex-1">
                    <label for="strategyFilter" class="block text-sm font-medium text-gray-700 mb-1">
                        篩選策略
                    </label>
                    <select id="strategyFilter" class="w-full p-2 border rounded" onchange="applyFilters()">
                        <option value="">全部策略</option>
                        <!-- 策略選項將在 JavaScript 中動態添加 -->
                    </select>
                </div>
                <!-- 外部條件篩選 -->
                <div class="flex-1">
                    <label for="externalConditionFilter" class="block text-sm font-medium text-gray-700 mb-1">
                        篩選外部條件
                    </label>
                    <select id="externalConditionFilter" class="w-full p-2 border rounded" onchange="applyFilters()">
                        <option value="">全部外部條件</option>
                        <!-- 外部條件選項將在 JavaScript 中動態添加 -->
                    </select>
                </div>
                <!-- 手動日期範圍篩選 -->
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        篩選日期範圍
                    </label>
                    <div class="flex space-x-2">
                        <input type="date" id="startDateFilter" class="w-1/2 p-2 border rounded" onchange="applyFilters()" placeholder="開始日期">
                        <input type="date" id="endDateFilter" class="w-1/2 p-2 border rounded" onchange="applyFilters()" placeholder="結束日期">
                    </div>
                    <!-- 新增的調整日期範圍按鈕，僅影響結束日期 -->
                    <div class="flex space-x-2 mt-2">
                        <button class="button" onclick="shiftEndDate(-1)">前一天</button>
                        <button class="button" onclick="shiftEndDate(1)">後一天</button>
                        <button class="button" onclick="clearDateFilters()">清除日期篩選</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分析結果區塊 -->
        <div class="bg-gray-50 p-4 rounded mb-6">
            <h2 class="text-lg font-medium text-gray-700 mb-4">分析結果</h2>
            
            <!-- 報告書的結論 -->
            <div class="space-y-4">
                <!-- 第一行：交易數、勝率、風報比 -->
                <div class="flex justify-between font-bold text-lg">
                    <div class="flex-1 text-center">
                        <span class="text-gray-600">交易數：</span>
                        <span id="totalTrades" class="font-medium">0</span>
                    </div>
                    <div class="flex-1 text-center">
                        <span class="text-gray-600">勝率：</span>
                        <span id="winRate" class="font-medium">0% (0勝0敗)</span>
                    </div>
                    <div class="flex-1 text-center">
                        <span class="text-gray-600">風報比：</span>
                        <span id="riskRewardRatio" class="font-medium">0</span>
                    </div>
                </div>

                <!-- 第二行：期望值 -->
                <div class="flex justify-between font-bold text-lg">
                    <div class="flex-1 text-center">
                        <span class="text-gray-700">期望值：</span>
                        <span id="expectedValue" class="font-bold text-lg">
                            0.0%
                        </span>
                    </div>
                </div>

                <!-- 第三行：總報酬 -->
                <div class="flex justify-between font-bold text-lg">
                    <div class="flex-1 text-center">
                        <span class="text-gray-700">總報酬：</span>
                        <span id="totalReturn" class="font-bold text-lg">
                            0%
                        </span>
                    </div>
                </div>
            </div>

            <!-- 損益統計 -->
            <div class="mt-6">
                <h3 class="text-md font-medium text-gray-700 mb-3">
                    損益統計
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <!-- 第一行：平均獲利、平均虧損 -->
                    <div class="flex justify-between">
                        <span class="text-gray-600">平均獲利：</span>
                        <span id="avgWin" class="font-medium">+0 (+0.00%)</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">平均虧損：</span>
                        <span id="avgLoss" class="font-medium">-0 (-0.00%)</span>
                    </div>
                    <!-- 分隔線 -->
                    <div class="col-span-2 divider"></div>
                    <!-- 第二行：最大獲利、最大虧損 -->
                    <div class="flex justify-between">
                        <span class="text-gray-600">最大獲利：</span>
                        <span id="maxWin" class="font-medium">+0 (+0.00%)</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">最大虧損：</span>
                        <span id="maxLoss" class="font-medium">-0 (-0.00%)</span>
                    </div>
                    <!-- 分隔線 -->
                    <div class="col-span-2 divider"></div>
                </div>
            </div>
        </div>

        <!-- 策略管理區塊（可收合） -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-medium text-gray-700">策略管理</h2>
                <div class="flex space-x-2">
                    <button class="button" onclick="toggleStrategyManagement()">
                        <i id="strategyToggleIcon" data-lucide="chevron-down" class="inline-block mr-2"></i>
                        收合
                    </button>
                    <button class="button" onclick="openAddStrategyModal()">
                        新增
                    </button>
                    <!-- 修改後的匯出策略按鈕 -->
                    <button class="button" onclick="exportStrategiesToExcel()">
                        匯出
                    </button>
                    <!-- 修改後的匯入策略按鈕 -->
                    <button class="button" onclick="document.getElementById('importStrategiesInput').click()">
                        匯入
                    </button>
                    <!-- 隱藏的文件輸入元素 -->
                    <input type="file" id="importStrategiesInput" accept=".xlsx, .xls" class="hidden" onchange="importStrategiesFromExcel(event)">
                </div>
            </div>
            <div id="strategyManagementContent" class="overflow-x-auto">
                <table class="min-w-full bg-white rounded">
                    <thead>
                        <tr>
                            <th class="px-4 py-2 min-w-[150px]">策略名稱</th>
                            <th class="px-4 py-2 min-w-[200px]">描述</th>
                            <th class="px-4 py-2">操作</th>
                        </tr>
                    </thead>
                    <tbody id="strategiesList">
                        <!-- 策略記錄將在這裡動態添加為表格行 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 外部條件管理區塊（可收合） -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-medium text-gray-700">外部條件管理</h2>
                <div class="flex space-x-2">
                    <button class="button" onclick="toggleExternalConditionManagement()">
                        <i id="externalConditionToggleIcon" data-lucide="chevron-down" class="inline-block mr-2"></i>
                        收合
                    </button>
                    <button class="button" onclick="openAddExternalConditionModal()">
                        新增
                    </button>
                    <!-- 修改後的匯出外部條件按鈕 -->
                    <button class="button" onclick="exportExternalConditionsToExcel()">
                        匯出
                    </button>
                    <!-- 修改後的匯入外部條件按鈕 -->
                    <button class="button" onclick="document.getElementById('importExternalConditionsInput').click()">
                        匯入
                    </button>
                    <!-- 隱藏的文件輸入元素 -->
                    <input type="file" id="importExternalConditionsInput" accept=".xlsx, .xls" class="hidden" onchange="importExternalConditionsFromExcel(event)">
                </div>
            </div>
            <div id="externalConditionManagementContent" class="overflow-x-auto">
                <table class="min-w-full bg-white rounded">
                    <thead>
                        <tr>
                            <th class="px-4 py-2 min-w-[150px]">外部條件名稱</th>
                            <th class="px-4 py-2 min-w-[200px]">描述</th>
                            <th class="px-4 py-2">操作</th>
                        </tr>
                    </thead>
                    <tbody id="externalConditionsList">
                        <!-- 外部條件記錄將在這裡動態添加為表格行 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 新增策略模態框 -->
        <div id="addStrategyModal" class="modal hidden">
            <div class="bg-white p-6 rounded-lg w-96">
                <h3 class="text-lg font-medium mb-4">新增</h3>
                <label class="block text-sm font-medium text-gray-700 mb-2" for="newStrategyName">策略名稱</label>
                <input type="text" id="newStrategyName" class="w-full p-2 border rounded mb-4" placeholder="輸入策略名稱">
                
                <label class="block text-sm font-medium text-gray-700 mb-2" for="newStrategyDescription">描述</label>
                <textarea id="newStrategyDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入策略描述"></textarea>
                
                <div class="flex justify-end">
                    <button class="button mr-2" onclick="closeAddStrategyModal()">取消</button>
                    <button class="button" onclick="addStrategy()">新增</button>
                </div>
            </div>
        </div>

        <!-- 編輯策略模態框 -->
        <div id="editStrategyModal" class="modal hidden">
            <div class="bg-white p-6 rounded-lg w-96">
                <h3 class="text-lg font-medium mb-4">編輯策略</h3>
                <input type="hidden" id="editStrategyId">
                
                <label class="block text-sm font-medium text-gray-700 mb-2" for="editStrategyName">策略名稱</label>
                <input type="text" id="editStrategyName" class="w-full p-2 border rounded mb-4" placeholder="輸入策略名稱">
                
                <label class="block text-sm font-medium text-gray-700 mb-2" for="editStrategyDescription">描述</label>
                <textarea id="editStrategyDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入策略描述"></textarea>
                
                <div class="flex justify-end">
                    <button class="button mr-2" onclick="closeEditStrategyModal()">取消</button>
                    <button class="button" onclick="updateStrategy()">更新</button>
                </div>
            </div>
        </div>

        <!-- 新增外部條件模態框 -->
        <div id="addExternalConditionModal" class="modal hidden">
            <div class="bg-white p-6 rounded-lg w-96">
                <h3 class="text-lg font-medium mb-4">新增</h3>
                <label class="block text-sm font-medium text-gray-700 mb-2" for="newExternalConditionName">外部條件名稱</label>
                <input type="text" id="newExternalConditionName" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件名稱">
                
                <label class="block text-sm font-medium text-gray-700 mb-2" for="newExternalConditionDescription">描述</label>
                <textarea id="newExternalConditionDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件描述"></textarea>
                
                <div class="flex justify-end">
                    <button class="button mr-2" onclick="closeAddExternalConditionModal()">取消</button>
                    <button class="button" onclick="addExternalCondition()">新增</button>
                </div>
            </div>
        </div>

        <!-- 編輯外部條件模態框 -->
        <div id="editExternalConditionModal" class="modal hidden">
            <div class="bg-white p-6 rounded-lg w-96">
                <h3 class="text-lg font-medium mb-4">編輯外部條件</h3>
                <input type="hidden" id="editExternalConditionId">
                
                <label class="block text-sm font-medium text-gray-700 mb-2" for="editExternalConditionName">外部條件名稱</label>
                <input type="text" id="editExternalConditionName" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件名稱">
                
                <label class="block text-sm font-medium text-gray-700 mb-2" for="editExternalConditionDescription">描述</label>
                <textarea id="editExternalConditionDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件描述"></textarea>
                
                <div class="flex justify-end">
                    <button class="button mr-2" onclick="closeEditExternalConditionModal()">取消</button>
                    <button class="button" onclick="updateExternalCondition()">更新</button>
                </div>
            </div>
        </div>

        <!-- 交易記錄區域 -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-medium text-gray-700">交易紀錄</h2>
                <div class="flex space-x-2">
                    <button class="button" onclick="addTrade()">
                        添加交易
                    </button>
                    <button class="button" onclick="exportToExcel()">
                        匯出
                    </button>
                    <button class="button" onclick="document.getElementById('importExcelInput').click()">
                        匯入
                    </button>
                    <!-- 隱藏的文件輸入元素 -->
                    <input type="file" id="importExcelInput" accept=".xlsx, .xls" class="hidden" onchange="importFromExcel(event)">
                </div>
            </div>
            <div class="text-sm text-gray-600 mb-2">
                請輸入交易報酬率（例如：+6.66、-2.92）、部位金額、標的名稱、策略名稱、外部條件、開倉日和平倉日
            </div>
            <div class="relative">
                <!-- 頂部滾動條 -->
                <div class="overflow-x-auto scrollbar-top" id="topScrollbar">
                    <div id="topScrollbarContent"></div>
                </div>
                <!-- 表格滾動區域 -->
                <div class="overflow-x-auto" id="bottomScrollbar">
                    <table class="min-w-full bg-white rounded">
                        <thead>
                            <tr>
                                <th class="px-4 py-2 min-w-[80px]">交易</th>
                                <th class="px-4 py-2 min-w-[100px]">開倉日</th>
                                <th class="px-4 py-2 min-w-[100px]">平倉日</th>
                                <th class="px-4 py-2 min-w-[100px]">持倉天數</th>
                                <th class="px-4 py-2 min-w-[100px]">報酬率 (%)</th>
                                <th class="px-4 py-2 min-w-[100px]">部位金額</th>
                                <th class="px-4 py-2 min-w-[150px]">標的名稱</th>
                                <th class="px-4 py-2 min-w-[150px]">策略名稱</th>
                                <th class="px-4 py-2 min-w-[150px]">外部條件</th>
                                <th class="px-4 py-2 min-w-[200px]">文字說明</th>
                                <th class="px-4 py-2 min-w-[200px]">圖片</th>
                                <th class="px-4 py-2 min-w-[80px]">操作</th>
                            </tr>
                        </thead>
                        <tbody id="tradesList">
                            <!-- 交易記錄將在這裡動態添加為表格行 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            // 策略列表
            let strategies = [{ id: 1, name: '默認策略', description: '這是默認策略' }];
            // 外部條件列表
            let externalConditions = [{ id: 1, name: '默認外部條件', description: '這是默認外部條件' }];
            // 交易記錄列表
            let trades = [];
            // 當前篩選條件
            let selectedStrategyFilter = null;
            let selectedExternalConditionFilter = null;
            let selectedStartDateFilter = null; // 新增開始日期篩選
            let selectedEndDateFilter = null;   // 新增結束日期篩選

            // 新增一個全局變數來追踪下一個交易的 ID
            let nextTradeId = 1;

            // 工具函數：格式化數字，每三位加上逗號，根據是否為金額決定是否顯示符號
            function formatNumber(value, isMoneyAmount = false, decimalPlaces = 2) {
                const number = parseFloat(value);
                if (isNaN(number)) return '0';
                
                if (isMoneyAmount) {
                    return number >= 0 ? 
                        `+${number.toLocaleString(undefined, {minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces})}` : 
                        `-${Math.abs(number).toLocaleString(undefined, {minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces})}`;
                }
                return number >= 0 ? 
                    `+${number.toLocaleString(undefined, {minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces})}` : 
                    `-${Math.abs(number).toLocaleString(undefined, {minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces})}`;
            }

            // 新增工具函數：格式化數字，不帶 "+" 符號，無小數點
            function formatNumberNoSign(value, decimalPlaces = 2) {
                const number = parseFloat(value);
                if (isNaN(number)) return '0';
                return number.toLocaleString(undefined, {minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces});
            }

            // 新增工具函數：格式化交易數，不帶 "+" 符號，無小數點
            function formatTradeCount(value) {
                const number = parseInt(value, 10);
                if (isNaN(number)) return '0';
                return number.toLocaleString();
            }

            // 保存數據到 localStorage
            function saveData() {
                localStorage.setItem('trades', JSON.stringify(trades));
                saveStrategies(); // 保存策略數據
                saveExternalConditions(); // 保存外部條件數據

                // 保存收合狀態
                saveCollapseState();
            }

            // 保存策略數據到 localStorage
            function saveStrategies() {
                localStorage.setItem('strategies', JSON.stringify(strategies));
            }

            // 保存外部條件數據到 localStorage
            function saveExternalConditions() {
                localStorage.setItem('externalConditions', JSON.stringify(externalConditions));
            }

            // 保存收合狀態到 localStorage
            function saveCollapseState() {
                const strategyCollapsed = document.getElementById('strategyManagementContent').classList.contains('hidden');
                const externalConditionCollapsed = document.getElementById('externalConditionManagementContent').classList.contains('hidden');
                localStorage.setItem('strategyManagementCollapsed', strategyCollapsed);
                localStorage.setItem('externalConditionManagementCollapsed', externalConditionCollapsed);
            }

            // 從 localStorage 加載策略數據
            function loadStrategies() {
                const savedStrategies = JSON.parse(localStorage.getItem('strategies'));
                if (savedStrategies && Array.isArray(savedStrategies)) {
                    strategies = savedStrategies;
                } else {
                    // 如果沒有保存的策略，初始化一個默認策略
                    strategies = [{ id: 1, name: '默認策略', description: '這是默認策略' }];
                    saveStrategies();
                }

                // 更新 nextTradeId 以避免ID衝突
                const maxStrategyId = strategies.reduce((max, strategy) => strategy.id > max ? strategy.id : max, 0);
                if (maxStrategyId >= nextTradeId) {
                    nextTradeId = maxStrategyId + 1;
                }
            }

            // 從 localStorage 加載外部條件數據
            function loadExternalConditions() {
                const savedExternalConditions = JSON.parse(localStorage.getItem('externalConditions'));
                if (savedExternalConditions && Array.isArray(savedExternalConditions)) {
                    externalConditions = savedExternalConditions;
                } else {
                    // 如果沒有保存的外部條件，初始化一個默認外部條件
                    externalConditions = [{ id: 1, name: '默認外部條件', description: '這是默認外部條件' }];
                    saveExternalConditions();
                }

                // 更新 nextTradeId 以避免ID衝突
                const maxConditionId = externalConditions.reduce((max, condition) => condition.id > max ? condition.id : max, 0);
                if (maxConditionId >= nextTradeId) {
                    nextTradeId = maxConditionId + 1;
                }
            }

            // 從 localStorage 加載交易數據和篩選條件
            function loadData() {
                const savedTrades = JSON.parse(localStorage.getItem('trades'));
                const strategyManagementCollapsed = localStorage.getItem('strategyManagementCollapsed') === 'true';
                const externalConditionManagementCollapsed = localStorage.getItem('externalConditionManagementCollapsed') === 'true';
                
                if (savedTrades && Array.isArray(savedTrades)) {
                    // 確保每個交易都有唯一的 ID 及 imageUrl、position
                    trades = savedTrades.map(trade => {
                        if (!trade.id) {
                            trade.id = nextTradeId++;
                        } else {
                            if (trade.id >= nextTradeId) {
                                nextTradeId = trade.id + 1;
                            }
                        }
                        // 確保 description, imageUrl, position 存在
                        if (!trade.description) trade.description = '';
                        if (!trade.imageUrl) trade.imageUrl = '';
                        if (typeof trade.position === 'undefined') trade.position = '';
                        return trade;
                    });
                }

                if (trades.length === 0) {
                    trades.push({ id: nextTradeId++, returnRate: '', position: '', assetName: '', strategyId: null, externalConditionId: null, openDate: '', closeDate: '', description: '', imageUrl: '' });
                }

                // 確保篩選器重置為默認狀態
                selectedStrategyFilter = null;
                selectedExternalConditionFilter = null;
                selectedStartDateFilter = null;
                selectedEndDateFilter = null;
                document.getElementById('strategyFilter').value = '';
                document.getElementById('externalConditionFilter').value = '';
                document.getElementById('startDateFilter').value = '';
                document.getElementById('endDateFilter').value = '';

                renderStrategies(); // 渲染策略列表
                renderExternalConditions(); // 渲染外部條件列表
                renderTrades();
                calculateStats();

                // 應用收合狀態
                applySavedCollapseState(strategyManagementCollapsed, externalConditionManagementCollapsed);
            }

            // 應用已保存的收合狀態
            function applySavedCollapseState(strategyCollapsed, externalConditionCollapsed) {
                if (strategyCollapsed) {
                    document.getElementById('strategyManagementContent').classList.add('hidden');
                    document.getElementById('strategyToggleIcon').setAttribute('data-lucide', 'chevron-right');
                    const strategyToggleButton = document.querySelector('#strategyToggleIcon').parentElement;
                    strategyToggleButton.innerHTML = `<i id="strategyToggleIcon" data-lucide="chevron-right" class="inline-block mr-2"></i>展開`;
                }

                if (externalConditionCollapsed) {
                    document.getElementById('externalConditionManagementContent').classList.add('hidden');
                    document.getElementById('externalConditionToggleIcon').setAttribute('data-lucide', 'chevron-right');
                    const externalConditionToggleButton = document.querySelector('#externalConditionToggleIcon').parentElement;
                    externalConditionToggleButton.innerHTML = `<i id="externalConditionToggleIcon" data-lucide="chevron-right" class="inline-block mr-2"></i>展開`;
                }

                lucide.createIcons(); // 重新初始化 Lucide 圖標
            }

            // 渲染策略列表
            function renderStrategies() {
                const strategiesList = document.getElementById('strategiesList');
                strategiesList.innerHTML = strategies.map(strategy => `
                    <tr>
                        <td class="border px-4 py-2 min-w-[150px]">${escapeHtml(strategy.name)}</td>
                        <td class="border px-4 py-2 min-w-[200px]">${escapeHtml(strategy.description)}</td>
                        <td class="border px-4 py-2 text-center">
                            <button onclick="openEditStrategyModal(${strategy.id})" class="mr-2">
                                <i data-lucide="edit"></i>
                            </button>
                            <button onclick="deleteStrategy(${strategy.id})" class="delete-button">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                renderStrategyFilter(); // 更新策略篩選下拉選單
                lucide.createIcons();
            }

            // 渲染策略篩選下拉選單
            function renderStrategyFilter() {
                const strategyFilter = document.getElementById('strategyFilter');
                strategyFilter.innerHTML = `
                    <option value="">全部策略</option>
                    ${strategies.map(strategy => `
                        <option value="${strategy.id}">${escapeHtml(strategy.name)}</option>
                    `).join('')}
                `;
            }

            // 渲染外部條件列表
            function renderExternalConditions() {
                const externalConditionsList = document.getElementById('externalConditionsList');
                externalConditionsList.innerHTML = externalConditions.map(condition => `
                    <tr>
                        <td class="border px-4 py-2 min-w-[150px]">${escapeHtml(condition.name)}</td>
                        <td class="border px-4 py-2 min-w-[200px]">${escapeHtml(condition.description)}</td>
                        <td class="border px-4 py-2 text-center">
                            <button onclick="openEditExternalConditionModal(${condition.id})" class="mr-2">
                                <i data-lucide="edit"></i>
                            </button>
                            <button onclick="deleteExternalCondition(${condition.id})" class="delete-button">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                renderExternalConditionFilter(); // 更新外部條件篩選下拉選單
                lucide.createIcons();
            }

            // 渲染外部條件篩選下拉選單
            function renderExternalConditionFilter() {
                const externalConditionFilter = document.getElementById('externalConditionFilter');
                externalConditionFilter.innerHTML = `
                    <option value="">全部外部條件</option>
                    ${externalConditions.map(condition => `
                        <option value="${condition.id}">${escapeHtml(condition.name)}</option>
                    `).join('')}
                `;
            }

            // 渲染交易記錄
            function renderTrades() {
                const tradesList = document.getElementById('tradesList');
                tradesList.innerHTML = '';

                // 根據篩選條件過濾交易紀錄
                let filteredTrades = trades;

                if (selectedStrategyFilter !== null) {
                    filteredTrades = filteredTrades.filter(trade => trade.strategyId === selectedStrategyFilter);
                }
                if (selectedExternalConditionFilter !== null) {
                    filteredTrades = filteredTrades.filter(trade => trade.externalConditionId === selectedExternalConditionFilter);
                }
                if (selectedStartDateFilter !== null && selectedStartDateFilter !== '') {
                    const startDate = new Date(selectedStartDateFilter);
                    filteredTrades = filteredTrades.filter(trade => trade.openDate && new Date(trade.openDate) >= startDate);
                }
                if (selectedEndDateFilter !== null && selectedEndDateFilter !== '') {
                    const endDate = new Date(selectedEndDateFilter);
                    filteredTrades = filteredTrades.filter(trade => trade.openDate && new Date(trade.openDate) <= endDate);
                }

                // 分配交易編號：僅對有開倉日的交易編號，根據開倉日升序
                const tradesWithOpenDate = filteredTrades.filter(trade => trade.openDate !== '');
                const sortedAscending = [...tradesWithOpenDate].sort((a, b) => new Date(a.openDate) - new Date(b.openDate));
                const transactionNumbers = new Map();
                sortedAscending.forEach((trade, index) => {
                    transactionNumbers.set(trade.id, index + 1);
                });

                // 將沒有開倉日的交易放在最頂端，排序有開倉日的交易為降序
                filteredTrades.sort((a, b) => {
                    if (a.openDate === '' && b.openDate === '') return 0;
                    if (a.openDate === '') return -1; // 無開倉日的交易排在最上方
                    if (b.openDate === '') return 1;  // 無開倉日的交易排在最上方
                    return new Date(b.openDate) - new Date(a.openDate); // 有開倉日的交易按降序排列
                });

                // 渲染排序後的交易紀錄
                tradesList.innerHTML = filteredTrades.map((trade, index) => {
                    const transactionNumber = trade.openDate !== '' ? transactionNumbers.get(trade.id) : '';
                    let holdingDays = '';
                    let holdingDaysClass = '';
                    if (trade.openDate !== '' && trade.closeDate !== '') {
                        const openDate = new Date(trade.openDate);
                        const closeDate = new Date(trade.closeDate);
                        const diffTime = closeDate - openDate;
                        holdingDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        if (holdingDays >= 0) {
                            holdingDays = holdingDays;
                        } else {
                            holdingDays = ''; // 錯誤的日期，不顯示
                        }
                    } else {
                        holdingDays = '未平倉';
                        holdingDaysClass = 'text-red-500'; // 使用紅色字體
                    }

                    // 生成策略選擇下拉選單
                    const strategyOptions = strategies.map(strategy => `
                        <option value="${strategy.id}" ${trade.strategyId === strategy.id ? 'selected' : ''}>${escapeHtml(strategy.name)}</option>
                    `).join('');

                    // 生成外部條件選擇下拉選單
                    const externalConditionOptions = externalConditions.map(condition => `
                        <option value="${condition.id}" ${trade.externalConditionId === condition.id ? 'selected' : ''}>${escapeHtml(condition.name)}</option>
                    `).join('');

                    return `
                        <tr>
                            <td class="border px-4 py-2 text-center min-w-[80px]">${transactionNumber}</td>
                            <td class="border px-4 py-2 min-w-[100px]">
                                <input
                                    type="date"
                                    value="${trade.openDate}"
                                    oninput="handleTradeChange(${trades.indexOf(trade)}, 'openDate', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="openDate"
                                >
                            </td>
                            <td class="border px-4 py-2 min-w-[100px]">
                                <input
                                    type="date"
                                    value="${trade.closeDate}"
                                    oninput="handleTradeChange(${trades.indexOf(trade)}, 'closeDate', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="closeDate"
                                >
                            </td>
                            <td class="border px-4 py-2 text-center ${holdingDaysClass} min-w-[100px]">
                                ${holdingDays}
                            </td>
                            <td class="border px-4 py-2 min-w-[100px]">
                                <input
                                    type="text"
                                    value="${trade.returnRate}"
                                    oninput="handleTradeChange(${trades.indexOf(trade)}, 'returnRate', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    placeholder="+6.66 或 -2.92"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="returnRate"
                                    data-trade-id="${trade.id}"
                                >
                            </td>
                            <td class="border px-4 py-2 min-w-[100px]">
                                <input
                                    type="number"
                                    value="${trade.position}"
                                    oninput="handleTradeChange(${trades.indexOf(trade)}, 'position', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    placeholder="部位金額"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="position"
                                >
                            </td>
                            <td class="border px-4 py-2 min-w-[150px]">
                                <input
                                    type="text"
                                    value="${escapeHtml(trade.assetName)}"
                                    oninput="handleTradeChange(${trades.indexOf(trade)}, 'assetName', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    placeholder="輸入標的名稱"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="assetName"
                                >
                            </td>
                            <td class="border px-4 py-2 min-w-[150px]">
                                <select
                                    onchange="handleTradeChange(${trades.indexOf(trade)}, 'strategyId', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="strategyId"
                                >
                                    <option value="">選擇策略</option>
                                    ${strategyOptions}
                                </select>
                            </td>
                            <td class="border px-4 py-2 min-w-[150px]">
                                <select
                                    onchange="handleTradeChange(${trades.indexOf(trade)}, 'externalConditionId', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="externalConditionId"
                                >
                                    <option value="">選擇外部條件</option>
                                    ${externalConditionOptions}
                                </select>
                            </td>
                            <td class="border px-4 py-2 min-w-[200px]">
                                <input
                                    type="text"
                                    value="${escapeHtml(trade.description)}"
                                    oninput="handleTradeChange(${trades.indexOf(trade)}, 'description', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    placeholder="輸入文字說明"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="description"
                                >
                            </td>
                            <td class="border px-4 py-2 min-w-[200px]">
                                <input
                                    type="text"
                                    value="${trade.imageUrl}"
                                    oninput="handleTradeChange(${trades.indexOf(trade)}, 'imageUrl', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    placeholder="輸入圖片URL"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="imageUrl"
                                >
                                ${trade.imageUrl ? `<button onclick="openImageLink('${encodeURIComponent(trade.imageUrl)}')" class="mt-2 button text-sm">查看圖片</button>` : ''}
                            </td>
                            <td class="border px-4 py-2 text-center min-w-[80px]">
                                ${trades.length > 1 ? `
                                    <button onclick="removeTrade(${trades.indexOf(trade)})" class="delete-button">
                                        <i data-lucide="trash-2"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // 重新初始化 Lucide 圖標
                lucide.createIcons();

                // 設置頂部滾動條內容的寬度與表格一致
                const topScrollbarContent = document.getElementById('topScrollbarContent');
                const bottomScrollbar = document.getElementById('bottomScrollbar');
                const table = bottomScrollbar.querySelector('table');
                if (table) {
                    topScrollbarContent.style.width = table.scrollWidth + 'px';
                }

                // 同步頂部和底部滾動條
                const topScrollbar = document.getElementById('topScrollbar');
                const bottomScrollDiv = document.getElementById('bottomScrollbar');

                // 解除先前的事件監聽器以防止重複綁定
                topScrollbar.removeEventListener('scroll', syncTopToBottom);
                bottomScrollDiv.removeEventListener('scroll', syncBottomToTop);

                // 定義同步函數
                function syncTopToBottom() {
                    bottomScrollDiv.scrollLeft = topScrollbar.scrollLeft;
                }

                function syncBottomToTop() {
                    topScrollbar.scrollLeft = bottomScrollDiv.scrollLeft;
                }

                // 添加事件監聽器
                topScrollbar.addEventListener('scroll', syncTopToBottom);
                bottomScrollDiv.addEventListener('scroll', syncBottomToTop);

                // 初始化同步
                topScrollbar.scrollLeft = bottomScrollDiv.scrollLeft;
            }

            // 獲取策略名稱
            function getStrategyName(strategyId) {
                const strategy = strategies.find(s => s.id === strategyId);
                return strategy ? strategy.name : '';
            }

            // 獲取外部條件名稱
            function getExternalConditionName(conditionId) {
                const condition = externalConditions.find(c => c.id === conditionId);
                return condition ? condition.name : '';
            }

            // 處理交易數據變更
            function handleTradeChange(index, field, value) {
                if (field === 'returnRate') {
                    const cleanedValue = value.replace('%', '').trim();
                    if (cleanedValue === '' || isNaN(cleanedValue)) {
                        trades[index].returnRate = '';
                    } else {
                        trades[index].returnRate = cleanedValue;
                    }
                } else if (field === 'assetName') {
                    trades[index].assetName = value.trim();
                } else if (field === 'strategyId') {
                    trades[index].strategyId = value === '' ? null : parseInt(value, 10);
                } else if (field === 'externalConditionId') {
                    trades[index].externalConditionId = value === '' ? null : parseInt(value, 10);
                } else if (field === 'openDate') {
                    trades[index].openDate = value;
                    // 驗證平倉日是否早於開倉日
                    const closeDate = trades[index].closeDate;
                    if (closeDate !== '' && new Date(closeDate) < new Date(value)) {
                        alert('平倉日不能早於開倉日。');
                        trades[index].closeDate = '';
                        document.querySelector(`input[data-row-index="${index}"][data-field="closeDate"]`).value = '';
                    }
                } else if (field === 'closeDate') {
                    trades[index].closeDate = value;
                    // 驗證平倉日是否早於開倉日
                    const openDate = trades[index].openDate;
                    if (openDate !== '' && new Date(value) < new Date(openDate)) {
                        alert('平倉日不能早於開倉日。');
                        trades[index].closeDate = '';
                        document.querySelector(`input[data-row-index="${index}"][data-field="closeDate"]`).value = '';
                    }
                } else if (field === 'description') { // 新增處理文字說明
                    trades[index].description = value.trim();
                } else if (field === 'imageUrl') { // 新增處理圖片URL
                    trades[index].imageUrl = value.trim();
                } else if (field === 'position') {
                    trades[index].position = value.trim();
                }
                
                // 計算統計數據和保存
                calculateStats();
                saveData(); // 保存數據
            }

            // 開啟圖片連結
            function openImageLink(url) {
                window.open(decodeURIComponent(url), '_blank');
            }

            // 添加交易記錄
            function addTrade() {
                if (strategies.length === 0) {
                    alert('請先新增至少一個交易策略。');
                    return;
                }
                if (externalConditions.length === 0) {
                    alert('請先新增至少一個外部條件。');
                    return;
                }

                // 創建新交易並分配唯一的 ID
                const newTrade = { 
                    id: nextTradeId++, 
                    returnRate: '', 
                    position: '',
                    assetName: '', 
                    strategyId: null, 
                    externalConditionId: null, 
                    openDate: '', 
                    closeDate: '',
                    description: '', // 新增文字說明欄位
                    imageUrl: '' // 新增圖片URL欄位
                };
                trades.unshift(newTrade); // 將新交易插入到陣列的最前端
                
                // 渲染交易記錄、計算統計數據並保存
                renderTrades();
                calculateStats();
                saveData(); // 保存數據

                // 聚焦到新添加的交易的報酬率輸入框
                setTimeout(() => {
                    const newInput = document.querySelector(`input[data-trade-id="${newTrade.id}"][data-field="returnRate"]`);
                    if (newInput) {
                        newInput.focus(); // 聚焦到新交易的報酬率欄位
                    }
                }, 100);
            }

            // 刪除交易記錄
            function removeTrade(index) {
                trades = trades.filter((_, i) => i !== index);
                if (trades.length === 0) {
                    trades.push({ id: nextTradeId++, returnRate: '', position: '', assetName: '', strategyId: null, externalConditionId: null, openDate: '', closeDate: '', description: '', imageUrl: '' });
                }
                renderTrades();
                calculateStats();
                saveData(); // 保存數據
            }

            // 開啟新增策略模態框
            function openAddStrategyModal() {
                openModal('addStrategyModal');
            }

            // 關閉新增策略模態框
            function closeAddStrategyModal() {
                closeModal('addStrategyModal');
            }

            // 新增策略
            function addStrategy() {
                const nameInput = document.getElementById('newStrategyName');
                const descriptionInput = document.getElementById('newStrategyDescription');
                const name = nameInput.value.trim();
                const description = descriptionInput.value.trim();

                if (name === '') {
                    alert('策略名稱不能為空。');
                    return;
                }

                // 檢查策略名稱是否已存在
                const existingStrategy = strategies.find(strategy => strategy.name === name);
                if (existingStrategy) {
                    alert('策略名稱已存在，請選擇其他名稱。');
                    return;
                }

                // 生成新的策略 ID
                const newId = strategies.length > 0 ? Math.max(...strategies.map(s => s.id)) + 1 : 1;

                // 新增策略
                strategies.push({ id: newId, name, description });
                saveStrategies();
                renderStrategies();
                renderTrades(); // 更新交易表格中的策略下拉選單
                calculateStats(); // 更新統計數據
                closeAddStrategyModal();
            }

            // 開啟編輯策略模態框
            function openEditStrategyModal(strategyId) {
                const strategy = strategies.find(s => s.id === strategyId);
                if (!strategy) return;

                document.getElementById('editStrategyId').value = strategy.id;
                document.getElementById('editStrategyName').value = strategy.name;
                document.getElementById('editStrategyDescription').value = strategy.description;
                openModal('editStrategyModal');
            }

            // 關閉編輯策略模態框
            function closeEditStrategyModal() {
                closeModal('editStrategyModal');
            }

            // 更新策略
            function updateStrategy() {
                const id = parseInt(document.getElementById('editStrategyId').value, 10);
                const name = document.getElementById('editStrategyName').value.trim();
                const description = document.getElementById('editStrategyDescription').value.trim();

                if (name === '') {
                    alert('策略名稱不能為空。');
                    return;
                }

                // 檢查策略名稱是否已存在（排除當前策略）
                const existingStrategy = strategies.find(strategy => strategy.name === name && strategy.id !== id);
                if (existingStrategy) {
                    alert('策略名稱已存在，請選擇其他名稱。');
                    return;
                }

                const strategyIndex = strategies.findIndex(s => s.id === id);
                if (strategyIndex === -1) return;

                // 更新策略
                strategies[strategyIndex].name = name;
                strategies[strategyIndex].description = description;
                saveStrategies();
                renderStrategies();
                renderTrades(); // 更新交易表格中的策略下拉選單
                calculateStats(); // 更新統計數據
                closeEditStrategyModal();
            }

            // 刪除策略
            function deleteStrategy(strategyId) {
                // 檢查是否有交易使用該策略
                const tradesUsingStrategy = trades.filter(trade => trade.strategyId === strategyId);
                if (tradesUsingStrategy.length > 0) {
                    alert('有交易紀錄正在使用此策略，請先移除或更改相關交易紀錄。');
                    return;
                }

                if (!confirm('您確定要刪除此策略嗎？此操作無法撤銷。')) {
                    return;
                }

                strategies = strategies.filter(strategy => strategy.id !== strategyId);
                saveStrategies();
                renderStrategies();
                renderTrades(); // 更新交易表格中的策略下拉選單
                calculateStats(); // 更新統計數據
            }

            // 開啟新增外部條件模態框
            function openAddExternalConditionModal() {
                openModal('addExternalConditionModal');
            }

            // 關閉新增外部條件模態框
            function closeAddExternalConditionModal() {
                closeModal('addExternalConditionModal');
            }

            // 新增外部條件
            function addExternalCondition() {
                const nameInput = document.getElementById('newExternalConditionName');
                const descriptionInput = document.getElementById('newExternalConditionDescription');
                const name = nameInput.value.trim();
                const description = descriptionInput.value.trim();

                if (name === '') {
                    alert('外部條件名稱不能為空。');
                    return;
                }

                // 檢查外部條件名稱是否已存在
                const existingCondition = externalConditions.find(condition => condition.name === name);
                if (existingCondition) {
                    alert('外部條件名稱已存在，請選擇其他名稱。');
                    return;
                }

                // 生成新的外部條件 ID
                const newId = externalConditions.length > 0 ? Math.max(...externalConditions.map(c => c.id)) + 1 : 1;

                // 新增外部條件
                externalConditions.push({ id: newId, name, description });
                saveExternalConditions();
                renderExternalConditions();
                renderTrades(); // 更新交易表格中的外部條件下拉選單
                calculateStats(); // 更新統計數據
                closeAddExternalConditionModal();
            }

            // 開啟編輯外部條件模態框
            function openEditExternalConditionModal(conditionId) {
                const condition = externalConditions.find(c => c.id === conditionId);
                if (!condition) return;

                document.getElementById('editExternalConditionId').value = condition.id;
                document.getElementById('editExternalConditionName').value = condition.name;
                document.getElementById('editExternalConditionDescription').value = condition.description;
                openModal('editExternalConditionModal');
            }

            // 關閉編輯外部條件模態框
            function closeEditExternalConditionModal() {
                closeModal('editExternalConditionModal');
            }

            // 更新外部條件
            function updateExternalCondition() {
                const id = parseInt(document.getElementById('editExternalConditionId').value, 10);
                const name = document.getElementById('editExternalConditionName').value.trim();
                const description = document.getElementById('editExternalConditionDescription').value.trim();

                if (name === '') {
                    alert('外部條件名稱不能為空。');
                    return;
                }

                // 檢查外部條件名稱是否已存在（排除當前外部條件）
                const existingCondition = externalConditions.find(condition => condition.name === name && condition.id !== id);
                if (existingCondition) {
                    alert('外部條件名稱已存在，請選擇其他名稱。');
                    return;
                }

                const conditionIndex = externalConditions.findIndex(c => c.id === id);
                if (conditionIndex === -1) return;

                // 更新外部條件
                externalConditions[conditionIndex].name = name;
                externalConditions[conditionIndex].description = description;
                saveExternalConditions();
                renderExternalConditions();
                renderTrades(); // 更新交易表格中的外部條件下拉選單
                calculateStats(); // 更新統計數據
                closeEditExternalConditionModal();
            }

            // 刪除外部條件
            function deleteExternalCondition(conditionId) {
                // 檢查是否有交易使用該外部條件
                const tradesUsingCondition = trades.filter(trade => trade.externalConditionId === conditionId);
                if (tradesUsingCondition.length > 0) {
                    alert('有交易紀錄正在使用此外部條件，請先移除或更改相關交易紀錄。');
                    return;
                }

                if (!confirm('您確定要刪除此外部條件嗎？此操作無法撤銷。')) {
                    return;
                }

                externalConditions = externalConditions.filter(condition => condition.id !== conditionId);
                saveExternalConditions();
                renderExternalConditions();
                renderTrades(); // 更新交易表格中的外部條件下拉選單
                calculateStats(); // 更新統計數據
            }

            // 策略、外部條件和日期篩選功能
            function applyFilters() {
                const strategyId = document.getElementById('strategyFilter').value;
                const externalConditionId = document.getElementById('externalConditionFilter').value;
                const startDate = document.getElementById('startDateFilter').value;
                const endDate = document.getElementById('endDateFilter').value;

                selectedStrategyFilter = strategyId === '' ? null : parseInt(strategyId, 10);
                selectedExternalConditionFilter = externalConditionId === '' ? null : parseInt(externalConditionId, 10);
                selectedStartDateFilter = startDate === '' ? null : startDate;
                selectedEndDateFilter = endDate === '' ? null : endDate;

                calculateStats();
                renderTrades();
            }

            // 清除日期篩選
            function clearDateFilters() {
                document.getElementById('startDateFilter').value = '';
                document.getElementById('endDateFilter').value = '';
                selectedStartDateFilter = null;
                selectedEndDateFilter = null;
                applyFilters();
            }

            // 新增：調整結束日期範圍的函數
            function shiftEndDate(days) {
                const endDateInput = document.getElementById('endDateFilter');

                let endDate = endDateInput.value ? new Date(endDateInput.value) : null;

                if (endDate) {
                    endDate.setDate(endDate.getDate() + days);
                    endDateInput.value = formatDate(endDate);
                } else {
                    alert('請先設定結束日期，再進行調整。');
                }

                applyFilters();
            }

            // 新增：格式化日期為 YYYY-MM-DD
            function formatDate(date) {
                return date.toISOString().split('T')[0];
            }

            // 計算統計數據
            function calculateStats() {
                let validTrades = trades.filter(trade => 
                    trade.returnRate !== '' && !isNaN(parseFloat(trade.returnRate))
                );

                if (selectedStrategyFilter !== null) {
                    validTrades = validTrades.filter(trade => trade.strategyId === selectedStrategyFilter);
                }
                if (selectedExternalConditionFilter !== null) {
                    validTrades = validTrades.filter(trade => trade.externalConditionId === selectedExternalConditionFilter);
                }
                if (selectedStartDateFilter !== null && selectedStartDateFilter !== '') {
                    const startDate = new Date(selectedStartDateFilter);
                    validTrades = validTrades.filter(trade => trade.openDate && new Date(trade.openDate) >= startDate);
                }
                if (selectedEndDateFilter !== null && selectedEndDateFilter !== '') {
                    const endDate = new Date(selectedEndDateFilter);
                    validTrades = validTrades.filter(trade => trade.openDate && new Date(trade.openDate) <= endDate);
                }

                if (validTrades.length === 0) {
                    // 重置統計數據
                    document.getElementById('totalTrades').textContent = '0';
                    document.getElementById('winRate').textContent = '0% (0勝0敗)';
                    document.getElementById('riskRewardRatio').textContent = '0';
                    document.getElementById('avgWin').textContent = '+0 (+0.00%)';
                    document.getElementById('avgLoss').textContent = '-0 (-0.00%)';
                    document.getElementById('maxWin').textContent = '+0 (+0.00%)';
                    document.getElementById('maxLoss').textContent = '-0 (-0.00%)';
                    document.getElementById('expectedValue').textContent = '0.0%';
                    document.getElementById('totalReturn').textContent = '0%';
                    
                    removeColorClasses(['expectedValue', 'totalReturn']);
                    
                    return;
                }

                const results = validTrades.map(trade => parseFloat(trade.returnRate));
                const wins = results.filter(result => result > 0);
                const losses = results.filter(result => result < 0);

                const winRate = (wins.length / results.length) * 100;
                const avgWinRate = wins.length > 0 ? wins.reduce((a, b) => a + b) / wins.length : 0;
                const avgLossRate = losses.length > 0 ? losses.reduce((a, b) => a + b) / losses.length : 0;
                const maxWinRate = wins.length > 0 ? Math.max(...wins) : 0;
                const maxLossRate = losses.length > 0 ? Math.min(...losses) : 0;
                const riskRewardRatio = avgLossRate !== 0 ? (avgWinRate / Math.abs(avgLossRate)) : 0;
                const expectedReturnRate = (winRate / 100 * avgWinRate) - ((100 - winRate) / 100 * Math.abs(avgLossRate));
                const totalReturnRate = results.reduce((sum, rate) => sum + rate, 0);

                // 根據交易中各自的部位金額計算實際獲利/虧損數值
                const tradesWithPosition = trades.filter(trade =>
                    trade.position !== '' && !isNaN(parseFloat(trade.position)) && parseFloat(trade.position) > 0 &&
                    trade.returnRate !== '' && !isNaN(parseFloat(trade.returnRate))
                );

                if (tradesWithPosition.length > 0) {
                    const totalInvested = tradesWithPosition.reduce((sum, trade) => sum + parseFloat(trade.position), 0);
                    const totalReturnAmount = tradesWithPosition.reduce((sum, trade) => {
                        return sum + (parseFloat(trade.returnRate) / 100 * parseFloat(trade.position));
                    }, 0);
                    const totalReturnPercentage = totalInvested > 0 ? (totalReturnAmount / totalInvested) * 100 : 0;

                    const winsWithPosition = tradesWithPosition.filter(trade => parseFloat(trade.returnRate) > 0);
                    const lossesWithPosition = tradesWithPosition.filter(trade => parseFloat(trade.returnRate) < 0);

                    const avgWinAmount = winsWithPosition.length > 0 ? winsWithPosition.reduce((sum, trade) => {
                        return sum + (parseFloat(trade.returnRate) / 100 * parseFloat(trade.position));
                    }, 0) / winsWithPosition.length : 0;
                    const avgLossAmount = lossesWithPosition.length > 0 ? lossesWithPosition.reduce((sum, trade) => {
                        return sum + (parseFloat(trade.returnRate) / 100 * parseFloat(trade.position));
                    }, 0) / lossesWithPosition.length : 0;
                    const maxWinAmount = winsWithPosition.length > 0 ? Math.max(...winsWithPosition.map(trade => (parseFloat(trade.returnRate) / 100 * parseFloat(trade.position)))) : 0;
                    const maxLossAmount = lossesWithPosition.length > 0 ? Math.min(...lossesWithPosition.map(trade => (parseFloat(trade.returnRate) / 100 * parseFloat(trade.position)))) : 0;

                    const averagePositionWeighted = totalInvested / tradesWithPosition.length;
                    const expectedValueAmount = (expectedReturnRate / 100) * averagePositionWeighted;

                    document.getElementById('avgWin').textContent = `${formatNumber(avgWinAmount, true, 0)} (${formatNumber(avgWinRate, false, 2)}%)`;
                    document.getElementById('avgLoss').textContent = `${formatNumber(avgLossAmount, true, 0)} (${formatNumber(avgLossRate, false, 2)}%)`;
                    document.getElementById('maxWin').textContent = `${formatNumber(maxWinAmount, true, 0)} (${formatNumber(maxWinRate, false, 2)}%)`;
                    document.getElementById('maxLoss').textContent = `${formatNumber(maxLossAmount, true, 0)} (${formatNumber(maxLossRate, false, 2)}%)`;
                    document.getElementById('expectedValue').textContent = `${formatNumber(expectedValueAmount.toFixed(1), true, 1)} (${formatNumber(expectedReturnRate.toFixed(2), false, 2)}%)`;
                    document.getElementById('totalReturn').textContent = `${formatNumber(totalReturnAmount, true, 0)} (${formatNumber(totalReturnPercentage, false, 2)}%)`;
                } else {
                    document.getElementById('avgWin').textContent = `(${formatNumber(avgWinRate, false, 2)}%)`;
                    document.getElementById('avgLoss').textContent = `(${formatNumber(avgLossRate, false, 2)}%)`;
                    document.getElementById('maxWin').textContent = `(${formatNumber(maxWinRate, false, 2)}%)`;
                    document.getElementById('maxLoss').textContent = `(${formatNumber(maxLossRate, false, 2)}%)`;
                    document.getElementById('expectedValue').textContent = `(${formatNumber(expectedReturnRate.toFixed(2), false, 2)}%)`;
                    document.getElementById('totalReturn').textContent = `(${formatNumber(totalReturnRate, false, 2)}%)`;
                }

                document.getElementById('totalTrades').textContent = formatTradeCount(results.length);
                document.getElementById('winRate').textContent = `${formatNumber(winRate.toFixed(2))}% (${wins.length}勝${losses.length}敗)`;
                document.getElementById('riskRewardRatio').textContent = formatNumberNoSign(riskRewardRatio.toFixed(2));

                // 更新顏色
                const expectedValueElem = document.getElementById('expectedValue');
                if (expectedReturnRate > 0) {
                    expectedValueElem.classList.add('text-red-500');
                    expectedValueElem.classList.remove('text-green-500');
                } else if (expectedReturnRate < 0) {
                    expectedValueElem.classList.add('text-green-500');
                    expectedValueElem.classList.remove('text-red-500');
                } else {
                    expectedValueElem.classList.remove('text-red-500', 'text-green-500');
                }

                const totalReturnElem = document.getElementById('totalReturn');
                if (totalReturnRate > 0) {
                    totalReturnElem.classList.add('text-red-500');
                    totalReturnElem.classList.remove('text-green-500');
                } else if (totalReturnRate < 0) {
                    totalReturnElem.classList.add('text-green-500');
                    totalReturnElem.classList.remove('text-red-500');
                } else {
                    totalReturnElem.classList.remove('text-red-500', 'text-green-500');
                }
            }

            // 移除特定元素的顏色類別
            function removeColorClasses(elementIds) {
                elementIds.forEach(id => {
                    const elem = document.getElementById(id);
                    elem.classList.remove('text-red-500', 'text-green-500');
                });
            }

            // 初始化
            loadStrategies();
            loadExternalConditions();
            loadData(); // 載入數據

            // 收合/展開 策略管理區塊
            function toggleStrategyManagement() {
                const content = document.getElementById('strategyManagementContent');
                const toggleIcon = document.getElementById('strategyToggleIcon');
                const toggleButton = toggleIcon.parentElement;

                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    toggleIcon.setAttribute('data-lucide', 'chevron-down');
                    toggleButton.innerHTML = `<i id="strategyToggleIcon" data-lucide="chevron-down" class="inline-block mr-2"></i>收合`;
                } else {
                    content.classList.add('hidden');
                    toggleIcon.setAttribute('data-lucide', 'chevron-right');
                    toggleButton.innerHTML = `<i id="strategyToggleIcon" data-lucide="chevron-right" class="inline-block mr-2"></i>展開`;
                }

                lucide.createIcons(); // 重新初始化 Lucide 圖標
                saveCollapseState(); // 保存收合狀態
            }

            // 收合/展開 外部條件管理區塊
            function toggleExternalConditionManagement() {
                const content = document.getElementById('externalConditionManagementContent');
                const toggleIcon = document.getElementById('externalConditionToggleIcon');
                const toggleButton = toggleIcon.parentElement;

                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    toggleIcon.setAttribute('data-lucide', 'chevron-down');
                    toggleButton.innerHTML = `<i id="externalConditionToggleIcon" data-lucide="chevron-down" class="inline-block mr-2"></i>收合`;
                } else {
                    content.classList.add('hidden');
                    toggleIcon.setAttribute('data-lucide', 'chevron-right');
                    toggleButton.innerHTML = `<i id="externalConditionToggleIcon" data-lucide="chevron-right" class="inline-block mr-2"></i>展開`;
                }

                lucide.createIcons(); // 重新初始化 Lucide 圖標
                saveCollapseState(); // 保存收合狀態
            }

            // 開啟模態框
            function openModal(modalId) {
                document.getElementById(modalId).classList.remove('hidden');
            }

            // 關閉模態框
            function closeModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.add('hidden');
                // 清空輸入欄位
                const inputs = modal.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (input.type !== 'hidden') {
                        input.value = '';
                    }
                });
            }

            // 安全地顯示用戶輸入的內容，防止 XSS 攻擊
            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
            }

            /**
             * 新增功能：將交易紀錄匯出為Excel
             */
            function exportToExcel() {
                if (trades.length === 0) {
                    alert('目前沒有交易紀錄可供匯出。');
                    return;
                }

                // 準備要匯出的數據
                const exportData = trades.map(trade => ({
                    "交易ID": trade.id,
                    "報酬率 (%)": trade.returnRate,
                    "部位金額": trade.position,
                    "標的名稱": trade.assetName,
                    "策略名稱": getStrategyName(trade.strategyId),
                    "外部條件": getExternalConditionName(trade.externalConditionId),
                    "開倉日": trade.openDate,
                    "平倉日": trade.closeDate,
                    "持倉天數": calculateHoldingDays(trade.openDate, trade.closeDate),
                    "文字說明": trade.description,
                    "圖片URL": trade.imageUrl
                }));

                // 使用 SheetJS 將JSON轉換為工作表
                const worksheet = XLSX.utils.json_to_sheet(exportData);

                // 創建一個新的工作簿並將工作表添加到其中
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "交易紀錄");

                // 生成Excel文件並觸發下載
                const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/octet-stream' });

                // 生成下載鏈接
                const link = document.createElement('a');
                const today = new Date().toISOString().split('T')[0];
                link.href = URL.createObjectURL(blob);
                link.download = `交易紀錄_${today}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // 計算持倉天數
            function calculateHoldingDays(openDate, closeDate) {
                if (openDate === '' && closeDate === '') return '';
                if (openDate === '' || closeDate === '') return '未平倉';
                const open = new Date(openDate);
                const close = new Date(closeDate);
                const diffTime = close - open;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                return diffDays >= 0 ? diffDays : '';
            }

            /**
             * 新增功能：將Excel匯入至交易紀錄
             */
            function importFromExcel(event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = e.target.result;
                    let workbook;
                    try {
                        workbook = XLSX.read(data, { type: 'binary' });
                    } catch (error) {
                        alert('無法解析該文件。請確認文件為有效的Excel格式。');
                        return;
                    }

                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

                    if (jsonData.length === 0) {
                        alert('Excel文件中沒有任何數據。');
                        return;
                    }

                    // 定義必要的欄位
                    const requiredFields = ["交易ID", "報酬率 (%)", "部位金額", "標的名稱", "策略名稱", "外部條件", "開倉日", "平倉日", "持倉天數", "文字說明", "圖片URL"];

                    // 檢查是否包含所有必要欄位
                    const missingFields = requiredFields.filter(field => !(field in jsonData[0]));
                    if (missingFields.length > 0) {
                        alert(`缺少以下必要欄位：${missingFields.join(', ')}`);
                        return;
                    }

                    // 轉換JSON數據為交易紀錄
                    const importedTrades = jsonData.map(item => {
                        // 轉換策略名稱和外部條件名稱為ID
                        const strategy = strategies.find(s => s.name === item["策略名稱"]);
                        const externalCondition = externalConditions.find(c => c.name === item["外部條件"]);

                        // 如果策略或外部條件不存在，提示並跳過此條目
                        if (!strategy) {
                            alert(`策略名稱 "${item["策略名稱"]}" 不存在。請先新增該策略後再匯入。`);
                            return null;
                        }
                        if (!externalCondition) {
                            alert(`外部條件名稱 "${item["外部條件"]}" 不存在。請先新增該外部條件後再匯入。`);
                            return null;
                        }

                        // 生成新的交易ID，確保唯一
                        const newTradeId = nextTradeId++;

                        // 計算持倉天數（可選）
                        let holdingDays = item["持倉天數"];
                        if (holdingDays === '' || holdingDays === '未平倉') {
                            holdingDays = '未平倉';
                        }

                        return {
                            id: newTradeId,
                            returnRate: item["報酬率 (%)"],
                            position: item["部位金額"],
                            assetName: item["標的名稱"],
                            strategyId: strategy.id,
                            externalConditionId: externalCondition.id,
                            openDate: item["開倉日"],
                            closeDate: item["平倉日"],
                            description: item["文字說明"],
                            imageUrl: item["圖片URL"]
                        };
                    }).filter(trade => trade !== null);

                    if (importedTrades.length === 0) {
                        alert('沒有有效的交易紀錄被匯入。');
                        return;
                    }

                    // 將匯入的交易紀錄添加到現有的交易紀錄中
                    trades = trades.concat(importedTrades);

                    // 渲染交易紀錄、計算統計數據並保存
                    renderTrades();
                    calculateStats();
                    saveData();

                    alert(`成功匯入 ${importedTrades.length} 筆交易紀錄。`);

                    // 重置文件輸入元素
                    document.getElementById('importExcelInput').value = '';
                };

                reader.onerror = function() {
                    alert('讀取文件時發生錯誤。');
                };

                reader.readAsBinaryString(file);
            }

            /**
             * 新增功能：將策略匯出為Excel
             */
            function exportStrategiesToExcel() {
                if (strategies.length === 0) {
                    alert('目前沒有策略資料可供匯出。');
                    return;
                }

                // 準備要匯出的數據
                const exportData = strategies.map(strategy => ({
                    "策略ID": strategy.id,
                    "策略名稱": strategy.name,
                    "描述": strategy.description
                }));

                // 使用 SheetJS 將JSON轉換為工作表
                const worksheet = XLSX.utils.json_to_sheet(exportData);

                // 創建一個新的工作簿並將工作表添加到其中
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "策略管理");

                // 生成Excel文件並觸發下載
                const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/octet-stream' });

                // 生成下載鏈接
                const link = document.createElement('a');
                const today = new Date().toISOString().split('T')[0];
                link.href = URL.createObjectURL(blob);
                link.download = `策略管理_${today}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            /**
             * 新增功能：將策略匯入自Excel
             */
            function importStrategiesFromExcel(event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = e.target.result;
                    let workbook;
                    try {
                        workbook = XLSX.read(data, { type: 'binary' });
                    } catch (error) {
                        alert('無法解析該文件。請確認文件為有效的Excel格式。');
                        return;
                    }

                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

                    if (jsonData.length === 0) {
                        alert('Excel文件中沒有任何數據。');
                        return;
                    }

                    // 定義必要的欄位
                    const requiredFields = ["策略ID", "策略名稱", "描述"];

                    // 檢查是否包含所有必要欄位
                    const missingFields = requiredFields.filter(field => !(field in jsonData[0]));
                    if (missingFields.length > 0) {
                        alert(`缺少以下必要欄位：${missingFields.join(', ')}`);
                        return;
                    }

                    // 轉換JSON數據為策略紀錄
                    const importedStrategies = jsonData.map(item => {
                        const name = item["策略名稱"].trim();
                        const description = item["描述"].trim();

                        // 檢查策略名稱是否已存在
                        const existingStrategy = strategies.find(s => s.name === name);
                        if (existingStrategy) {
                            alert(`策略名稱 "${name}" 已存在。請避免重複新增。`);
                            return null;
                        }

                        // 生成新的策略ID，確保唯一
                        const newStrategyId = nextTradeId++;

                        return {
                            id: newStrategyId,
                            name: name,
                            description: description
                        };
                    }).filter(strategy => strategy !== null);

                    if (importedStrategies.length === 0) {
                        alert('沒有有效的策略紀錄被匯入。');
                        return;
                    }

                    // 將匯入的策略紀錄添加到現有的策略中
                    strategies = strategies.concat(importedStrategies);

                    // 渲染策略列表、更新篩選選單並保存
                    renderStrategies();
                    renderTrades(); // 更新交易表格中的策略下拉選單
                    calculateStats();
                    saveStrategies();
                    saveData();

                    alert(`成功匯入 ${importedStrategies.length} 筆策略紀錄。`);

                    // 重置文件輸入元素
                    document.getElementById('importStrategiesInput').value = '';
                };

                reader.onerror = function() {
                    alert('讀取文件時發生錯誤。');
                };

                reader.readAsBinaryString(file);
            }

            /**
             * 新增功能：將外部條件匯出為Excel
             */
            function exportExternalConditionsToExcel() {
                if (externalConditions.length === 0) {
                    alert('目前沒有外部條件資料可供匯出。');
                    return;
                }

                // 準備要匯出的數據
                const exportData = externalConditions.map(condition => ({
                    "外部條件ID": condition.id,
                    "外部條件名稱": condition.name,
                    "描述": condition.description
                }));

                // 使用 SheetJS 將JSON轉換為工作表
                const worksheet = XLSX.utils.json_to_sheet(exportData);

                // 創建一個新的工作簿並將工作表添加到其中
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "外部條件管理");

                // 生成Excel文件並觸發下載
                const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/octet-stream' });

                // 生成下載鏈接
                const link = document.createElement('a');
                const today = new Date().toISOString().split('T')[0];
                link.href = URL.createObjectURL(blob);
                link.download = `外部條件管理_${today}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            /**
             * 新增功能：將外部條件匯入自Excel
             */
            function importExternalConditionsFromExcel(event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = e.target.result;
                    let workbook;
                    try {
                        workbook = XLSX.read(data, { type: 'binary' });
                    } catch (error) {
                        alert('無法解析該文件。請確認文件為有效的Excel格式。');
                        return;
                    }

                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

                    if (jsonData.length === 0) {
                        alert('Excel文件中沒有任何數據。');
                        return;
                    }

                    // 定義必要的欄位
                    const requiredFields = ["外部條件ID", "外部條件名稱", "描述"];

                    // 檢查是否包含所有必要欄位
                    const missingFields = requiredFields.filter(field => !(field in jsonData[0]));
                    if (missingFields.length > 0) {
                        alert(`缺少以下必要欄位：${missingFields.join(', ')}`);
                        return;
                    }

                    // 轉換JSON數據為外部條件紀錄
                    const importedExternalConditions = jsonData.map(item => {
                        const name = item["外部條件名稱"].trim();
                        const description = item["描述"].trim();

                        // 檢查外部條件名稱是否已存在
                        const existingCondition = externalConditions.find(c => c.name === name);
                        if (existingCondition) {
                            alert(`外部條件名稱 "${name}" 已存在。請避免重複新增。`);
                            return null;
                        }

                        // 生成新的外部條件ID，確保唯一
                        const newConditionId = nextTradeId++;

                        return {
                            id: newConditionId,
                            name: name,
                            description: description
                        };
                    }).filter(condition => condition !== null);

                    if (importedExternalConditions.length === 0) {
                        alert('沒有有效的外部條件紀錄被匯入。');
                        return;
                    }

                    // 將匯入的外部條件紀錄添加到現有的外部條件中
                    externalConditions = externalConditions.concat(importedExternalConditions);

                    // 渲染外部條件列表、更新篩選選單並保存
                    renderExternalConditions();
                    renderTrades(); // 更新交易表格中的外部條件下拉選單
                    calculateStats();
                    saveExternalConditions();
                    saveData();

                    alert(`成功匯入 ${importedExternalConditions.length} 筆外部條件紀錄。`);

                    // 重置文件輸入元素
                    document.getElementById('importExternalConditionsInput').value = '';
                };

                reader.onerror = function() {
                    alert('讀取文件時發生錯誤。');
                };

                reader.readAsBinaryString(file);
            }

        </script>
    </div>
</body>
</html>
