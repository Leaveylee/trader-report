<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>交易員報告書</title>
  
  <!-- PWA 相關設定 -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFE4D6">
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="交易員報告書">

  <!-- 引入 Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入 Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- 引入 SheetJS (xlsx) CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Noto Sans TC', sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #FFF3E6 0%, #FFE4D6 100%);
      padding: 20px;
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      padding: 2rem;
      width: 90%;
      max-width: 1200px;
      margin: 0 auto;
      box-shadow: 0 8px 32px rgba(184, 134, 113, 0.1);
    }
    input, select, textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid rgba(184, 110, 82, 0.2);
      border-radius: 8px;
      background: white;
      color: #444;
      transition: all 0.3s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #B86E52;
      box-shadow: 0 0 0 2px rgba(184, 110, 82, 0.1);
    }
    .button {
      background: linear-gradient(135deg, #E67E51 0%, #F1945E 100%);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(230, 126, 81, 0.2);
    }
    .delete-button {
      color: #dc2626;
      background: none;
      border: none;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .delete-button:hover {
      color: #b91c1c;
    }
    .divider {
      border-bottom: 1px solid #e5e7eb;
      margin: 0.5rem 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      white-space: normal;
      word-break: break-word;
    }
    th {
      background-color: #f9fafb;
      font-weight: 600;
    }
    .modal {
      display: flex;
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    .hidden {
      display: none;
    }
    .scrollbar-top {
      height: 16px;
      margin-bottom: 8px;
    }
    #topScrollbarContent {
      height: 1px;
    }
    #topScrollbarContent::after {
      content: "";
      display: block;
      width: 100%;
      height: 1px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1 class="text-2xl font-bold text-center mb-8 text-[#B86E52]">交易員報告書</h1>

    <!-- 篩選條件 -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-2">篩選條件</label>
      <div class="flex space-x-4 flex-wrap">
        <div class="flex-1 min-w-[200px]">
          <label for="strategyFilter" class="block text-sm font-medium text-gray-700 mb-1">篩選策略</label>
          <select id="strategyFilter" class="w-full p-2 border rounded" onchange="applyFilters()">
            <option value="">全部策略</option>
          </select>
        </div>
        <div class="flex-1 min-w-[200px]">
          <label for="externalConditionFilter" class="block text-sm font-medium text-gray-700 mb-1">篩選外部條件</label>
          <select id="externalConditionFilter" class="w-full p-2 border rounded" onchange="applyFilters()">
            <option value="">全部外部條件</option>
          </select>
        </div>
        <div class="flex-1 min-w-[200px]">
          <label for="directionFilter" class="block text-sm font-medium text-gray-700 mb-1">篩選交易方向</label>
          <select id="directionFilter" class="w-full p-2 border rounded" onchange="applyFilters()">
            <option value="">全部方向</option>
            <option value="多">多</option>
            <option value="空">空</option>
          </select>
        </div>
        <div class="flex-1 min-w-[300px]">
          <label class="block text-sm font-medium text-gray-700 mb-1">篩選日期範圍</label>
          <div class="flex space-x-2">
            <input type="date" id="startDateFilter" class="w-1/2 p-2 border rounded" onchange="applyFilters()" placeholder="開始日期">
            <input type="date" id="endDateFilter" class="w-1/2 p-2 border rounded" onchange="applyFilters()" placeholder="結束日期">
          </div>
          <div class="flex space-x-2 mt-2">
            <button class="button" onclick="shiftEndDate(-1)">前一天</button>
            <button class="button" onclick="shiftEndDate(1)">後一天</button>
            <button class="button" onclick="clearDateFilters()">清除日期篩選</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 初始資金及最新資金水位 -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-2" for="totalOperatingCapital">初始資金</label>
      <div class="flex items-center space-x-4">
        <input type="number" id="totalOperatingCapital" class="w-full p-2 border rounded" placeholder="請輸入初始資金" oninput="calculateStats(); saveTotalOperatingCapital()" onchange="calculateStats(); saveTotalOperatingCapital()">
        <span id="currentCapitalDisplay" class="font-bold text-lg text-blue-500">最新資金水位：$0</span>
      </div>
      <div class="text-sm text-gray-500 mt-1">初始資金作為期初資金，後續每筆閉倉交易盈虧會累計更新最新資金水位。</div>
    </div>

    <!-- 分析結果區塊 (不涉及交易方向) -->
    <div class="bg-gray-50 p-4 rounded mb-6">
      <h2 class="text-lg font-medium text-gray-700 mb-4">分析結果</h2>
      <div class="space-y-4">
        <!-- 上半部：交易數、勝率、風報比 -->
        <div class="flex justify-between font-bold text-lg">
          <div class="flex-1 text-center">
            <span class="text-gray-600">交易數：</span>
            <span id="totalTrades" class="font-medium">0</span>
          </div>
          <div class="flex-1 text-center">
            <span class="text-gray-600">勝率：</span>
            <span id="winRate" class="font-medium">0% (0勝0敗)</span>
          </div>
          <div class="flex-1 text-center">
            <span class="text-gray-600">風報比：</span>
            <span id="riskRewardRatio" class="font-medium">0</span>
          </div>
        </div>
        <!-- 新增獲利達成率 -->
        <div class="flex justify-between font-bold text-lg mt-2">
          <div class="flex-1 text-center">
            <span class="text-gray-600">獲利達成率：</span>
            <span id="profitAchievementRate" class="font-medium">0%</span>
          </div>
        </div>
        <!-- 期望值、總報酬、MDD -->
        <div class="flex justify-between font-bold text-lg mt-2">
          <div class="flex-1 text-center">
            <span class="text-gray-700">期望值：</span>
            <span id="expectedValue" class="font-bold text-lg">0</span>
          </div>
        </div>
        <div class="flex justify-between font-bold text-lg mt-2">
          <div class="flex-1 text-center">
            <span class="text-gray-700">總報酬：</span>
            <span id="totalReturn" class="font-bold text-lg">0</span>
          </div>
        </div>
        <div class="flex justify-between font-bold text-lg mt-2">
          <div class="flex-1 text-center">
            <span class="text-gray-700">最大交易回落 (MDD)：</span>
            <span id="maxDrawdown" class="font-bold text-lg">0%</span>
          </div>
        </div>
        <!-- MFE 與 MAE 統計 -->
        <div class="grid grid-cols-2 gap-4 mt-4">
          <div class="border p-4 rounded">
            <h4 class="text-lg font-medium text-gray-700 mb-2">MFE 統計</h4>
            <div class="flex justify-between">
              <span>平均 MFE:</span>
              <span id="avgMFE" class="font-bold">0%</span>
            </div>
            <div class="flex justify-between">
              <span>MFE SD:</span>
              <span id="sdMFE" class="font-bold">0%</span>
            </div>
            <div class="flex justify-between">
              <span>MFE CV:</span>
              <span id="cvMFE" class="font-bold">0</span>
            </div>
            <div class="flex justify-between">
              <span>MFE 偏度:</span>
              <span id="skewMFE" class="font-bold">0</span>
            </div>
            <div class="flex justify-between">
              <span>MFE 峰度:</span>
              <span id="kurtosisMFE" class="font-bold">0</span>
            </div>
          </div>
          <div class="border p-4 rounded">
            <h4 class="text-lg font-medium text-gray-700 mb-2">MAE 統計</h4>
            <div class="flex justify-between">
              <span>平均 MAE:</span>
              <span id="avgMAE" class="font-bold">0%</span>
            </div>
            <div class="flex justify-between">
              <span>MAE SD:</span>
              <span id="sdMAE" class="font-bold">0%</span>
            </div>
            <div class="flex justify-between">
              <span>MAE CV:</span>
              <span id="cvMAE" class="font-bold">0</span>
            </div>
            <div class="flex justify-between">
              <span>MAE 偏度:</span>
              <span id="skewMAE" class="font-bold">0</span>
            </div>
            <div class="flex justify-between">
              <span>MAE 峰度:</span>
              <span id="kurtosisMAE" class="font-bold">0</span>
            </div>
          </div>
        </div>
      </div>
      <!-- 在分析結果下方新增：各種策略的使用次數 -->
      <div class="mt-4">
        <h3 class="text-md font-medium text-gray-700 mb-2">各種策略的使用次數</h3>
        <ul id="strategyUsageList" class="list-disc pl-5">
          <!-- 策略使用次數將在此動態生成 -->
        </ul>
      </div>
    </div>

    <!-- 損益統計區塊 -->
    <div class="bg-gray-50 p-4 rounded mb-6">
      <h3 class="text-md font-medium text-gray-700 mb-3">損益統計</h3>
      <!-- 分成兩組：金額統計與百分比統計 -->
      <div class="grid grid-cols-2 gap-4">
        <!-- 金額統計：獲利與虧損 -->
        <div class="border p-4 rounded">
          <h4 class="text-lg font-medium text-gray-700 mb-2">獲利</h4>
          <div class="flex justify-between">
            <span class="text-gray-600">平均獲利：</span>
            <span id="avgWin" class="font-medium">0</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">最大獲利：</span>
            <span id="maxWin" class="font-medium">0</span>
          </div>
        </div>
        <div class="border p-4 rounded">
          <h4 class="text-lg font-medium text-gray-700 mb-2">虧損</h4>
          <div class="flex justify-between">
            <span class="text-gray-600">平均虧損：</span>
            <span id="avgLoss" class="font-medium">0</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">最大虧損：</span>
            <span id="maxLoss" class="font-medium">0</span>
          </div>
        </div>
      </div>
      <div class="col-span-2 divider mt-4"></div>
      <div class="grid grid-cols-2 gap-4 mt-4">
        <!-- 百分比統計 -->
        <div class="border p-4 rounded">
          <h4 class="text-lg font-medium text-gray-700 mb-2">獲利百分比統計</h4>
          <div class="flex justify-between">
            <span class="text-gray-600">平均獲利%：</span>
            <span id="avgWinPercent" class="font-medium">0%</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">獲利% SD：</span>
            <span id="sdWinPercent" class="font-medium">0%</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">獲利% CV：</span>
            <span id="cvWinPercent" class="font-medium">0</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">獲利% 偏度：</span>
            <span id="skewWinPercent" class="font-medium">0</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">獲利% 峰度：</span>
            <span id="kurtosisWinPercent" class="font-medium">0</span>
          </div>
        </div>
        <div class="border p-4 rounded">
          <h4 class="text-lg font-medium text-gray-700 mb-2">虧損百分比統計</h4>
          <div class="flex justify-between">
            <span class="text-gray-600">平均虧損%：</span>
            <span id="avgLossPercentDisplay" class="font-medium">0%</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">虧損% SD：</span>
            <span id="sdLossPercent" class="font-medium">0%</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">虧損% CV：</span>
            <span id="cvLossPercent" class="font-medium">0</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">虧損% 偏度：</span>
            <span id="skewLossPercent" class="font-medium">0</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">虧損% 峰度：</span>
            <span id="kurtosisLossPercent" class="font-medium">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 部位統計區塊 -->
    <div id="positionStats" class="bg-gray-50 p-4 rounded mb-6">
      <h2 class="text-lg font-medium text-gray-700 mb-4">部位統計</h2>
      <div class="grid grid-cols-2 gap-4">
        <div class="flex justify-between">
          <span class="text-gray-600">獲利交易的平均部位：</span>
          <span id="avgWinningPosition" class="font-medium">0</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">虧損交易的平均部位：</span>
          <span id="avgLosingPosition" class="font-medium">0</span>
        </div>
      </div>
    </div>

    <!-- 未平倉統計區塊 -->
    <div id="unclosedStats" class="bg-gray-50 p-4 rounded mb-6">
      <h2 class="text-lg font-medium text-gray-700 mb-4">未平倉統計</h2>
      <div class="grid grid-cols-2 gap-4">
        <div class="flex justify-between">
          <span class="text-gray-600">未平倉交易數量：</span>
          <span id="unclosedTradeCount" class="font-medium">0</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">未平倉部位總額：</span>
          <span id="unclosedPositionTotal" class="font-medium">$0</span>
        </div>
      </div>
    </div>

    <!-- 資金績效統計區塊 -->
    <div id="capitalStats" class="bg-gray-50 p-4 rounded mb-6">
      <h2 class="text-lg font-medium text-gray-700 mb-4">資金績效統計</h2>
      <div class="grid grid-cols-2 gap-4">
        <div class="flex justify-between">
          <span class="text-gray-600">總資金回報率 (ROI)：</span>
          <span id="roi" class="font-medium">0</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">自由資金：</span>
          <span id="freeCapital" class="font-medium">$0</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">占用資金：</span>
          <span id="capitalUsed" class="font-medium">$0</span>
        </div>
      </div>
    </div>

    <!-- 策略管理區塊 -->
    <div class="mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-medium text-gray-700">策略管理</h2>
        <div class="flex space-x-2">
          <button class="button" onclick="toggleStrategyManagement()">
            <i id="strategyToggleIcon" data-lucide="chevron-down" class="inline-block mr-2"></i>
            收合
          </button>
          <button class="button" onclick="openAddStrategyModal()">新增</button>
          <button class="button" onclick="exportStrategiesToExcel()">匯出</button>
          <button class="button" onclick="document.getElementById('importStrategiesInput').click()">匯入</button>
          <input type="file" id="importStrategiesInput" accept=".xlsx, .xls" class="hidden" onchange="importStrategiesFromExcel(event)">
        </div>
      </div>
      <div id="strategyManagementContent" class="overflow-x-auto">
        <table class="min-w-full bg-white rounded">
          <thead>
            <tr>
              <th class="px-4 py-2 min-w-[150px]">策略名稱</th>
              <th class="px-4 py-2 min-w-[200px]">描述</th>
              <th class="px-4 py-2">操作</th>
            </tr>
          </thead>
          <tbody id="strategiesList">
            <!-- 策略記錄 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- 外部條件管理區塊 -->
    <div class="mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-medium text-gray-700">外部條件管理</h2>
        <div class="flex space-x-2">
          <button class="button" onclick="toggleExternalConditionManagement()">
            <i id="externalConditionToggleIcon" data-lucide="chevron-down" class="inline-block mr-2"></i>
            收合
          </button>
          <button class="button" onclick="openAddExternalConditionModal()">新增</button>
          <button class="button" onclick="exportExternalConditionsToExcel()">匯出</button>
          <button class="button" onclick="document.getElementById('importExternalConditionsInput').click()">匯入</button>
          <input type="file" id="importExternalConditionsInput" accept=".xlsx, .xls" class="hidden" onchange="importExternalConditionsFromExcel(event)">
        </div>
      </div>
      <div id="externalConditionManagementContent" class="overflow-x-auto">
        <table class="min-w-full bg-white rounded">
          <thead>
            <tr>
              <th class="px-4 py-2 min-w-[150px]">外部條件名稱</th>
              <th class="px-4 py-2 min-w-[200px]">描述</th>
              <th class="px-4 py-2">操作</th>
            </tr>
          </thead>
          <tbody id="externalConditionsList">
            <!-- 外部條件記錄 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- 新增策略模態框 -->
    <div id="addStrategyModal" class="modal hidden">
      <div class="bg-white p-6 rounded-lg w-96">
        <h3 class="text-lg font-medium mb-4">新增</h3>
        <label class="block text-sm font-medium text-gray-700 mb-2" for="newStrategyName">策略名稱</label>
        <input type="text" id="newStrategyName" class="w-full p-2 border rounded mb-4" placeholder="輸入策略名稱">
        <label class="block text-sm font-medium text-gray-700 mb-2" for="newStrategyDescription">描述</label>
        <textarea id="newStrategyDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入策略描述"></textarea>
        <div class="flex justify-end">
          <button class="button mr-2" onclick="closeAddStrategyModal()">取消</button>
          <button class="button" onclick="addStrategy()">新增</button>
        </div>
      </div>
    </div>

    <!-- 編輯策略模態框 -->
    <div id="editStrategyModal" class="modal hidden">
      <div class="bg-white p-6 rounded-lg w-96">
        <h3 class="text-lg font-medium mb-4">編輯策略</h3>
        <input type="hidden" id="editStrategyId">
        <label class="block text-sm font-medium text-gray-700 mb-2" for="editStrategyName">策略名稱</label>
        <input type="text" id="editStrategyName" class="w-full p-2 border rounded mb-4" placeholder="輸入策略名稱">
        <label class="block text-sm font-medium text-gray-700 mb-2" for="editStrategyDescription">描述</label>
        <textarea id="editStrategyDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入策略描述"></textarea>
        <div class="flex justify-end">
          <button class="button mr-2" onclick="closeEditStrategyModal()">取消</button>
          <button class="button" onclick="updateStrategy()">更新</button>
        </div>
      </div>
    </div>

    <!-- 新增外部條件模態框 -->
    <div id="addExternalConditionModal" class="modal hidden">
      <div class="bg-white p-6 rounded-lg w-96">
        <h3 class="text-lg font-medium mb-4">新增</h3>
        <label class="block text-sm font-medium text-gray-700 mb-2" for="newExternalConditionName">外部條件名稱</label>
        <input type="text" id="newExternalConditionName" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件名稱">
        <label class="block text-sm font-medium text-gray-700 mb-2" for="newExternalConditionDescription">描述</label>
        <textarea id="newExternalConditionDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件描述"></textarea>
        <div class="flex justify-end">
          <button class="button mr-2" onclick="closeAddExternalConditionModal()">取消</button>
          <button class="button" onclick="addExternalCondition()">新增</button>
        </div>
      </div>
    </div>

    <!-- 編輯外部條件模態框 -->
    <div id="editExternalConditionModal" class="modal hidden">
      <div class="bg-white p-6 rounded-lg w-96">
        <h3 class="text-lg font-medium mb-4">編輯外部條件</h3>
        <input type="hidden" id="editExternalConditionId">
        <label class="block text-sm font-medium text-gray-700 mb-2" for="editExternalConditionName">外部條件名稱</label>
        <input type="text" id="editExternalConditionName" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件名稱">
        <label class="block text-sm font-medium text-gray-700 mb-2" for="editExternalConditionDescription">描述</label>
        <textarea id="editExternalConditionDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件描述"></textarea>
        <div class="flex justify-end">
          <button class="button mr-2" onclick="closeEditExternalConditionModal()">取消</button>
          <button class="button" onclick="updateExternalCondition()">更新</button>
        </div>
      </div>
    </div>

    <!-- 交易記錄區塊 (新增「交易方向」、「進場價格」、「最高價格」與「最低價格」欄位) -->
    <div class="mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-medium text-gray-700">交易紀錄</h2>
        <div class="flex space-x-2">
          <button class="button" onclick="addTrade()">添加交易</button>
          <button class="button" onclick="exportToExcel()">匯出</button>
          <button class="button" onclick="document.getElementById('importExcelInput').click()">匯入</button>
          <input type="file" id="importExcelInput" accept=".xlsx, .xls" class="hidden" onchange="importFromExcel(event)">
        </div>
      </div>
      <div class="text-sm text-gray-600 mb-2">
        請輸入交易報酬率（例如：+6.66、-2.92）、部位金額、進場價格、最高價格、最低價格、標的名稱、策略名稱、外部條件、開倉日、平倉日，以及選擇交易方向（多/空）
      </div>
      <div class="relative">
        <div class="overflow-x-auto scrollbar-top" id="topScrollbar">
          <div id="topScrollbarContent"></div>
        </div>
        <div class="overflow-x-auto" id="bottomScrollbar">
          <table class="min-w-full bg-white rounded">
            <thead>
              <tr>
                <th class="px-4 py-2 min-w-[80px]">交易</th>
                <th class="px-4 py-2 min-w-[100px]">開倉日</th>
                <th class="px-4 py-2 min-w-[100px]">平倉日</th>
                <th class="px-4 py-2 min-w-[100px]">持倉天數</th>
                <th class="px-4 py-2 min-w-[100px]">報酬率 (%)</th>
                <th class="px-4 py-2 min-w-[100px]">部位金額</th>
                <th class="px-4 py-2 min-w-[100px]">進場價格</th>
                <th class="px-4 py-2 min-w-[100px]">最高價格</th>
                <th class="px-4 py-2 min-w-[100px]">最低價格</th>
                <th class="px-4 py-2 min-w-[100px]">交易方向</th>
                <th class="px-4 py-2 min-w-[150px]">標的名稱</th>
                <th class="px-4 py-2 min-w-[150px]">策略名稱</th>
                <th class="px-4 py-2 min-w-[150px]">外部條件</th>
                <th class="px-4 py-2 min-w-[200px]">文字說明</th>
                <th class="px-4 py-2 min-w-[200px]">圖片</th>
                <th class="px-4 py-2 min-w-[80px]">操作</th>
              </tr>
            </thead>
            <tbody id="tradesList">
              <!-- 交易記錄將在此動態生成 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // 策略列表
      let strategies = [{ id: 1, name: '默認策略', description: '這是默認策略' }];
      // 外部條件列表
      let externalConditions = [{ id: 1, name: '默認外部條件', description: '這是默認外部條件' }];
      // 交易記錄列表，新增 "direction"、"entryPrice"、"highestPrice" 與 "lowestPrice" 欄位
      let trades = [];
      // 當前篩選條件
      let selectedStrategyFilter = null;
      let selectedExternalConditionFilter = null;
      let selectedStartDateFilter = null;
      let selectedEndDateFilter = null;
      let selectedDirectionFilter = null;
      // 全局變數：下一個交易ID
      let nextTradeId = 1;

      function formatNumber(value, isMoneyAmount = false, decimalPlaces = 2) {
        const number = parseFloat(value);
        if (isNaN(number)) return '0';
        if (isMoneyAmount) {
          return number >= 0 ? `+${number.toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces })}`
                            : `-${Math.abs(number).toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces })}`;
        }
        return number >= 0 ? `+${number.toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces })}`
                          : `-${Math.abs(number).toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces })}`;
      }

      function formatNumberNoSign(value, decimalPlaces = 2) {
        const number = parseFloat(value);
        if (isNaN(number)) return '0';
        return number.toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces });
      }

      function formatTradeCount(value) {
        const number = parseInt(value, 10);
        if (isNaN(number)) return '0';
        return number.toLocaleString();
      }

      function formatMoney(value, decimalPlaces = 0) {
        const number = parseFloat(value);
        if (isNaN(number)) return '$0';
        return number >= 0 ? `$${number.toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces })}`
                           : `-$${Math.abs(number).toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces })}`;
      }

      function saveData() {
        localStorage.setItem('trades', JSON.stringify(trades));
        saveStrategies();
        saveExternalConditions();
        saveCollapseState();
      }

      function saveStrategies() {
        localStorage.setItem('strategies', JSON.stringify(strategies));
      }

      function saveExternalConditions() {
        localStorage.setItem('externalConditions', JSON.stringify(externalConditions));
      }

      function saveCollapseState() {
        const strategyCollapsed = document.getElementById('strategyManagementContent').classList.contains('hidden');
        const externalConditionCollapsed = document.getElementById('externalConditionManagementContent').classList.contains('hidden');
        localStorage.setItem('strategyManagementCollapsed', strategyCollapsed);
        localStorage.setItem('externalConditionManagementCollapsed', externalConditionCollapsed);
      }

      function saveTotalOperatingCapital() {
        const initialCapital = document.getElementById('totalOperatingCapital').value;
        localStorage.setItem('totalOperatingCapital', initialCapital);
      }

      function loadTotalOperatingCapital() {
        const initialCapital = localStorage.getItem('totalOperatingCapital');
        if (initialCapital !== null) {
          document.getElementById('totalOperatingCapital').value = initialCapital;
        }
      }

      function loadStrategies() {
        const savedStrategies = JSON.parse(localStorage.getItem('strategies'));
        if (savedStrategies && Array.isArray(savedStrategies)) {
          strategies = savedStrategies;
        } else {
          strategies = [{ id: 1, name: '默認策略', description: '這是默認策略' }];
          saveStrategies();
        }
        const maxStrategyId = strategies.reduce((max, strategy) => strategy.id > max ? strategy.id : max, 0);
        if (maxStrategyId >= nextTradeId) {
          nextTradeId = maxStrategyId + 1;
        }
      }

      function loadExternalConditions() {
        const savedExternalConditions = JSON.parse(localStorage.getItem('externalConditions'));
        if (savedExternalConditions && Array.isArray(savedExternalConditions)) {
          externalConditions = savedExternalConditions;
        } else {
          externalConditions = [{ id: 1, name: '默認外部條件', description: '這是默認外部條件' }];
          saveExternalConditions();
        }
        const maxConditionId = externalConditions.reduce((max, condition) => condition.id > max ? condition.id : max, 0);
        if (maxConditionId >= nextTradeId) {
          nextTradeId = maxConditionId + 1;
        }
      }

      function loadData() {
        const savedTrades = JSON.parse(localStorage.getItem('trades'));
        const strategyManagementCollapsed = localStorage.getItem('strategyManagementCollapsed') === 'true';
        const externalConditionManagementCollapsed = localStorage.getItem('externalConditionManagementCollapsed') === 'true';
        
        if (savedTrades && Array.isArray(savedTrades)) {
          trades = savedTrades.map(trade => {
            if (!trade.id) {
              trade.id = nextTradeId++;
            } else {
              if (trade.id >= nextTradeId) {
                nextTradeId = trade.id + 1;
              }
            }
            if (!trade.description) trade.description = '';
            if (!trade.imageUrl) trade.imageUrl = '';
            if (typeof trade.position === 'undefined') trade.position = '';
            if (typeof trade.entryPrice === 'undefined') trade.entryPrice = '';
            if (typeof trade.highestPrice === 'undefined') trade.highestPrice = '';
            if (typeof trade.lowestPrice === 'undefined') trade.lowestPrice = '';
            if (typeof trade.direction === 'undefined') trade.direction = "多";
            return trade;
          });
        }
        if (trades.length === 0) {
          trades.push({ 
            id: nextTradeId++, 
            returnRate: '', 
            position: '', 
            entryPrice: '',
            highestPrice: '',
            lowestPrice: '',
            assetName: '', 
            strategyId: null, 
            externalConditionId: null, 
            openDate: '', 
            closeDate: '', 
            description: '', 
            imageUrl: '', 
            direction: "多" 
          });
        }
        selectedStrategyFilter = null;
        selectedExternalConditionFilter = null;
        selectedStartDateFilter = null;
        selectedEndDateFilter = null;
        selectedDirectionFilter = null;
        document.getElementById('strategyFilter').value = '';
        document.getElementById('externalConditionFilter').value = '';
        document.getElementById('startDateFilter').value = '';
        document.getElementById('endDateFilter').value = '';
        document.getElementById('directionFilter').value = '';
        renderStrategies();
        renderExternalConditions();
        renderTrades();
        loadTotalOperatingCapital();
        calculateStats();
        applySavedCollapseState(strategyManagementCollapsed, externalConditionManagementCollapsed);
      }

      function applySavedCollapseState(strategyCollapsed, externalConditionCollapsed) {
        if (strategyCollapsed) {
          document.getElementById('strategyManagementContent').classList.add('hidden');
          document.getElementById('strategyToggleIcon').setAttribute('data-lucide', 'chevron-right');
          const strategyToggleButton = document.querySelector('#strategyToggleIcon').parentElement;
          strategyToggleButton.innerHTML = `<i id="strategyToggleIcon" data-lucide="chevron-right" class="inline-block mr-2"></i>展開`;
        }
        if (externalConditionCollapsed) {
          document.getElementById('externalConditionManagementContent').classList.add('hidden');
          document.getElementById('externalConditionToggleIcon').setAttribute('data-lucide', 'chevron-right');
          const externalConditionToggleButton = document.querySelector('#externalConditionToggleIcon').parentElement;
          externalConditionToggleButton.innerHTML = `<i id="externalConditionToggleIcon" data-lucide="chevron-right" class="inline-block mr-2"></i>展開`;
        }
        lucide.createIcons();
      }

      function renderStrategies() {
        const strategiesList = document.getElementById('strategiesList');
        strategiesList.innerHTML = strategies.map(strategy => `
          <tr>
            <td class="border px-4 py-2 min-w-[150px]">${escapeHtml(strategy.name)}</td>
            <td class="border px-4 py-2 min-w-[200px]">${escapeHtml(strategy.description)}</td>
            <td class="border px-4 py-2 text-center">
              <button onclick="openEditStrategyModal(${strategy.id})" class="mr-2">
                <i data-lucide="edit"></i>
              </button>
              <button onclick="deleteStrategy(${strategy.id})" class="delete-button">
                <i data-lucide="trash-2"></i>
              </button>
            </td>
          </tr>
        `).join('');
        renderStrategyFilter();
        lucide.createIcons();
      }

      function renderStrategyFilter() {
        const strategyFilter = document.getElementById('strategyFilter');
        strategyFilter.innerHTML = `
          <option value="">全部策略</option>
          ${strategies.map(strategy => `
            <option value="${strategy.id}">${escapeHtml(strategy.name)}</option>
          `).join('')}
        `;
      }

      function renderExternalConditions() {
        const externalConditionsList = document.getElementById('externalConditionsList');
        externalConditionsList.innerHTML = externalConditions.map(condition => `
          <tr>
            <td class="border px-4 py-2 min-w-[150px]">${escapeHtml(condition.name)}</td>
            <td class="border px-4 py-2 min-w-[200px]">${escapeHtml(condition.description)}</td>
            <td class="border px-4 py-2 text-center">
              <button onclick="openEditExternalConditionModal(${condition.id})" class="mr-2">
                <i data-lucide="edit"></i>
              </button>
              <button onclick="deleteExternalCondition(${condition.id})" class="delete-button">
                <i data-lucide="trash-2"></i>
              </button>
            </td>
          </tr>
        `).join('');
        renderExternalConditionFilter();
        lucide.createIcons();
      }

      function renderExternalConditionFilter() {
        const externalConditionFilter = document.getElementById('externalConditionFilter');
        externalConditionFilter.innerHTML = `
          <option value="">全部外部條件</option>
          ${externalConditions.map(condition => `
            <option value="${condition.id}">${escapeHtml(condition.name)}</option>
          `).join('')}
        `;
      }

      function renderTrades() {
        const tradesList = document.getElementById('tradesList');
        tradesList.innerHTML = '';
        let filteredTrades = trades;
        if (selectedStrategyFilter !== null) {
          filteredTrades = filteredTrades.filter(trade => trade.strategyId === selectedStrategyFilter);
        }
        if (selectedExternalConditionFilter !== null) {
          filteredTrades = filteredTrades.filter(trade => trade.externalConditionId === selectedExternalConditionFilter);
        }
        if (selectedDirectionFilter !== null) {
          filteredTrades = filteredTrades.filter(trade => trade.direction === selectedDirectionFilter);
        }
        if (selectedStartDateFilter !== null && selectedStartDateFilter !== '') {
          const startDate = new Date(selectedStartDateFilter);
          filteredTrades = filteredTrades.filter(trade => trade.openDate && new Date(trade.openDate) >= startDate);
        }
        if (selectedEndDateFilter !== null && selectedEndDateFilter !== '') {
          const endDate = new Date(selectedEndDateFilter);
          filteredTrades = filteredTrades.filter(trade => trade.openDate && new Date(trade.openDate) <= endDate);
        }
        const tradesWithOpenDate = filteredTrades.filter(trade => trade.openDate !== '');
        const sortedAscending = [...tradesWithOpenDate].sort((a, b) => new Date(a.openDate) - new Date(b.openDate));
        const transactionNumbers = new Map();
        sortedAscending.forEach((trade, index) => {
          transactionNumbers.set(trade.id, index + 1);
        });
        filteredTrades.sort((a, b) => {
          if (a.openDate === '' && b.openDate === '') return 0;
          if (a.openDate === '') return -1;
          if (b.openDate === '') return 1;
          return new Date(b.openDate) - new Date(a.openDate);
        });
        tradesList.innerHTML = filteredTrades.map((trade, index) => {
          const transactionNumber = trade.openDate !== '' ? transactionNumbers.get(trade.id) : '';
          let holdingDays = '';
          let holdingDaysClass = '';
          if (trade.openDate !== '' && trade.closeDate !== '') {
            const openDate = new Date(trade.openDate);
            const closeDate = new Date(trade.closeDate);
            const diffTime = closeDate - openDate;
            holdingDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            if (holdingDays < 0) {
              holdingDays = '';
            }
          } else {
            holdingDays = '未平倉';
            holdingDaysClass = 'text-red-500';
          }
          const strategyOptions = strategies.map(strategy => `
            <option value="${strategy.id}" ${trade.strategyId === strategy.id ? 'selected' : ''}>${escapeHtml(strategy.name)}</option>
          `).join('');
          const externalConditionOptions = externalConditions.map(condition => `
            <option value="${condition.id}" ${trade.externalConditionId === condition.id ? 'selected' : ''}>${escapeHtml(condition.name)}</option>
          `).join('');
          return `
            <tr>
              <td class="border px-4 py-2 text-center min-w-[80px]">${transactionNumber}</td>
              <td class="border px-4 py-2 min-w-[100px]">
                <input type="date" value="${trade.openDate}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'openDate', this.value)" class="w-full p-1 border rounded trade-input" data-row-index="${trades.indexOf(trade)}" data-field="openDate">
              </td>
              <td class="border px-4 py-2 min-w-[100px]">
                <input type="date" value="${trade.closeDate}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'closeDate', this.value)" class="w-full p-1 border rounded trade-input" data-row-index="${trades.indexOf(trade)}" data-field="closeDate">
              </td>
              <td class="border px-4 py-2 text-center ${holdingDaysClass} min-w-[100px]">
                ${holdingDays}
              </td>
              <td class="border px-4 py-2 min-w-[100px]">
                <input type="text" value="${trade.returnRate}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'returnRate', this.value)" class="w-full p-1 border rounded trade-input" placeholder="+6.66 或 -2.92" data-row-index="${trades.indexOf(trade)}" data-field="returnRate" data-trade-id="${trade.id}">
              </td>
              <td class="border px-4 py-2 min-w-[100px]">
                <input type="number" value="${trade.position}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'position', this.value)" class="w-full p-1 border rounded trade-input" placeholder="部位金額" data-row-index="${trades.indexOf(trade)}" data-field="position">
              </td>
              <td class="border px-4 py-2 min-w-[100px]">
                <input type="number" value="${trade.entryPrice}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'entryPrice', this.value)" class="w-full p-1 border rounded trade-input" placeholder="進場價格" data-row-index="${trades.indexOf(trade)}" data-field="entryPrice">
              </td>
              <td class="border px-4 py-2 min-w-[100px]">
                <input type="number" value="${trade.highestPrice}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'highestPrice', this.value)" class="w-full p-1 border rounded trade-input" placeholder="最高價格" data-row-index="${trades.indexOf(trade)}" data-field="highestPrice">
              </td>
              <td class="border px-4 py-2 min-w-[100px]">
                <input type="number" value="${trade.lowestPrice}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'lowestPrice', this.value)" class="w-full p-1 border rounded trade-input" placeholder="最低價格" data-row-index="${trades.indexOf(trade)}" data-field="lowestPrice">
              </td>
              <td class="border px-4 py-2 min-w-[100px]">
                <select onchange="handleTradeChange(${trades.indexOf(trade)}, 'direction', this.value)" class="w-full p-1 border rounded trade-input" data-row-index="${trades.indexOf(trade)}" data-field="direction">
                  <option value="多" ${trade.direction === "多" ? "selected" : ""}>多</option>
                  <option value="空" ${trade.direction === "空" ? "selected" : ""}>空</option>
                </select>
              </td>
              <td class="border px-4 py-2 min-w-[150px]">
                <input type="text" value="${escapeHtml(trade.assetName)}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'assetName', this.value)" class="w-full p-1 border rounded trade-input" placeholder="輸入標的名稱" data-row-index="${trades.indexOf(trade)}" data-field="assetName">
              </td>
              <td class="border px-4 py-2 min-w-[150px]">
                <select onchange="handleTradeChange(${trades.indexOf(trade)}, 'strategyId', this.value)" class="w-full p-1 border rounded trade-input" data-row-index="${trades.indexOf(trade)}" data-field="strategyId">
                  <option value="">選擇策略</option>
                  ${strategyOptions}
                </select>
              </td>
              <td class="border px-4 py-2 min-w-[150px]">
                <select onchange="handleTradeChange(${trades.indexOf(trade)}, 'externalConditionId', this.value)" class="w-full p-1 border rounded trade-input" data-row-index="${trades.indexOf(trade)}" data-field="externalConditionId">
                  <option value="">選擇外部條件</option>
                  ${externalConditionOptions}
                </select>
              </td>
              <td class="border px-4 py-2 min-w-[200px]">
                <input type="text" value="${escapeHtml(trade.description)}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'description', this.value)" class="w-full p-1 border rounded trade-input" placeholder="輸入文字說明" data-row-index="${trades.indexOf(trade)}" data-field="description">
              </td>
              <td class="border px-4 py-2 min-w-[200px]">
                <input type="text" value="${trade.imageUrl}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'imageUrl', this.value)" class="w-full p-1 border rounded trade-input" placeholder="輸入圖片URL" data-row-index="${trades.indexOf(trade)}" data-field="imageUrl">
                ${trade.imageUrl ? `<button onclick="openImageLink('${encodeURIComponent(trade.imageUrl)}')" class="mt-2 button text-sm">查看圖片</button>` : ''}
              </td>
              <td class="border px-4 py-2 text-center min-w-[80px]">
                ${trades.length > 1 ? `<button onclick="removeTrade(${trades.indexOf(trade)})" class="delete-button"><i data-lucide="trash-2"></i></button>` : ''}
              </td>
            </tr>
          `;
        }).join('');
        lucide.createIcons();
        const topScrollbarContent = document.getElementById('topScrollbarContent');
        const bottomScrollbar = document.getElementById('bottomScrollbar');
        const table = bottomScrollbar.querySelector('table');
        if (table) {
          topScrollbarContent.style.width = table.scrollWidth + 'px';
        }
        const topScrollbar = document.getElementById('topScrollbar');
        const bottomScrollDiv = document.getElementById('bottomScrollbar');
        topScrollbar.removeEventListener('scroll', syncTopToBottom);
        bottomScrollDiv.removeEventListener('scroll', syncBottomToTop);
        function syncTopToBottom() {
          bottomScrollDiv.scrollLeft = topScrollbar.scrollLeft;
        }
        function syncBottomToTop() {
          topScrollbar.scrollLeft = bottomScrollDiv.scrollLeft;
        }
        topScrollbar.addEventListener('scroll', syncTopToBottom);
        bottomScrollDiv.addEventListener('scroll', syncBottomToTop);
        topScrollbar.scrollLeft = bottomScrollDiv.scrollLeft;
      }

      function getStrategyName(strategyId) {
        const strategy = strategies.find(s => s.id === strategyId);
        return strategy ? strategy.name : '';
      }

      function getExternalConditionName(conditionId) {
        const condition = externalConditions.find(c => c.id === conditionId);
        return condition ? condition.name : '';
      }

      function handleTradeChange(index, field, value) {
        if (field === 'returnRate') {
          const cleanedValue = value.replace('%', '').trim();
          trades[index].returnRate = (cleanedValue === '' || isNaN(cleanedValue)) ? '' : cleanedValue;
        } else if (field === 'assetName') {
          trades[index].assetName = value.trim();
        } else if (field === 'strategyId') {
          trades[index].strategyId = value === '' ? null : parseInt(value, 10);
        } else if (field === 'externalConditionId') {
          trades[index].externalConditionId = value === '' ? null : parseInt(value, 10);
        } else if (field === 'openDate') {
          trades[index].openDate = value;
          const closeDate = trades[index].closeDate;
          if (closeDate !== '' && new Date(closeDate) < new Date(value)) {
            alert('平倉日不能早於開倉日。');
            trades[index].closeDate = '';
            document.querySelector(`input[data-row-index="${index}"][data-field="closeDate"]`).value = '';
          }
        } else if (field === 'closeDate') {
          trades[index].closeDate = value;
          const openDate = trades[index].openDate;
          if (openDate !== '' && new Date(value) < new Date(openDate)) {
            alert('平倉日不能早於開倉日。');
            trades[index].closeDate = '';
            document.querySelector(`input[data-row-index="${index}"][data-field="closeDate"]`).value = '';
          }
        } else if (field === 'description') {
          trades[index].description = value.trim();
        } else if (field === 'imageUrl') {
          trades[index].imageUrl = value.trim();
        } else if (field === 'position') {
          trades[index].position = value.trim();
        } else if (field === 'direction') {
          trades[index].direction = value;
        } else if (field === 'entryPrice') {
          trades[index].entryPrice = value.trim();
        } else if (field === 'highestPrice') {
          trades[index].highestPrice = value.trim();
        } else if (field === 'lowestPrice') {
          trades[index].lowestPrice = value.trim();
        }
        calculateStats();
        saveData();
      }

      function openImageLink(url) {
        window.open(decodeURIComponent(url), '_blank');
      }

      function addTrade() {
        if (strategies.length === 0) {
          alert('請先新增至少一個交易策略。');
          return;
        }
        if (externalConditions.length === 0) {
          alert('請先新增至少一個外部條件。');
          return;
        }
        const newTrade = { 
          id: nextTradeId++, 
          returnRate: '', 
          position: '',
          entryPrice: '',
          highestPrice: '',
          lowestPrice: '',
          assetName: '', 
          strategyId: null, 
          externalConditionId: null, 
          openDate: '', 
          closeDate: '',
          description: '', 
          imageUrl: '',
          direction: "多"
        };
        trades.unshift(newTrade);
        renderTrades();
        calculateStats();
        saveData();
        setTimeout(() => {
          const newInput = document.querySelector(`input[data-trade-id="${newTrade.id}"][data-field="returnRate"]`);
          if (newInput) {
            newInput.focus();
          }
        }, 100);
      }

      function removeTrade(index) {
        trades = trades.filter((_, i) => i !== index);
        if (trades.length === 0) {
          trades.push({ id: nextTradeId++, returnRate: '', position: '', entryPrice: '', highestPrice: '', lowestPrice: '', assetName: '', strategyId: null, externalConditionId: null, openDate: '', closeDate: '', description: '', imageUrl: '', direction: "多" });
        }
        renderTrades();
        calculateStats();
        saveData();
      }

      function openAddStrategyModal() {
        openModal('addStrategyModal');
      }

      function closeAddStrategyModal() {
        closeModal('addStrategyModal');
      }

      function addStrategy() {
        const nameInput = document.getElementById('newStrategyName');
        const descriptionInput = document.getElementById('newStrategyDescription');
        const name = nameInput.value.trim();
        const description = descriptionInput.value.trim();
        if (name === '') {
          alert('策略名稱不能為空。');
          return;
        }
        const existingStrategy = strategies.find(strategy => strategy.name === name);
        if (existingStrategy) {
          alert('策略名稱已存在，請選擇其他名稱。');
          return;
        }
        const newId = strategies.length > 0 ? Math.max(...strategies.map(s => s.id)) + 1 : 1;
        strategies.push({ id: newId, name, description });
        saveStrategies();
        renderStrategies();
        renderTrades();
        calculateStats();
        closeAddStrategyModal();
      }

      function openEditStrategyModal(strategyId) {
        const strategy = strategies.find(s => s.id === strategyId);
        if (!strategy) return;
        document.getElementById('editStrategyId').value = strategy.id;
        document.getElementById('editStrategyName').value = strategy.name;
        document.getElementById('editStrategyDescription').value = strategy.description;
        openModal('editStrategyModal');
      }

      function closeEditStrategyModal() {
        closeModal('editStrategyModal');
      }

      function updateStrategy() {
        const id = parseInt(document.getElementById('editStrategyId').value, 10);
        const name = document.getElementById('editStrategyName').value.trim();
        const description = document.getElementById('editStrategyDescription').value.trim();
        if (name === '') {
          alert('策略名稱不能為空。');
          return;
        }
        const existingStrategy = strategies.find(strategy => strategy.name === name && strategy.id !== id);
        if (existingStrategy) {
          alert('策略名稱已存在，請選擇其他名稱。');
          return;
        }
        const strategyIndex = strategies.findIndex(s => s.id === id);
        if (strategyIndex === -1) return;
        strategies[strategyIndex].name = name;
        strategies[strategyIndex].description = description;
        saveStrategies();
        renderStrategies();
        renderTrades();
        calculateStats();
        closeEditStrategyModal();
      }

      function deleteStrategy(strategyId) {
        const tradesUsingStrategy = trades.filter(trade => trade.strategyId === strategyId);
        if (tradesUsingStrategy.length > 0) {
          alert('有交易紀錄正在使用此策略，請先移除或更改相關交易紀錄。');
          return;
        }
        if (!confirm('您確定要刪除此策略嗎？此操作無法撤銷。')) {
          return;
        }
        strategies = strategies.filter(strategy => strategy.id !== strategyId);
        saveStrategies();
        renderStrategies();
        renderTrades();
        calculateStats();
      }

      function openAddExternalConditionModal() {
        openModal('addExternalConditionModal');
      }

      function closeAddExternalConditionModal() {
        closeModal('addExternalConditionModal');
      }

      function addExternalCondition() {
        const nameInput = document.getElementById('newExternalConditionName');
        const descriptionInput = document.getElementById('newExternalConditionDescription');
        const name = nameInput.value.trim();
        const description = descriptionInput.value.trim();
        if (name === '') {
          alert('外部條件名稱不能為空。');
          return;
        }
        const existingCondition = externalConditions.find(condition => condition.name === name);
        if (existingCondition) {
          alert('外部條件名稱已存在，請選擇其他名稱。');
          return;
        }
        const newId = externalConditions.length > 0 ? Math.max(...externalConditions.map(c => c.id)) + 1 : 1;
        externalConditions.push({ id: newId, name, description });
        saveExternalConditions();
        renderExternalConditions();
        renderTrades();
        calculateStats();
        closeAddExternalConditionModal();
      }

      function openEditExternalConditionModal(conditionId) {
        const condition = externalConditions.find(c => c.id === conditionId);
        if (!condition) return;
        document.getElementById('editExternalConditionId').value = condition.id;
        document.getElementById('editExternalConditionName').value = condition.name;
        document.getElementById('editExternalConditionDescription').value = condition.description;
        openModal('editExternalConditionModal');
      }

      function closeEditExternalConditionModal() {
        closeModal('editExternalConditionModal');
      }

      function updateExternalCondition() {
        const id = parseInt(document.getElementById('editExternalConditionId').value, 10);
        const name = document.getElementById('editExternalConditionName').value.trim();
        const description = document.getElementById('editExternalConditionDescription').value.trim();
        if (name === '') {
          alert('外部條件名稱不能為空。');
          return;
        }
        const existingCondition = externalConditions.find(condition => condition.name === name && condition.id !== id);
        if (existingCondition) {
          alert('外部條件名稱已存在，請選擇其他名稱。');
          return;
        }
        const conditionIndex = externalConditions.findIndex(c => c.id === id);
        if (conditionIndex === -1) return;
        externalConditions[conditionIndex].name = name;
        externalConditions[conditionIndex].description = description;
        saveExternalConditions();
        renderExternalConditions();
        renderTrades();
        calculateStats();
        closeEditExternalConditionModal();
      }

      function deleteExternalCondition(conditionId) {
        const tradesUsingCondition = trades.filter(trade => trade.externalConditionId === conditionId);
        if (tradesUsingCondition.length > 0) {
          alert('有交易紀錄正在使用此外部條件，請先移除或更改相關交易紀錄。');
          return;
        }
        if (!confirm('您確定要刪除此外部條件嗎？此操作無法撤銷。')) {
          return;
        }
        externalConditions = externalConditions.filter(condition => condition.id !== conditionId);
        saveExternalConditions();
        renderExternalConditions();
        renderTrades();
        calculateStats();
      }

      function applyFilters() {
        const strategyId = document.getElementById('strategyFilter').value;
        const externalConditionId = document.getElementById('externalConditionFilter').value;
        const direction = document.getElementById('directionFilter').value;
        const startDate = document.getElementById('startDateFilter').value;
        const endDate = document.getElementById('endDateFilter').value;
        selectedStrategyFilter = strategyId === '' ? null : parseInt(strategyId, 10);
        selectedExternalConditionFilter = externalConditionId === '' ? null : parseInt(externalConditionId, 10);
        selectedDirectionFilter = direction === '' ? null : direction;
        selectedStartDateFilter = startDate === '' ? null : startDate;
        selectedEndDateFilter = endDate === '' ? null : endDate;
        calculateStats();
        renderTrades();
      }

      function clearDateFilters() {
        document.getElementById('startDateFilter').value = '';
        document.getElementById('endDateFilter').value = '';
        selectedStartDateFilter = null;
        selectedEndDateFilter = null;
        applyFilters();
      }

      function shiftEndDate(days) {
        const endDateInput = document.getElementById('endDateFilter');
        let endDate = endDateInput.value ? new Date(endDateInput.value) : null;
        if (endDate) {
          endDate.setDate(endDate.getDate() + days);
          endDateInput.value = formatDate(endDate);
        } else {
          alert('請先設定結束日期，再進行調整。');
        }
        applyFilters();
      }

      function formatDate(date) {
        return date.toISOString().split('T')[0];
      }

      // calculateMDD() 函式（不變）
      function calculateMDD(initialCapital, tradesWithPosition) {
        let groups = {};
        tradesWithPosition.forEach(trade => {
          if (trade.closeDate && trade.closeDate.trim() !== '') {
            if (!groups[trade.closeDate]) groups[trade.closeDate] = [];
            groups[trade.closeDate].push(trade);
          }
        });
        let dates = Object.keys(groups).sort((a, b) => new Date(a) - new Date(b));
        let equity = initialCapital;
        let maxDrawdownPercent = 0;
        dates.forEach(date => {
          let groupTrades = groups[date];
          let profitSum = 0, lossSum = 0;
          groupTrades.forEach(trade => {
            let p = parseFloat(trade.returnRate) / 100 * parseFloat(trade.position);
            if (p > 0) profitSum += p;
            else lossSum += p;
          });
          let dayPeak = equity + profitSum;
          let dayEnd = dayPeak + lossSum;
          let dayDrawdownPercent = (dayPeak - dayEnd) / dayPeak;
          if (dayDrawdownPercent > maxDrawdownPercent) {
            maxDrawdownPercent = dayDrawdownPercent;
          }
          equity = dayEnd;
        });
        return maxDrawdownPercent;
      }

      // updateStrategyUsage()：計算各策略在所有交易中的使用次數，並更新至畫面上
      function updateStrategyUsage() {
        let usage = {};
        strategies.forEach(s => { usage[s.id] = 0; });
        trades.forEach(t => {
          if (t.strategyId !== null) {
            usage[t.strategyId]++;
          }
        });
        let list = document.getElementById("strategyUsageList");
        if(list) {
          list.innerHTML = "";
          strategies.forEach(s => {
            let count = usage[s.id] || 0;
            let li = document.createElement("li");
            li.textContent = `${s.name}：${count} 次`;
            list.appendChild(li);
          });
        }
      }

      // calculateStats()：更新所有統計數據
      function calculateStats() {
        const initialCapital = parseFloat(document.getElementById('totalOperatingCapital').value) || 0;
        
        let closedTrades = trades.filter(trade => trade.returnRate !== '' && !isNaN(parseFloat(trade.returnRate)));
        if (selectedStrategyFilter !== null) {
          closedTrades = closedTrades.filter(trade => trade.strategyId === selectedStrategyFilter);
        }
        if (selectedExternalConditionFilter !== null) {
          closedTrades = closedTrades.filter(trade => trade.externalConditionId === selectedExternalConditionFilter);
        }
        if (selectedDirectionFilter !== null) {
          closedTrades = closedTrades.filter(trade => trade.direction === selectedDirectionFilter);
        }
        if (selectedStartDateFilter !== null && selectedStartDateFilter !== '') {
          const startDate = new Date(selectedStartDateFilter);
          closedTrades = closedTrades.filter(trade => trade.openDate && new Date(trade.openDate) >= startDate);
        }
        if (selectedEndDateFilter !== null && selectedEndDateFilter !== '') {
          const endDate = new Date(selectedEndDateFilter);
          closedTrades = closedTrades.filter(trade => trade.openDate && new Date(trade.openDate) <= endDate);
        }
        let closedTradesWithPosition = closedTrades.filter(trade =>
          trade.position !== '' && !isNaN(parseFloat(trade.position)) && parseFloat(trade.position) > 0
        );
        let totalReturnAmount = 0;
        if (closedTradesWithPosition.length > 0) {
          totalReturnAmount = closedTradesWithPosition.reduce((sum, trade) => 
            sum + (parseFloat(trade.returnRate) / 100 * parseFloat(trade.position)), 0);
        }
        const currentCapital = initialCapital + totalReturnAmount;
        document.getElementById('currentCapitalDisplay').textContent = "最新資金水位：" + formatMoney(currentCapital, 0);
        
        // 計算 MDD%
        let mddPercent = calculateMDD(initialCapital, closedTradesWithPosition) * 100;
        
        if (closedTrades.length === 0) {
          document.getElementById('totalTrades').textContent = '0';
          document.getElementById('winRate').textContent = '0% (0勝0敗)';
          document.getElementById('riskRewardRatio').textContent = '0';
          document.getElementById('avgWin').textContent = formatMoney(0, 0);
          document.getElementById('avgLoss').textContent = formatMoney(0, 0);
          document.getElementById('maxWin').textContent = formatMoney(0, 0);
          document.getElementById('maxLoss').textContent = formatMoney(0, 0);
          document.getElementById('expectedValue').textContent = formatMoney(0, 0);
          document.getElementById('totalReturn').textContent = formatMoney(0, 0);
          document.getElementById('maxDrawdown').textContent = "0%";
          document.getElementById('avgMFE').textContent = "0%";
          document.getElementById('sdMFE').textContent = "0%";
          document.getElementById('cvMFE').textContent = "0";
          document.getElementById('avgMAE').textContent = "0%";
          document.getElementById('sdMAE').textContent = "0%";
          document.getElementById('cvMAE').textContent = "0";
          document.getElementById('skewMFE').textContent = "0";
          document.getElementById('skewMAE').textContent = "0";
          document.getElementById('kurtosisMFE').textContent = "0";
          document.getElementById('kurtosisMAE').textContent = "0";
          document.getElementById('avgWinPercent').textContent = "0%";
          document.getElementById('sdWinPercent').textContent = "0%";
          document.getElementById('cvWinPercent').textContent = "0";
          document.getElementById('skewWinPercent').textContent = "0";
          document.getElementById('kurtosisWinPercent').textContent = "0";
          document.getElementById('avgLossPercentDisplay').textContent = "0%";
          document.getElementById('sdLossPercent').textContent = "0%";
          document.getElementById('cvLossPercent').textContent = "0";
          document.getElementById('skewLossPercent').textContent = "0";
          document.getElementById('kurtosisLossPercent').textContent = "0";
          document.getElementById('profitAchievementRate').textContent = "0%";
        } else {
          const results = closedTrades.map(trade => parseFloat(trade.returnRate));
          const wins = results.filter(result => result > 0);
          const losses = results.filter(result => result < 0);
          const winRate = (wins.length / results.length) * 100;
          const avgWinRate = wins.length > 0 ? wins.reduce((a, b) => a + b) / wins.length : 0;
          const avgLossRate = losses.length > 0 ? losses.reduce((a, b) => a + b) / losses.length : 0;
          const maxWinRate = wins.length > 0 ? Math.max(...wins) : 0;
          const maxLossRate = losses.length > 0 ? Math.min(...losses) : 0;

          const winsWithPosition = closedTradesWithPosition.filter(trade => parseFloat(trade.returnRate) > 0);
          const lossesWithPosition = closedTradesWithPosition.filter(trade => parseFloat(trade.returnRate) < 0);
          const avgWinAmount = winsWithPosition.length > 0 ? winsWithPosition.reduce((sum, trade) => sum + (parseFloat(trade.returnRate) / 100 * parseFloat(trade.position)), 0) / winsWithPosition.length : 0;
          const avgLossAmount = lossesWithPosition.length > 0 ? lossesWithPosition.reduce((sum, trade) => sum + (parseFloat(trade.returnRate) / 100 * parseFloat(trade.position)), 0) / lossesWithPosition.length : 0;
          const maxWinAmount = winsWithPosition.length > 0 ? Math.max(...winsWithPosition.map(trade => (parseFloat(trade.returnRate) / 100 * parseFloat(trade.position)))) : 0;
          const maxLossAmount = lossesWithPosition.length > 0 ? Math.min(...lossesWithPosition.map(trade => (parseFloat(trade.returnRate) / 100 * parseFloat(trade.position)))) : 0;
          const expectedValueAmount = closedTradesWithPosition.length > 0 ? totalReturnAmount / closedTradesWithPosition.length : 0;

          document.getElementById('expectedValue').textContent = formatMoney(expectedValueAmount, 0);
          document.getElementById('totalReturn').textContent = formatMoney(totalReturnAmount, 0);
          var riskRewardRatio = avgLossAmount !== 0 ? (avgWinAmount / Math.abs(avgLossAmount)) : 0;
          document.getElementById('riskRewardRatio').textContent = formatNumberNoSign(riskRewardRatio, 2);
          
          // 更新金額統計（獲利與虧損）
          document.getElementById('avgWin').textContent = formatMoney(avgWinAmount, 0);
          document.getElementById('maxWin').textContent = formatMoney(maxWinAmount, 0);
          document.getElementById('avgLoss').textContent = formatMoney(avgLossAmount, 0);
          document.getElementById('maxLoss').textContent = formatMoney(maxLossAmount, 0);
          document.getElementById('totalTrades').textContent = formatTradeCount(results.length);
          document.getElementById('winRate').textContent = `${formatNumber(winRate.toFixed(2))}% (${wins.length}勝${losses.length}敗)`;
          const expectedValueElem = document.getElementById('expectedValue');
          if (expectedValueAmount > 0) {
            expectedValueElem.classList.add('text-red-500');
            expectedValueElem.classList.remove('text-green-500');
          } else if (expectedValueAmount < 0) {
            expectedValueElem.classList.add('text-green-500');
            expectedValueElem.classList.remove('text-red-500');
          } else {
            expectedValueElem.classList.remove('text-red-500', 'text-green-500');
          }
          const totalReturnElem = document.getElementById('totalReturn');
          if (totalReturnAmount > 0) {
            totalReturnElem.classList.add('text-red-500');
            totalReturnElem.classList.remove('text-green-500');
          } else if (totalReturnAmount < 0) {
            totalReturnElem.classList.add('text-green-500');
            totalReturnElem.classList.remove('text-red-500');
          } else {
            totalReturnElem.classList.remove('text-red-500', 'text-green-500');
          }
          const maxDrawdownElem = document.getElementById('maxDrawdown');
          maxDrawdownElem.textContent = formatNumberNoSign(mddPercent, 2) + "%";
          if (mddPercent > 0) {
            maxDrawdownElem.classList.add('text-green-500');
            maxDrawdownElem.classList.remove('text-red-500');
          } else {
            maxDrawdownElem.classList.remove('text-red-500', 'text-green-500');
          }
        }

        // MFE 與 MAE 相關數據計算
        let tradesWithPrices = closedTrades.filter(trade => 
          trade.entryPrice !== '' && trade.highestPrice !== '' && trade.lowestPrice !== ''
        );
        let avgMFE = 0, avgMAE = 0;
        let totalMFE = 0, totalMAE = 0;
        let mfeValues = [], maeValues = [];
        let skewMFE = 0, skewMAE = 0;
        let kurtosisMFE = 0, kurtosisMAE = 0;
        if (tradesWithPrices.length > 0) {
          tradesWithPrices.forEach(trade => {
            let entry = parseFloat(trade.entryPrice);
            let high = parseFloat(trade.highestPrice);
            let low = parseFloat(trade.lowestPrice);
            let mfe = 0, mae = 0;
            if (trade.direction === "多") {
              mfe = (high - entry) / entry * 100;
              mae = (entry - low) / entry * 100;
            } else {
              mfe = (entry - low) / entry * 100;
              mae = (high - entry) / entry * 100;
            }
            totalMFE += mfe;
            totalMAE += mae;
            mfeValues.push(mfe);
            maeValues.push(mae);
          });
          avgMFE = totalMFE / tradesWithPrices.length;
          avgMAE = totalMAE / tradesWithPrices.length;
          let sumSqMFE = 0, sumSqMAE = 0;
          mfeValues.forEach(val => { sumSqMFE += Math.pow(val - avgMFE, 2); });
          maeValues.forEach(val => { sumSqMAE += Math.pow(val - avgMAE, 2); });
          var stdMFE = Math.sqrt(sumSqMFE / tradesWithPrices.length);
          var stdMAE = Math.sqrt(sumSqMAE / tradesWithPrices.length);
          var cvMFE = avgMFE !== 0 ? stdMFE / avgMFE : 0;
          var cvMAE = avgMAE !== 0 ? stdMAE / avgMAE : 0;
          let sumCubeMFE = 0, sumCubeMAE = 0;
          mfeValues.forEach(val => { sumCubeMFE += Math.pow(val - avgMFE, 3); });
          maeValues.forEach(val => { sumCubeMAE += Math.pow(val - avgMAE, 3); });
          let skewMFEVal = stdMFE !== 0 ? (sumCubeMFE / tradesWithPrices.length) / Math.pow(stdMFE, 3) : 0;
          let skewMAEVal = stdMAE !== 0 ? (sumCubeMAE / tradesWithPrices.length) / Math.pow(stdMAE, 3) : 0;
          skewMFE = skewMFEVal;
          skewMAE = skewMAEVal;
          let sumFourthMFE = 0, sumFourthMAE = 0;
          mfeValues.forEach(val => { sumFourthMFE += Math.pow(val - avgMFE, 4); });
          maeValues.forEach(val => { sumFourthMAE += Math.pow(val - avgMAE, 4); });
          let kurtosisMFEVal = stdMFE !== 0 ? (sumFourthMFE / tradesWithPrices.length) / Math.pow(stdMFE, 4) : 0;
          let kurtosisMAEVal = stdMAE !== 0 ? (sumFourthMAE / tradesWithPrices.length) / Math.pow(stdMAE, 4) : 0;
          kurtosisMFE = kurtosisMFEVal;
          kurtosisMAE = kurtosisMAEVal;
        } else {
          avgMFE = 0; avgMAE = 0;
          var stdMFE = 0, stdMAE = 0;
          var cvMFE = 0, cvMAE = 0;
          skewMFE = 0;
          skewMAE = 0;
          kurtosisMFE = 0;
          kurtosisMAE = 0;
        }
        document.getElementById('avgMFE').textContent = formatNumberNoSign(avgMFE, 2) + "%";
        document.getElementById('sdMFE').textContent = formatNumberNoSign(stdMFE, 2) + "%";
        document.getElementById('cvMFE').textContent = formatNumberNoSign(cvMFE, 2);
        document.getElementById('avgMAE').textContent = formatNumberNoSign(avgMAE, 2) + "%";
        document.getElementById('sdMAE').textContent = formatNumberNoSign(stdMAE, 2) + "%";
        document.getElementById('cvMAE').textContent = formatNumberNoSign(cvMAE, 2);
        document.getElementById('skewMFE').textContent = formatNumberNoSign(skewMFE, 2);
        document.getElementById('skewMAE').textContent = formatNumberNoSign(skewMAE, 2);
        document.getElementById('kurtosisMFE').textContent = formatNumberNoSign(kurtosisMFE, 2);
        document.getElementById('kurtosisMAE').textContent = formatNumberNoSign(kurtosisMAE, 2);

        // 損益百分比統計：以勝單與虧單的 returnRate 當作百分比值
        let winPercentValues = [];
        let lossPercentValues = [];
        closedTradesWithPosition.forEach(trade => {
          let ret = parseFloat(trade.returnRate);
          if (!isNaN(ret)) {
            if (ret > 0) {
              winPercentValues.push(ret);
            } else if (ret < 0) {
              lossPercentValues.push(Math.abs(ret));
            }
          }
        });
        let avgWinPercentValue = winPercentValues.length > 0 ? winPercentValues.reduce((sum, v) => sum + v, 0) / winPercentValues.length : 0;
        let sdWinPercent = winPercentValues.length > 0 ? Math.sqrt(winPercentValues.reduce((sum, v) => sum + Math.pow(v - avgWinPercentValue, 2), 0) / winPercentValues.length) : 0;
        let cvWinPercent = avgWinPercentValue !== 0 ? sdWinPercent / avgWinPercentValue : 0;
        let avgLossPercentValue = lossPercentValues.length > 0 ? lossPercentValues.reduce((sum, v) => sum + v, 0) / lossPercentValues.length : 0;
        let sdLossPercent = lossPercentValues.length > 0 ? Math.sqrt(lossPercentValues.reduce((sum, v) => sum + Math.pow(v - avgLossPercentValue, 2), 0) / lossPercentValues.length) : 0;
        let cvLossPercent = avgLossPercentValue !== 0 ? sdLossPercent / avgLossPercentValue : 0;
        let winPercentSkewness = 0, lossPercentSkewness = 0;
        if (winPercentValues.length > 0 && sdWinPercent !== 0) {
          let sumCubeWin = winPercentValues.reduce((sum, v) => sum + Math.pow(v - avgWinPercentValue, 3), 0);
          winPercentSkewness = (sumCubeWin / winPercentValues.length) / Math.pow(sdWinPercent, 3);
        }
        if (lossPercentValues.length > 0 && sdLossPercent !== 0) {
          let sumCubeLoss = lossPercentValues.reduce((sum, v) => sum + Math.pow(v - avgLossPercentValue, 3), 0);
          lossPercentSkewness = (sumCubeLoss / lossPercentValues.length) / Math.pow(sdLossPercent, 3);
        }
        let winPercentKurtosis = 0, lossPercentKurtosis = 0;
        if (winPercentValues.length > 0 && sdWinPercent !== 0) {
          let sumFourthWin = winPercentValues.reduce((sum, v) => sum + Math.pow(v - avgWinPercentValue, 4), 0);
          winPercentKurtosis = (sumFourthWin / winPercentValues.length) / Math.pow(sdWinPercent, 4);
        }
        if (lossPercentValues.length > 0 && sdLossPercent !== 0) {
          let sumFourthLoss = lossPercentValues.reduce((sum, v) => sum + Math.pow(v - avgLossPercentValue, 4), 0);
          lossPercentKurtosis = (sumFourthLoss / lossPercentValues.length) / Math.pow(sdLossPercent, 4);
        }
        document.getElementById('avgWinPercent').textContent = formatNumberNoSign(avgWinPercentValue, 2) + "%";
        document.getElementById('sdWinPercent').textContent = formatNumberNoSign(sdWinPercent, 2) + "%";
        document.getElementById('cvWinPercent').textContent = formatNumberNoSign(cvWinPercent, 2);
        document.getElementById('skewWinPercent').textContent = formatNumberNoSign(winPercentSkewness, 2);
        document.getElementById('kurtosisWinPercent').textContent = formatNumberNoSign(winPercentKurtosis, 2);
        document.getElementById('avgLossPercentDisplay').textContent = formatNumberNoSign(avgLossPercentValue, 2) + "%";
        document.getElementById('sdLossPercent').textContent = formatNumberNoSign(sdLossPercent, 2) + "%";
        document.getElementById('cvLossPercent').textContent = formatNumberNoSign(cvLossPercent, 2);
        document.getElementById('skewLossPercent').textContent = formatNumberNoSign(lossPercentSkewness, 2);
        document.getElementById('kurtosisLossPercent').textContent = formatNumberNoSign(lossPercentKurtosis, 2);

        // 新增計算「獲利達成率」：平均獲利% / 平均 MFE × 100
        let profitAchievementRate = (avgMFE !== 0) ? (avgWinPercentValue / avgMFE) * 100 : 0;
        document.getElementById('profitAchievementRate').textContent = formatNumberNoSign(profitAchievementRate, 2) + "%";

        const winningTrades = closedTrades.filter(trade => 
          trade.position !== '' && !isNaN(parseFloat(trade.position)) && parseFloat(trade.position) > 0 &&
          trade.returnRate !== '' && !isNaN(parseFloat(trade.returnRate)) && parseFloat(trade.returnRate) > 0
        );
        const losingTrades = closedTrades.filter(trade => 
          trade.position !== '' && !isNaN(parseFloat(trade.position)) && parseFloat(trade.position) > 0 &&
          trade.returnRate !== '' && !isNaN(parseFloat(trade.returnRate)) && parseFloat(trade.returnRate) < 0
        );
        const avgWinningPosition = winningTrades.length > 0 ? winningTrades.reduce((sum, trade) => sum + parseFloat(trade.position), 0) / winningTrades.length : 0;
        const avgLosingPosition = losingTrades.length > 0 ? losingTrades.reduce((sum, trade) => sum + parseFloat(trade.position), 0) / losingTrades.length : 0;
        document.getElementById('avgWinningPosition').textContent = formatMoney(avgWinningPosition, 0);
        document.getElementById('avgLosingPosition').textContent = formatMoney(avgLosingPosition, 0);

        let unclosedTrades = trades.filter(trade => trade.openDate !== '' && (!trade.closeDate || trade.closeDate.trim() === ''));
        if (selectedStrategyFilter !== null) {
          unclosedTrades = unclosedTrades.filter(trade => trade.strategyId === selectedStrategyFilter);
        }
        if (selectedExternalConditionFilter !== null) {
          unclosedTrades = unclosedTrades.filter(trade => trade.externalConditionId === selectedExternalConditionFilter);
        }
        if (selectedDirectionFilter !== null) {
          unclosedTrades = unclosedTrades.filter(trade => trade.direction === selectedDirectionFilter);
        }
        if (selectedStartDateFilter !== null && selectedStartDateFilter !== '') {
          const startDate = new Date(selectedStartDateFilter);
          unclosedTrades = unclosedTrades.filter(trade => trade.openDate && new Date(trade.openDate) >= startDate);
        }
        if (selectedEndDateFilter !== null && selectedEndDateFilter !== '') {
          const endDate = new Date(selectedEndDateFilter);
          unclosedTrades = unclosedTrades.filter(trade => trade.openDate && new Date(trade.openDate) <= endDate);
        }
        const unclosedTradeCount = unclosedTrades.length;
        const unclosedPositionSum = unclosedTrades.reduce((sum, trade) => sum + (parseFloat(trade.position) || 0), 0);
        document.getElementById('unclosedTradeCount').textContent = unclosedTradeCount;
        document.getElementById('unclosedPositionTotal').textContent = formatMoney(unclosedPositionSum, 0);
        
        let roi = 0;
        if (!isNaN(initialCapital) && initialCapital > 0) {
          roi = ((currentCapital - initialCapital) / initialCapital) * 100;
        }
        let freeCapital = currentCapital - unclosedPositionSum;
        document.getElementById('roi').textContent = formatNumberNoSign(roi, 2);
        document.getElementById('freeCapital').textContent = formatMoney(freeCapital, 0);
        document.getElementById('capitalUsed').textContent = formatMoney(unclosedPositionSum, 0);

        // 更新各策略使用次數
        updateStrategyUsage();
      }

      // 更新各種策略使用次數的函式
      function updateStrategyUsage() {
        let usage = {};
        strategies.forEach(s => { usage[s.id] = 0; });
        trades.forEach(t => {
          if(t.strategyId !== null) {
            usage[t.strategyId]++;
          }
        });
        let list = document.getElementById("strategyUsageList");
        if(list) {
          list.innerHTML = "";
          strategies.forEach(s => {
            let count = usage[s.id] || 0;
            let li = document.createElement("li");
            li.textContent = `${s.name}：${count} 次`;
            list.appendChild(li);
          });
        }
      }

      // 初始化
      loadStrategies();
      loadExternalConditions();
      loadData();

      function toggleStrategyManagement() {
        const content = document.getElementById('strategyManagementContent');
        const toggleIcon = document.getElementById('strategyToggleIcon');
        const toggleButton = toggleIcon.parentElement;
        if (content.classList.contains('hidden')) {
          content.classList.remove('hidden');
          toggleIcon.setAttribute('data-lucide', 'chevron-down');
          toggleButton.innerHTML = `<i id="strategyToggleIcon" data-lucide="chevron-down" class="inline-block mr-2"></i>收合`;
        } else {
          content.classList.add('hidden');
          toggleIcon.setAttribute('data-lucide', 'chevron-right');
          toggleButton.innerHTML = `<i id="strategyToggleIcon" data-lucide="chevron-right" class="inline-block mr-2"></i>展開`;
        }
        lucide.createIcons();
        saveCollapseState();
      }

      function toggleExternalConditionManagement() {
        const content = document.getElementById('externalConditionManagementContent');
        const toggleIcon = document.getElementById('externalConditionToggleIcon');
        const toggleButton = toggleIcon.parentElement;
        if (content.classList.contains('hidden')) {
          content.classList.remove('hidden');
          toggleIcon.setAttribute('data-lucide', 'chevron-down');
          toggleButton.innerHTML = `<i id="externalConditionToggleIcon" data-lucide="chevron-down" class="inline-block mr-2"></i>收合`;
        } else {
          content.classList.add('hidden');
          toggleIcon.setAttribute('data-lucide', 'chevron-right');
          toggleButton.innerHTML = `<i id="externalConditionToggleIcon" data-lucide="chevron-right" class="inline-block mr-2"></i>展開`;
        }
        lucide.createIcons();
        saveCollapseState();
      }

      function openModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
      }

      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.add('hidden');
        const inputs = modal.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
          if (input.type !== 'hidden') {
            input.value = '';
          }
        });
      }

      function escapeHtml(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
      }

      function exportToExcel() {
        if (trades.length === 0) {
          alert('目前沒有交易紀錄可供匯出。');
          return;
        }
        const exportData = trades.map(trade => ({
          "交易ID": trade.id,
          "報酬率 (%)": trade.returnRate,
          "部位金額": trade.position,
          "進場價格": trade.entryPrice,
          "最高價格": trade.highestPrice,
          "最低價格": trade.lowestPrice,
          "交易方向": trade.direction,
          "標的名稱": trade.assetName,
          "策略名稱": getStrategyName(trade.strategyId),
          "外部條件": getExternalConditionName(trade.externalConditionId),
          "開倉日": trade.openDate,
          "平倉日": trade.closeDate,
          "持倉天數": calculateHoldingDays(trade.openDate, trade.closeDate),
          "文字說明": trade.description,
          "圖片URL": trade.imageUrl
        }));
        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "交易紀錄");
        const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/octet-stream' });
        const link = document.createElement('a');
        const today = new Date().toISOString().split('T')[0];
        link.href = URL.createObjectURL(blob);
        link.download = `交易紀錄_${today}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      function calculateHoldingDays(openDate, closeDate) {
        if (openDate === '' && closeDate === '') return '';
        if (openDate === '' || closeDate === '') return '未平倉';
        const open = new Date(openDate);
        const close = new Date(closeDate);
        const diffTime = close - open;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        return diffDays >= 0 ? diffDays : '';
      }
      
      function importFromExcel(event) {
        const file = event.target.files[0];
        if (!file) {
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = e.target.result;
          let workbook;
          try {
            workbook = XLSX.read(data, { type: 'binary' });
          } catch (error) {
            alert('無法解析該文件。請確認文件為有效的Excel格式。');
            return;
          }
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const requiredFields = ["交易ID", "報酬率 (%)", "部位金額", "進場價格", "最高價格", "最低價格", "交易方向", "標的名稱", "策略名稱", "外部條件", "開倉日", "平倉日", "持倉天數", "文字說明", "圖片URL"];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
          if (jsonData.length === 0) {
            alert('Excel文件中沒有任何數據。');
            return;
          }
          const missingFields = requiredFields.filter(field => !(field in jsonData[0]));
          if (missingFields.length > 0) {
            alert(`缺少以下必要欄位：${missingFields.join(', ')}`);
            return;
          }
          const importedTrades = jsonData.map(item => {
            const strategy = strategies.find(s => s.name === item["策略名稱"]);
            const externalCondition = externalConditions.find(c => c.name === item["外部條件"]);
            if (!strategy) {
              alert(`策略名稱 "${item["策略名稱"]}" 不存在。請先新增該策略後再匯入。`);
              return null;
            }
            if (!externalCondition) {
              alert(`外部條件名稱 "${item["外部條件"]}" 不存在。請先新增該外部條件後再匯入。`);
              return null;
            }
            const newTradeId = nextTradeId++;
            let holdingDays = item["持倉天數"];
            if (holdingDays === '' || holdingDays === '未平倉') {
              holdingDays = '未平倉';
            }
            return {
              id: newTradeId,
              returnRate: item["報酬率 (%)"],
              position: item["部位金額"],
              entryPrice: item["進場價格"],
              highestPrice: item["最高價格"],
              lowestPrice: item["最低價格"],
              direction: item["交易方向"] || "多",
              assetName: item["標的名稱"],
              strategyId: strategy.id,
              externalConditionId: externalCondition.id,
              openDate: item["開倉日"],
              closeDate: item["平倉日"],
              description: item["文字說明"],
              imageUrl: item["圖片URL"]
            };
          }).filter(trade => trade !== null);
          if (importedTrades.length === 0) {
            alert('沒有有效的交易紀錄被匯入。');
            return;
          }
          trades = trades.concat(importedTrades);
          renderTrades();
          calculateStats();
          saveData();
          alert(`成功匯入 ${importedTrades.length} 筆交易紀錄。`);
          document.getElementById('importExcelInput').value = '';
        };
        reader.onerror = function() {
          alert('讀取文件時發生錯誤。');
        };
        reader.readAsBinaryString(file);
      }
      
      function exportStrategiesToExcel() {
        if (strategies.length === 0) {
          alert('目前沒有策略資料可供匯出。');
          return;
        }
        const exportData = strategies.map(strategy => ({
          "策略ID": strategy.id,
          "策略名稱": strategy.name,
          "描述": strategy.description
        }));
        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "策略管理");
        const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/octet-stream' });
        const link = document.createElement('a');
        const today = new Date().toISOString().split('T')[0];
        link.href = URL.createObjectURL(blob);
        link.download = `策略管理_${today}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      function importStrategiesFromExcel(event) {
        const file = event.target.files[0];
        if (!file) {
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = e.target.result;
          let workbook;
          try {
            workbook = XLSX.read(data, { type: 'binary' });
          } catch (error) {
            alert('無法解析該文件。請確認文件為有效的Excel格式。');
            return;
          }
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
          if (jsonData.length === 0) {
            alert('Excel文件中沒有任何數據。');
            return;
          }
          const requiredFields = ["策略ID", "策略名稱", "描述"];
          const missingFields = requiredFields.filter(field => !(field in jsonData[0]));
          if (missingFields.length > 0) {
            alert(`缺少以下必要欄位：${missingFields.join(', ')}`);
            return;
          }
          const importedStrategies = jsonData.map(item => {
            const name = item["策略名稱"].trim();
            const description = item["描述"].trim();
            const existingStrategy = strategies.find(s => s.name === name);
            if (existingStrategy) {
              alert(`策略名稱 "${name}" 已存在。請避免重複新增。`);
              return null;
            }
            const newStrategyId = nextTradeId++;
            return {
              id: newStrategyId,
              name: name,
              description: description
            };
          }).filter(strategy => strategy !== null);
          if (importedStrategies.length === 0) {
            alert('沒有有效的策略紀錄被匯入。');
            return;
          }
          strategies = strategies.concat(importedStrategies);
          renderStrategies();
          renderTrades();
          calculateStats();
          saveStrategies();
          saveData();
          alert(`成功匯入 ${importedStrategies.length} 筆策略紀錄。`);
          document.getElementById('importStrategiesInput').value = '';
        };
        reader.onerror = function() {
          alert('讀取文件時發生錯誤。');
        };
        reader.readAsBinaryString(file);
      }
      
      function exportExternalConditionsToExcel() {
        if (externalConditions.length === 0) {
          alert('目前沒有外部條件資料可供匯出。');
          return;
        }
        const exportData = externalConditions.map(condition => ({
          "外部條件ID": condition.id,
          "外部條件名稱": condition.name,
          "描述": condition.description
        }));
        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "外部條件管理");
        const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/octet-stream' });
        const link = document.createElement('a');
        const today = new Date().toISOString().split('T')[0];
        link.href = URL.createObjectURL(blob);
        link.download = `外部條件管理_${today}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      function importExternalConditionsFromExcel(event) {
        const file = event.target.files[0];
        if (!file) {
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = e.target.result;
          let workbook;
          try {
            workbook = XLSX.read(data, { type: 'binary' });
          } catch (error) {
            alert('無法解析該文件。請確認文件為有效的Excel格式。');
            return;
          }
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
          if (jsonData.length === 0) {
            alert('Excel文件中沒有任何數據。');
            return;
          }
          const requiredFields = ["外部條件ID", "外部條件名稱", "描述"];
          const missingFields = requiredFields.filter(field => !(field in jsonData[0]));
          if (missingFields.length > 0) {
            alert(`缺少以下必要欄位：${missingFields.join(', ')}`);
            return;
          }
          const importedExternalConditions = jsonData.map(item => {
            const name = item["外部條件名稱"].trim();
            const description = item["描述"].trim();
            const existingCondition = externalConditions.find(c => c.name === name);
            if (existingCondition) {
              alert(`外部條件名稱 "${name}" 已存在。請避免重複新增。`);
              return null;
            }
            const newConditionId = nextTradeId++;
            return {
              id: newConditionId,
              name: name,
              description: description
            };
          }).filter(condition => condition !== null);
          if (importedExternalConditions.length === 0) {
            alert('沒有有效的外部條件紀錄被匯入。');
            return;
          }
          externalConditions = externalConditions.concat(importedExternalConditions);
          renderExternalConditions();
          renderTrades();
          calculateStats();
          saveExternalConditions();
          saveData();
          alert(`成功匯入 ${importedExternalConditions.length} 筆外部條件紀錄。`);
          document.getElementById('importExternalConditionsInput').value = '';
        };
        reader.onerror = function() {
          alert('讀取文件時發生錯誤。');
        };
        reader.readAsBinaryString(file);
      }
    </script>
  </div>
</body>
</html>
