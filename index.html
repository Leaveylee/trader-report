<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易員報告書</title>
    
    <!-- PWA 相關設定 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFE4D6">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="交易員報告書">

    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans TC', sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #FFF3E6 0%, #FFE4D6 100%);
            padding: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 2rem;
            width: 90%;
            max-width: 800px; /* 調整寬度以適應表格 */
            margin: 0 auto;
            box-shadow: 0 8px 32px rgba(184, 134, 113, 0.1);
        }

        input, select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid rgba(184, 110, 82, 0.2);
            border-radius: 8px;
            background: white;
            color: #444;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #B86E52;
            box-shadow: 0 0 0 2px rgba(184, 110, 82, 0.1);
        }

        .button {
            background: linear-gradient(135deg, #E67E51 0%, #F1945E 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(230, 126, 81, 0.2);
        }

        .delete-button {
            color: #dc2626;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .delete-button:hover {
            color: #b91c1c;
        }

        /* 新增細線樣式 */
        .divider {
            border-bottom: 1px solid #e5e7eb; /* Tailwind 的 gray-200 */
            margin: 0.5rem 0;
        }

        /* 表格樣式調整 */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background-color: #f9fafb; /* Tailwind 的 gray-50 */
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1 class="text-2xl font-bold text-center mb-8 text-[#B86E52]">
            交易員報告書
        </h1>

        <!-- 分析結果區塊 -->
        <div class="bg-gray-50 p-4 rounded mb-6">
            <h2 class="text-lg font-medium text-gray-700 mb-4">分析結果: 全部交易策略</h2>
            
            <!-- 報告書的結論 -->
            <div class="space-y-4">
                <!-- 第一行：交易數、勝率、風報比 -->
                <div class="flex justify-between font-bold text-lg">
                    <div class="flex-1 text-center">
                        <span class="text-gray-600">交易數：</span>
                        <span id="totalTrades" class="font-medium">0</span>
                    </div>
                    <div class="flex-1 text-center">
                        <span class="text-gray-600">勝率：</span>
                        <span id="winRate" class="font-medium">0%</span>
                    </div>
                    <div class="flex-1 text-center">
                        <span class="text-gray-600">風報比：</span>
                        <span id="riskRewardRatio" class="font-medium">0</span>
                    </div>
                </div>

                <!-- 第二行：期望值 -->
                <div class="flex justify-between font-bold text-lg">
                    <div class="flex-1 text-center">
                        <span class="text-gray-700">期望值：</span>
                        <span id="expectedValue" class="font-bold text-lg">
                            0.0%
                        </span>
                    </div>
                </div>

                <!-- 第三行：總報酬 -->
                <div class="flex justify-between font-bold text-lg">
                    <div class="flex-1 text-center">
                        <span class="text-gray-700">總報酬：</span>
                        <span id="totalReturn" class="font-bold text-lg">
                            0%
                        </span>
                    </div>
                </div>
            </div>

            <!-- 損益統計 -->
            <div class="mt-6">
                <h3 class="text-md font-medium text-gray-700 mb-3">
                    損益統計
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <!-- 第一行：平均獲利、平均虧損 -->
                    <div class="flex justify-between">
                        <span class="text-gray-600">平均獲利：</span>
                        <span id="avgWin" class="font-medium">+0 (+0.00%)</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">平均虧損：</span>
                        <span id="avgLoss" class="font-medium">-0 (-0.00%)</span>
                    </div>
                    <!-- 分隔線 -->
                    <div class="col-span-2 divider"></div>
                    <!-- 第二行：最大獲利、最大虧損 -->
                    <div class="flex justify-between">
                        <span class="text-gray-600">最大獲利：</span>
                        <span id="maxWin" class="font-medium">+0 (+0.00%)</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">最大虧損：</span>
                        <span id="maxLoss" class="font-medium">-0 (-0.00%)</span>
                    </div>
                    <!-- 分隔線 -->
                    <div class="col-span-2 divider"></div>
                </div>
            </div>
        </div>

        <!-- 平均部位輸入 -->
        <div class="mb-6">
            <label for="averagePosition" class="block text-sm font-medium text-gray-700 mb-2">
                平均部位金額（選填）
            </label>
            <input
                type="number"
                id="averagePosition"
                placeholder="輸入平均部位金額"
                class="w-full p-2 border rounded"
                onchange="calculateStats()"
            >
            <div class="text-sm text-gray-500 mt-1">
                若填寫此欄位，將會計算實際金額的獲利/虧損和期望值
            </div>
        </div>

        <!-- 交易紀錄區域 -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-medium text-gray-700">交易紀錄</h2>
                <button class="button" onclick="addTrade()">
                    添加交易
                </button>
            </div>
            <div class="text-sm text-gray-600 mb-2">
                請輸入交易報酬率（例如：+6.66、-2.92）、標的名稱、策略名稱
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded">
                    <thead>
                        <tr>
                            <th class="px-4 py-2">交易</th>
                            <th class="px-4 py-2">報酬率 (%)</th>
                            <th class="px-4 py-2">標的名稱</th>
                            <th class="px-4 py-2">策略名稱</th>
                            <th class="px-4 py-2">操作</th>
                        </tr>
                    </thead>
                    <tbody id="tradesList">
                        <!-- 交易記錄將在這裡動態添加為表格行 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 可選：清除數據按鈕 -->
        <!-- <button class="button mt-4 bg-red-500" onclick="clearData()">
            清除所有數據
        </button> -->

        <script>
            // 交易記錄列表
            let trades = [{ returnRate: '', assetName: '', strategyName: '' }];
            let tradesList = document.getElementById('tradesList');

            // 工具函數：格式化數字，每三位加上逗號，根據是否為金額決定是否顯示符號
            function formatNumber(value, isMoneyAmount = false, decimalPlaces = 2) {
                const number = parseFloat(value);
                if (isNaN(number)) return '0';
                
                if (isMoneyAmount) {
                    return number >= 0 ? 
                        `+${number.toLocaleString(undefined, {minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces})}` : 
                        `-${Math.abs(number).toLocaleString(undefined, {minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces})}`;
                }
                return number >= 0 ? 
                    `+${number.toLocaleString(undefined, {minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces})}` : 
                    `-${Math.abs(number).toLocaleString(undefined, {minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces})}`;
            }

            // 新增工具函數：格式化數字，不帶 "+" 符號，無小數點
            function formatNumberNoSign(value, decimalPlaces = 2) {
                const number = parseFloat(value);
                if (isNaN(number)) return '0';
                return number.toLocaleString(undefined, {minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces});
            }

            // 新增工具函數：格式化交易數，不帶 "+" 符號，無小數點
            function formatTradeCount(value) {
                const number = parseInt(value, 10);
                if (isNaN(number)) return '0';
                return number.toLocaleString();
            }

            // 保存數據到 localStorage
            function saveData() {
                localStorage.setItem('trades', JSON.stringify(trades));
                const averagePosition = document.getElementById('averagePosition').value;
                localStorage.setItem('averagePosition', averagePosition);
            }

            // 從 localStorage 加載數據
            function loadData() {
                const savedTrades = JSON.parse(localStorage.getItem('trades'));
                const savedAveragePosition = localStorage.getItem('averagePosition');
                
                if (savedTrades && Array.isArray(savedTrades)) {
                    trades = savedTrades;
                }
                
                if (savedAveragePosition !== null) {
                    document.getElementById('averagePosition').value = savedAveragePosition;
                }
                
                renderTrades();
                calculateStats();
            }

            // 渲染交易記錄
            function renderTrades() {
                // 反轉交易列表以顯示最新交易在最上方
                const reversedTrades = trades.slice().reverse();

                tradesList.innerHTML = reversedTrades.map((trade, reversedIndex) => {
                    const actualIndex = trades.length - 1 - reversedIndex;
                    return `
                        <tr>
                            <td class="border px-4 py-2">交易 ${actualIndex + 1}</td>
                            <td class="border px-4 py-2">
                                <input
                                    type="text"
                                    value="${trade.returnRate}"
                                    oninput="handleTradeChange(${actualIndex}, 'returnRate', this.value)"
                                    class="w-full p-1 border rounded"
                                    placeholder="+6.66 或 -2.92"
                                >
                            </td>
                            <td class="border px-4 py-2">
                                <input
                                    type="text"
                                    value="${trade.assetName}"
                                    oninput="handleTradeChange(${actualIndex}, 'assetName', this.value)"
                                    class="w-full p-1 border rounded"
                                    placeholder="輸入標的名稱"
                                >
                            </td>
                            <td class="border px-4 py-2">
                                <input
                                    type="text"
                                    value="${trade.strategyName}"
                                    oninput="handleTradeChange(${actualIndex}, 'strategyName', this.value)"
                                    class="w-full p-1 border rounded"
                                    placeholder="輸入策略名稱"
                                >
                            </td>
                            <td class="border px-4 py-2 text-center">
                                ${trades.length > 1 ? `
                                    <button onclick="removeTrade(${actualIndex})" class="delete-button">
                                        <i data-lucide="trash-2"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // 重新初始化 Lucide 圖標
                lucide.createIcons();

                // 添加按鍵事件監聽器
                const tradeInputs = document.querySelectorAll('.trade-input');
                // 在表格形式下，按鍵事件已由各個輸入框分別處理，因此不需要額外處理
            }

            // 處理交易數據變更
            function handleTradeChange(index, field, value) {
                const cleanedValue = value.replace('%', '').trim();
                
                if (field === 'returnRate') {
                    if (cleanedValue === '' || isNaN(cleanedValue)) {
                        // 處理無效輸入（例如：清空該交易的回報率）
                        trades[index].returnRate = '';
                    } else {
                        trades[index].returnRate = cleanedValue;
                    }
                } else if (field === 'assetName') {
                    trades[index].assetName = value.trim();
                } else if (field === 'strategyName') {
                    trades[index].strategyName = value.trim();
                }
                
                // 計算統計數據和保存
                calculateStats();
                saveData(); // 保存數據
            }

            // 添加交易記錄
            function addTrade() {
                trades.push({ returnRate: '', assetName: '', strategyName: '' });
                renderTrades();
                calculateStats();
                saveData(); // 保存數據

                // 聚焦到新欄框
                setTimeout(() => {
                    const newIndex = trades.length - 1;
                    const newInput = document.querySelector(`tr:last-child input[type="text"]`);
                    if (newInput) {
                        newInput.focus(); // 聚焦到第一個輸入框（報酬率）在新交易
                    }
                }, 100);
            }

            // 刪除交易記錄
            function removeTrade(index) {
                trades = trades.filter((_, i) => i !== index);
                if (trades.length === 0) {
                    trades.push({ returnRate: '', assetName: '', strategyName: '' });
                }
                renderTrades();
                calculateStats();
                saveData(); // 保存數據
            }

            // 計算統計數據
            function calculateStats() {
                const validTrades = trades.filter(trade => 
                    trade.returnRate !== '' && !isNaN(parseFloat(trade.returnRate))
                );
                
                if (validTrades.length === 0) {
                    // 重置統計數據
                    document.getElementById('totalTrades').textContent = '0';
                    document.getElementById('winRate').textContent = '0%';
                    document.getElementById('riskRewardRatio').textContent = '0';
                    document.getElementById('avgWin').textContent = '+0 (+0.00%)';
                    document.getElementById('avgLoss').textContent = '-0 (-0.00%)';
                    document.getElementById('maxWin').textContent = '+0 (+0.00%)';
                    document.getElementById('maxLoss').textContent = '-0 (-0.00%)';
                    document.getElementById('expectedValue').textContent = '0.0%';
                    document.getElementById('totalReturn').textContent = '0%';
                    
                    // 移除顏色類別
                    removeColorClasses(['expectedValue', 'totalReturn']);
                    
                    return;
                }

                const results = validTrades.map(trade => parseFloat(trade.returnRate));
                const wins = results.filter(result => result > 0);
                const losses = results.filter(result => result < 0);

                const winRate = (wins.length / results.length) * 100;
                const avgWinRate = wins.length > 0 ? wins.reduce((a, b) => a + b) / wins.length : 0;
                const avgLossRate = losses.length > 0 ? losses.reduce((a, b) => a + b) / losses.length : 0; // 保留負號
                const maxWinRate = wins.length > 0 ? Math.max(...wins) : 0;
                const maxLossRate = losses.length > 0 ? Math.min(...losses) : 0; // 保留負號
                const riskRewardRatio = avgLossRate !== 0 ? (avgWinRate / Math.abs(avgLossRate)) : 0;
                const expectedReturnRate = (winRate / 100 * avgWinRate) - ((100 - winRate) / 100 * Math.abs(avgLossRate));
                const totalReturnRate = results.reduce((sum, rate) => sum + rate, 0);

                // 獲取平均部位金額
                const averagePosition = parseFloat(document.getElementById('averagePosition').value);

                // 計算金額
                const expectedValueAmount = (expectedReturnRate / 100) * averagePosition;
                const totalReturnAmount = (totalReturnRate / 100) * averagePosition;

                // 更新基本統計數據
                document.getElementById('totalTrades').textContent = formatTradeCount(results.length);
                document.getElementById('winRate').textContent = `${formatNumber(winRate.toFixed(2))}%`;
                // 使用 formatNumberNoSign 以移除 "+" 符號
                document.getElementById('riskRewardRatio').textContent = formatNumberNoSign(riskRewardRatio.toFixed(2));

                // 更新次級報告欄位
                document.getElementById('avgWin').textContent = averagePosition && !isNaN(averagePosition) && averagePosition > 0 
                    ? `${formatNumber((avgWinRate / 100) * averagePosition, true, 0)} (${formatNumber(avgWinRate, false, 2)}%)` 
                    : `(${formatNumber(avgWinRate, false, 2)}%)`;
                document.getElementById('avgLoss').textContent = averagePosition && !isNaN(averagePosition) && averagePosition > 0 
                    ? `${formatNumber((avgLossRate / 100) * averagePosition, true, 0)} (${formatNumber(avgLossRate, false, 2)}%)` 
                    : `(${formatNumber(avgLossRate, false, 2)}%)`;
                document.getElementById('maxWin').textContent = averagePosition && !isNaN(averagePosition) && averagePosition > 0 
                    ? `${formatNumber((maxWinRate / 100) * averagePosition, true, 0)} (${formatNumber(maxWinRate, false, 2)}%)` 
                    : `(${formatNumber(maxWinRate, false, 2)}%)`;
                document.getElementById('maxLoss').textContent = averagePosition && !isNaN(averagePosition) && averagePosition > 0 
                    ? `${formatNumber((maxLossRate / 100) * averagePosition, true, 0)} (${formatNumber(maxLossRate, false, 2)}%)` 
                    : `(${formatNumber(maxLossRate, false, 2)}%)`;

                // 更新 "期望值" 顯示及顏色，僅顯示到小數點第一位
                const expectedValueElem = document.getElementById('expectedValue');
                if (averagePosition && !isNaN(averagePosition) && averagePosition > 0) {
                    expectedValueElem.textContent = `${formatNumber(expectedValueAmount.toFixed(1), true, 1)} (${formatNumber(expectedReturnRate.toFixed(2), false, 2)}%)`;
                } else {
                    expectedValueElem.textContent = `(${formatNumber(expectedReturnRate.toFixed(2), false, 2)}%)`;
                }

                // 更新顏色
                if (expectedReturnRate > 0) {
                    expectedValueElem.classList.add('text-red-500');
                    expectedValueElem.classList.remove('text-green-500');
                } else if (expectedReturnRate < 0) {
                    expectedValueElem.classList.add('text-green-500');
                    expectedValueElem.classList.remove('text-red-500');
                } else {
                    expectedValueElem.classList.remove('text-red-500', 'text-green-500');
                }

                // 更新 "總報酬" 顯示及顏色，金額無小數點，百分比顯示兩位小數
                const totalReturnElem = document.getElementById('totalReturn');
                if (averagePosition && !isNaN(averagePosition) && averagePosition > 0) {
                    totalReturnElem.textContent = `${formatNumber(totalReturnAmount, true, 0)} (${formatNumber(totalReturnRate, false, 2)}%)`;
                } else {
                    totalReturnElem.textContent = `(${formatNumber(totalReturnRate, false, 2)}%)`;
                }

                // 更新顏色
                if (totalReturnRate > 0) {
                    totalReturnElem.classList.add('text-red-500');
                    totalReturnElem.classList.remove('text-green-500');
                } else if (totalReturnRate < 0) {
                    totalReturnElem.classList.add('text-green-500');
                    totalReturnElem.classList.remove('text-red-500');
                } else {
                    totalReturnElem.classList.remove('text-red-500', 'text-green-500');
                }
            }

            // 移除特定元素的顏色類別
            function removeColorClasses(elementIds) {
                elementIds.forEach(id => {
                    const elem = document.getElementById(id);
                    elem.classList.remove('text-red-500', 'text-green-500');
                });
            }

            // 初始化
            renderTrades();
            loadData(); // 載入數據

            // 監聽平均部位金額的變化以保存數據
            document.getElementById('averagePosition').addEventListener('change', function() {
                calculateStats();
                saveData(); // 保存數據
            });

            // 可選：添加清除數據的功能
            // 若需要添加清除數據的按鈕，取消以下註解並在適當位置添加按鈕
            /*
            function clearData() {
                if (confirm('您確定要清除所有數據嗎？此操作無法撤銷。')) {
                    localStorage.removeItem('trades');
                    localStorage.removeItem('averagePosition');
                    trades = [{ returnRate: '', assetName: '', strategyName: '' }];
                    document.getElementById('averagePosition').value = '';
                    renderTrades();
                    calculateStats();
                }
            }
            */
        </script>
    </div>
</body>
</html>
