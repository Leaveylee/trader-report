<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>交易員報告書</title>
  
  <!-- PWA 相關設定 -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFE4D6">
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="交易員報告書">

  <!-- 引入 Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入 Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- 引入 SheetJS (xlsx) CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Noto Sans TC', sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #FFF3E6 0%, #FFE4D6 100%);
      padding: 20px;
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      padding: 2rem;
      width: 90%;
      max-width: 1200px;
      margin: 0 auto;
      box-shadow: 0 8px 32px rgba(184, 134, 113, 0.1);
    }
    input, select, textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid rgba(184, 110, 82, 0.2);
      border-radius: 8px;
      background: white;
      color: #444;
      transition: all 0.3s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #B86E52;
      box-shadow: 0 0 0 2px rgba(184, 110, 82, 0.1);
    }
    .button {
      background: linear-gradient(135deg, #E67E51 0%, #F1945E 100%);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(230, 126, 81, 0.2);
    }
    .delete-button {
      color: #dc2626;
      background: none;
      border: none;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .delete-button:hover {
      color: #b91c1c;
    }
    .divider {
      border-bottom: 1px solid #e5e7eb;
      margin: 0.5rem 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      white-space: normal;
      word-break: break-word;
    }
    th {
      background-color: #f9fafb;
      font-weight: 600;
    }
    .modal {
      display: flex;
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    .hidden {
      display: none;
    }
    .scrollbar-top {
      height: 16px;
      margin-bottom: 8px;
    }
    #topScrollbarContent {
      height: 1px;
    }
    #topScrollbarContent::after {
      content: "";
      display: block;
      width: 100%;
      height: 1px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1 class="text-2xl font-bold text-center mb-8 text-[#B86E52]">交易員報告書</h1>

    <!-- 篩選條件 -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-2">篩選條件</label>
      <div class="flex space-x-4">
        <div class="flex-1">
          <label for="strategyFilter" class="block text-sm font-medium text-gray-700 mb-1">篩選策略</label>
          <select id="strategyFilter" class="w-full p-2 border rounded" onchange="applyFilters()">
            <option value="">全部策略</option>
          </select>
        </div>
        <div class="flex-1">
          <label for="externalConditionFilter" class="block text-sm font-medium text-gray-700 mb-1">篩選外部條件</label>
          <select id="externalConditionFilter" class="w-full p-2 border rounded" onchange="applyFilters()">
            <option value="">全部外部條件</option>
          </select>
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-1">篩選日期範圍</label>
          <div class="flex space-x-2">
            <input type="date" id="startDateFilter" class="w-1/2 p-2 border rounded" onchange="applyFilters()" placeholder="開始日期">
            <input type="date" id="endDateFilter" class="w-1/2 p-2 border rounded" onchange="applyFilters()" placeholder="結束日期">
          </div>
          <div class="flex space-x-2 mt-2">
            <button class="button" onclick="shiftEndDate(-1)">前一天</button>
            <button class="button" onclick="shiftEndDate(1)">後一天</button>
            <button class="button" onclick="clearDateFilters()">清除日期篩選</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 總操作資金輸入 -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-2" for="totalOperatingCapital">總操作資金</label>
      <input type="number" id="totalOperatingCapital" class="w-full p-2 border rounded" placeholder="請輸入總操作資金" oninput="calculateStats(); saveTotalOperatingCapital()" onchange="calculateStats(); saveTotalOperatingCapital()">
      <div class="text-sm text-gray-500 mt-1">此數值將用於計算資金績效與未平倉占比。</div>
    </div>

    <!-- 分析結果區塊 -->
    <div class="bg-gray-50 p-4 rounded mb-6">
      <h2 class="text-lg font-medium text-gray-700 mb-4">分析結果</h2>
      <div class="space-y-4">
        <div class="flex justify-between font-bold text-lg">
          <div class="flex-1 text-center">
            <span class="text-gray-600">交易數：</span>
            <span id="totalTrades" class="font-medium">0</span>
          </div>
          <div class="flex-1 text-center">
            <span class="text-gray-600">勝率：</span>
            <span id="winRate" class="font-medium">0% (0勝0敗)</span>
          </div>
          <div class="flex-1 text-center">
            <span class="text-gray-600">風報比：</span>
            <span id="riskRewardRatio" class="font-medium">0</span>
          </div>
        </div>
        <div class="flex justify-between font-bold text-lg">
          <div class="flex-1 text-center">
            <span class="text-gray-700">期望值：</span>
            <!-- 顯示期望值的金額及佔總操作資金百分比 -->
            <span id="expectedValue" class="font-bold text-lg">0</span>
          </div>
        </div>
        <div class="flex justify-between font-bold text-lg">
          <div class="flex-1 text-center">
            <span class="text-gray-700">總報酬：</span>
            <!-- 顯示總報酬的金額及佔總操作資金百分比 -->
            <span id="totalReturn" class="font-bold text-lg">0</span>
          </div>
        </div>
      </div>
      <div class="mt-6">
        <h3 class="text-md font-medium text-gray-700 mb-3">損益統計</h3>
        <div class="grid grid-cols-2 gap-4">
          <div class="flex justify-between">
            <span class="text-gray-600">平均獲利：</span>
            <!-- 顯示平均獲利金額及佔總操作資金百分比 -->
            <span id="avgWin" class="font-medium">0</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">平均虧損：</span>
            <!-- 顯示平均虧損金額及佔總操作資金百分比 -->
            <span id="avgLoss" class="font-medium">0</span>
          </div>
          <div class="col-span-2 divider"></div>
          <div class="flex justify-between">
            <span class="text-gray-600">最大獲利：</span>
            <!-- 顯示最大獲利金額及佔總操作資金百分比 -->
            <span id="maxWin" class="font-medium">0</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">最大虧損：</span>
            <!-- 顯示最大虧損金額及佔總操作資金百分比 -->
            <span id="maxLoss" class="font-medium">0</span>
          </div>
          <div class="col-span-2 divider"></div>
        </div>
      </div>
    </div>

    <!-- 部位統計區塊 -->
    <div id="positionStats" class="bg-gray-50 p-4 rounded mb-6">
      <h2 class="text-lg font-medium text-gray-700 mb-4">部位統計</h2>
      <div class="grid grid-cols-2 gap-4">
        <div class="flex justify-between">
          <span class="text-gray-600">獲利交易的平均部位：</span>
          <span id="avgWinningPosition" class="font-medium">0</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">虧損交易的平均部位：</span>
          <span id="avgLosingPosition" class="font-medium">0</span>
        </div>
      </div>
    </div>

    <!-- 未平倉統計區塊 -->
    <div id="unclosedStats" class="bg-gray-50 p-4 rounded mb-6">
      <h2 class="text-lg font-medium text-gray-700 mb-4">未平倉統計</h2>
      <div class="grid grid-cols-2 gap-4">
        <div class="flex justify-between">
          <span class="text-gray-600">未平倉交易數量：</span>
          <span id="unclosedTradeCount" class="font-medium">0</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">未平倉部位總額：</span>
          <span id="unclosedPositionTotal" class="font-medium">$0 (0%)</span>
        </div>
      </div>
    </div>

    <!-- 資金績效統計區塊 -->
    <div id="capitalStats" class="bg-gray-50 p-4 rounded mb-6">
      <h2 class="text-lg font-medium text-gray-700 mb-4">資金績效統計</h2>
      <div class="grid grid-cols-2 gap-4">
        <div class="flex justify-between">
          <span class="text-gray-600">總資金回報率 (ROI)：</span>
          <span id="roi" class="font-medium">0%</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">自由資金：</span>
          <span id="freeCapital" class="font-medium">$0 (0%)</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">占用資金：</span>
          <span id="capitalUsed" class="font-medium">$0 (0%)</span>
        </div>
      </div>
    </div>

    <!-- 策略管理區塊 -->
    <div class="mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-medium text-gray-700">策略管理</h2>
        <div class="flex space-x-2">
          <button class="button" onclick="toggleStrategyManagement()">
            <i id="strategyToggleIcon" data-lucide="chevron-down" class="inline-block mr-2"></i>
            收合
          </button>
          <button class="button" onclick="openAddStrategyModal()">新增</button>
          <button class="button" onclick="exportStrategiesToExcel()">匯出</button>
          <button class="button" onclick="document.getElementById('importStrategiesInput').click()">匯入</button>
          <input type="file" id="importStrategiesInput" accept=".xlsx, .xls" class="hidden" onchange="importStrategiesFromExcel(event)">
        </div>
      </div>
      <div id="strategyManagementContent" class="overflow-x-auto">
        <table class="min-w-full bg-white rounded">
          <thead>
            <tr>
              <th class="px-4 py-2 min-w-[150px]">策略名稱</th>
              <th class="px-4 py-2 min-w-[200px]">描述</th>
              <th class="px-4 py-2">操作</th>
            </tr>
          </thead>
          <tbody id="strategiesList">
            <!-- 策略記錄 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- 外部條件管理區塊 -->
    <div class="mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-medium text-gray-700">外部條件管理</h2>
        <div class="flex space-x-2">
          <button class="button" onclick="toggleExternalConditionManagement()">
            <i id="externalConditionToggleIcon" data-lucide="chevron-down" class="inline-block mr-2"></i>
            收合
          </button>
          <button class="button" onclick="openAddExternalConditionModal()">新增</button>
          <button class="button" onclick="exportExternalConditionsToExcel()">匯出</button>
          <button class="button" onclick="document.getElementById('importExternalConditionsInput').click()">匯入</button>
          <input type="file" id="importExternalConditionsInput" accept=".xlsx, .xls" class="hidden" onchange="importExternalConditionsFromExcel(event)">
        </div>
      </div>
      <div id="externalConditionManagementContent" class="overflow-x-auto">
        <table class="min-w-full bg-white rounded">
          <thead>
            <tr>
              <th class="px-4 py-2 min-w-[150px]">外部條件名稱</th>
              <th class="px-4 py-2 min-w-[200px]">描述</th>
              <th class="px-4 py-2">操作</th>
            </tr>
          </thead>
          <tbody id="externalConditionsList">
            <!-- 外部條件記錄 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- 新增策略模態框 -->
    <div id="addStrategyModal" class="modal hidden">
      <div class="bg-white p-6 rounded-lg w-96">
        <h3 class="text-lg font-medium mb-4">新增</h3>
        <label class="block text-sm font-medium text-gray-700 mb-2" for="newStrategyName">策略名稱</label>
        <input type="text" id="newStrategyName" class="w-full p-2 border rounded mb-4" placeholder="輸入策略名稱">
        <label class="block text-sm font-medium text-gray-700 mb-2" for="newStrategyDescription">描述</label>
        <textarea id="newStrategyDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入策略描述"></textarea>
        <div class="flex justify-end">
          <button class="button mr-2" onclick="closeAddStrategyModal()">取消</button>
          <button class="button" onclick="addStrategy()">新增</button>
        </div>
      </div>
    </div>

    <!-- 編輯策略模態框 -->
    <div id="editStrategyModal" class="modal hidden">
      <div class="bg-white p-6 rounded-lg w-96">
        <h3 class="text-lg font-medium mb-4">編輯策略</h3>
        <input type="hidden" id="editStrategyId">
        <label class="block text-sm font-medium text-gray-700 mb-2" for="editStrategyName">策略名稱</label>
        <input type="text" id="editStrategyName" class="w-full p-2 border rounded mb-4" placeholder="輸入策略名稱">
        <label class="block text-sm font-medium text-gray-700 mb-2" for="editStrategyDescription">描述</label>
        <textarea id="editStrategyDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入策略描述"></textarea>
        <div class="flex justify-end">
          <button class="button mr-2" onclick="closeEditStrategyModal()">取消</button>
          <button class="button" onclick="updateStrategy()">更新</button>
        </div>
      </div>
    </div>

    <!-- 新增外部條件模態框 -->
    <div id="addExternalConditionModal" class="modal hidden">
      <div class="bg-white p-6 rounded-lg w-96">
        <h3 class="text-lg font-medium mb-4">新增</h3>
        <label class="block text-sm font-medium text-gray-700 mb-2" for="newExternalConditionName">外部條件名稱</label>
        <input type="text" id="newExternalConditionName" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件名稱">
        <label class="block text-sm font-medium text-gray-700 mb-2" for="newExternalConditionDescription">描述</label>
        <textarea id="newExternalConditionDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件描述"></textarea>
        <div class="flex justify-end">
          <button class="button mr-2" onclick="closeAddExternalConditionModal()">取消</button>
          <button class="button" onclick="addExternalCondition()">新增</button>
        </div>
      </div>
    </div>

    <!-- 編輯外部條件模態框 -->
    <div id="editExternalConditionModal" class="modal hidden">
      <div class="bg-white p-6 rounded-lg w-96">
        <h3 class="text-lg font-medium mb-4">編輯外部條件</h3>
        <input type="hidden" id="editExternalConditionId">
        <label class="block text-sm font-medium text-gray-700 mb-2" for="editExternalConditionName">外部條件名稱</label>
        <input type="text" id="editExternalConditionName" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件名稱">
        <label class="block text-sm font-medium text-gray-700 mb-2" for="editExternalConditionDescription">描述</label>
        <textarea id="editExternalConditionDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件描述"></textarea>
        <div class="flex justify-end">
          <button class="button mr-2" onclick="closeEditExternalConditionModal()">取消</button>
          <button class="button" onclick="updateExternalCondition()">更新</button>
        </div>
      </div>
    </div>

    <!-- 交易記錄區塊 -->
    <div class="mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-medium text-gray-700">交易紀錄</h2>
        <div class="flex space-x-2">
          <button class="button" onclick="addTrade()">添加交易</button>
          <button class="button" onclick="exportToExcel()">匯出</button>
          <button class="button" onclick="document.getElementById('importExcelInput').click()">匯入</button>
          <input type="file" id="importExcelInput" accept=".xlsx, .xls" class="hidden" onchange="importFromExcel(event)">
        </div>
      </div>
      <div class="text-sm text-gray-600 mb-2">
        請輸入交易報酬率（例如：+6.66、-2.92）、部位金額、標的名稱、策略名稱、外部條件、開倉日和平倉日
      </div>
      <div class="relative">
        <div class="overflow-x-auto scrollbar-top" id="topScrollbar">
          <div id="topScrollbarContent"></div>
        </div>
        <div class="overflow-x-auto" id="bottomScrollbar">
          <table class="min-w-full bg-white rounded">
            <thead>
              <tr>
                <th class="px-4 py-2 min-w-[80px]">交易</th>
                <th class="px-4 py-2 min-w-[100px]">開倉日</th>
                <th class="px-4 py-2 min-w-[100px]">平倉日</th>
                <th class="px-4 py-2 min-w-[100px]">持倉天數</th>
                <th class="px-4 py-2 min-w-[100px]">報酬率 (%)</th>
                <th class="px-4 py-2 min-w-[100px]">部位金額</th>
                <th class="px-4 py-2 min-w-[150px]">標的名稱</th>
                <th class="px-4 py-2 min-w-[150px]">策略名稱</th>
                <th class="px-4 py-2 min-w-[150px]">外部條件</th>
                <th class="px-4 py-2 min-w-[200px]">文字說明</th>
                <th class="px-4 py-2 min-w-[200px]">圖片</th>
                <th class="px-4 py-2 min-w-[80px]">操作</th>
              </tr>
            </thead>
            <tbody id="tradesList">
              <!-- 交易記錄 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // 策略列表
      let strategies = [{ id: 1, name: '默認策略', description: '這是默認策略' }];
      // 外部條件列表
      let externalConditions = [{ id: 1, name: '默認外部條件', description: '這是默認外部條件' }];
      // 交易記錄列表
      let trades = [];
      // 當前篩選條件
      let selectedStrategyFilter = null;
      let selectedExternalConditionFilter = null;
      let selectedStartDateFilter = null;
      let selectedEndDateFilter = null;
      // 全局變數：下一個交易ID
      let nextTradeId = 1;

      function formatNumber(value, isMoneyAmount = false, decimalPlaces = 2) {
        const number = parseFloat(value);
        if (isNaN(number)) return '0';
        if (isMoneyAmount) {
          return number >= 0 ? `+${number.toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces })}` 
                            : `-${Math.abs(number).toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces })}`;
        }
        return number >= 0 ? `+${number.toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces })}` 
                          : `-${Math.abs(number).toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces })}`;
      }

      function formatNumberNoSign(value, decimalPlaces = 2) {
        const number = parseFloat(value);
        if (isNaN(number)) return '0';
        return number.toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces });
      }

      function formatTradeCount(value) {
        const number = parseInt(value, 10);
        if (isNaN(number)) return '0';
        return number.toLocaleString();
      }

      // 格式化金額 (使用 $ 符號)
      function formatMoney(value, decimalPlaces = 0) {
        const number = parseFloat(value);
        if (isNaN(number)) return '$0';
        return number >= 0 ? `$${number.toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces })}` 
                           : `-$${Math.abs(number).toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces })}`;
      }

      function saveData() {
        localStorage.setItem('trades', JSON.stringify(trades));
        saveStrategies();
        saveExternalConditions();
        saveCollapseState();
      }

      function saveStrategies() {
        localStorage.setItem('strategies', JSON.stringify(strategies));
      }

      function saveExternalConditions() {
        localStorage.setItem('externalConditions', JSON.stringify(externalConditions));
      }

      function saveCollapseState() {
        const strategyCollapsed = document.getElementById('strategyManagementContent').classList.contains('hidden');
        const externalConditionCollapsed = document.getElementById('externalConditionManagementContent').classList.contains('hidden');
        localStorage.setItem('strategyManagementCollapsed', strategyCollapsed);
        localStorage.setItem('externalConditionManagementCollapsed', externalConditionCollapsed);
      }

      // 保存總操作資金到 localStorage
      function saveTotalOperatingCapital() {
        const opCap = document.getElementById('totalOperatingCapital').value;
        localStorage.setItem('totalOperatingCapital', opCap);
      }

      // 載入總操作資金
      function loadTotalOperatingCapital() {
        const opCap = localStorage.getItem('totalOperatingCapital');
        if (opCap !== null) {
          document.getElementById('totalOperatingCapital').value = opCap;
        }
      }

      function loadStrategies() {
        const savedStrategies = JSON.parse(localStorage.getItem('strategies'));
        if (savedStrategies && Array.isArray(savedStrategies)) {
          strategies = savedStrategies;
        } else {
          strategies = [{ id: 1, name: '默認策略', description: '這是默認策略' }];
          saveStrategies();
        }
        const maxStrategyId = strategies.reduce((max, strategy) => strategy.id > max ? strategy.id : max, 0);
        if (maxStrategyId >= nextTradeId) {
          nextTradeId = maxStrategyId + 1;
        }
      }

      function loadExternalConditions() {
        const savedExternalConditions = JSON.parse(localStorage.getItem('externalConditions'));
        if (savedExternalConditions && Array.isArray(savedExternalConditions)) {
          externalConditions = savedExternalConditions;
        } else {
          externalConditions = [{ id: 1, name: '默認外部條件', description: '這是默認外部條件' }];
          saveExternalConditions();
        }
        const maxConditionId = externalConditions.reduce((max, condition) => condition.id > max ? condition.id : max, 0);
        if (maxConditionId >= nextTradeId) {
          nextTradeId = maxConditionId + 1;
        }
      }

      function loadData() {
        const savedTrades = JSON.parse(localStorage.getItem('trades'));
        const strategyManagementCollapsed = localStorage.getItem('strategyManagementCollapsed') === 'true';
        const externalConditionManagementCollapsed = localStorage.getItem('externalConditionManagementCollapsed') === 'true';
        
        if (savedTrades && Array.isArray(savedTrades)) {
          trades = savedTrades.map(trade => {
            if (!trade.id) {
              trade.id = nextTradeId++;
            } else {
              if (trade.id >= nextTradeId) {
                nextTradeId = trade.id + 1;
              }
            }
            if (!trade.description) trade.description = '';
            if (!trade.imageUrl) trade.imageUrl = '';
            if (typeof trade.position === 'undefined') trade.position = '';
            return trade;
          });
        }
        if (trades.length === 0) {
          trades.push({ id: nextTradeId++, returnRate: '', position: '', assetName: '', strategyId: null, externalConditionId: null, openDate: '', closeDate: '', description: '', imageUrl: '' });
        }
        selectedStrategyFilter = null;
        selectedExternalConditionFilter = null;
        selectedStartDateFilter = null;
        selectedEndDateFilter = null;
        document.getElementById('strategyFilter').value = '';
        document.getElementById('externalConditionFilter').value = '';
        document.getElementById('startDateFilter').value = '';
        document.getElementById('endDateFilter').value = '';
        renderStrategies();
        renderExternalConditions();
        renderTrades();
        loadTotalOperatingCapital(); // 先載入總操作資金
        calculateStats();
        applySavedCollapseState(strategyManagementCollapsed, externalConditionManagementCollapsed);
      }

      function applySavedCollapseState(strategyCollapsed, externalConditionCollapsed) {
        if (strategyCollapsed) {
          document.getElementById('strategyManagementContent').classList.add('hidden');
          document.getElementById('strategyToggleIcon').setAttribute('data-lucide', 'chevron-right');
          const strategyToggleButton = document.querySelector('#strategyToggleIcon').parentElement;
          strategyToggleButton.innerHTML = `<i id="strategyToggleIcon" data-lucide="chevron-right" class="inline-block mr-2"></i>展開`;
        }
        if (externalConditionCollapsed) {
          document.getElementById('externalConditionManagementContent').classList.add('hidden');
          document.getElementById('externalConditionToggleIcon').setAttribute('data-lucide', 'chevron-right');
          const externalConditionToggleButton = document.querySelector('#externalConditionToggleIcon').parentElement;
          externalConditionToggleButton.innerHTML = `<i id="externalConditionToggleIcon" data-lucide="chevron-right" class="inline-block mr-2"></i>展開`;
        }
        lucide.createIcons();
      }

      function renderStrategies() {
        const strategiesList = document.getElementById('strategiesList');
        strategiesList.innerHTML = strategies.map(strategy => `
          <tr>
            <td class="border px-4 py-2 min-w-[150px]">${escapeHtml(strategy.name)}</td>
            <td class="border px-4 py-2 min-w-[200px]">${escapeHtml(strategy.description)}</td>
            <td class="border px-4 py-2 text-center">
              <button onclick="openEditStrategyModal(${strategy.id})" class="mr-2">
                <i data-lucide="edit"></i>
              </button>
              <button onclick="deleteStrategy(${strategy.id})" class="delete-button">
                <i data-lucide="trash-2"></i>
              </button>
            </td>
          </tr>
        `).join('');
        renderStrategyFilter();
        lucide.createIcons();
      }

      function renderStrategyFilter() {
        const strategyFilter = document.getElementById('strategyFilter');
        strategyFilter.innerHTML = `
          <option value="">全部策略</option>
          ${strategies.map(strategy => `
            <option value="${strategy.id}">${escapeHtml(strategy.name)}</option>
          `).join('')}
        `;
      }

      function renderExternalConditions() {
        const externalConditionsList = document.getElementById('externalConditionsList');
        externalConditionsList.innerHTML = externalConditions.map(condition => `
          <tr>
            <td class="border px-4 py-2 min-w-[150px]">${escapeHtml(condition.name)}</td>
            <td class="border px-4 py-2 min-w-[200px]">${escapeHtml(condition.description)}</td>
            <td class="border px-4 py-2 text-center">
              <button onclick="openEditExternalConditionModal(${condition.id})" class="mr-2">
                <i data-lucide="edit"></i>
              </button>
              <button onclick="deleteExternalCondition(${condition.id})" class="delete-button">
                <i data-lucide="trash-2"></i>
              </button>
            </td>
          </tr>
        `).join('');
        renderExternalConditionFilter();
        lucide.createIcons();
      }

      function renderExternalConditionFilter() {
        const externalConditionFilter = document.getElementById('externalConditionFilter');
        externalConditionFilter.innerHTML = `
          <option value="">全部外部條件</option>
          ${externalConditions.map(condition => `
            <option value="${condition.id}">${escapeHtml(condition.name)}</option>
          `).join('')}
        `;
      }

      function renderTrades() {
        const tradesList = document.getElementById('tradesList');
        tradesList.innerHTML = '';
        let filteredTrades = trades;
        if (selectedStrategyFilter !== null) {
          filteredTrades = filteredTrades.filter(trade => trade.strategyId === selectedStrategyFilter);
        }
        if (selectedExternalConditionFilter !== null) {
          filteredTrades = filteredTrades.filter(trade => trade.externalConditionId === selectedExternalConditionFilter);
        }
        if (selectedStartDateFilter !== null && selectedStartDateFilter !== '') {
          const startDate = new Date(selectedStartDateFilter);
          filteredTrades = filteredTrades.filter(trade => trade.openDate && new Date(trade.openDate) >= startDate);
        }
        if (selectedEndDateFilter !== null && selectedEndDateFilter !== '') {
          const endDate = new Date(selectedEndDateFilter);
          filteredTrades = filteredTrades.filter(trade => trade.openDate && new Date(trade.openDate) <= endDate);
        }
        const tradesWithOpenDate = filteredTrades.filter(trade => trade.openDate !== '');
        const sortedAscending = [...tradesWithOpenDate].sort((a, b) => new Date(a.openDate) - new Date(b.openDate));
        const transactionNumbers = new Map();
        sortedAscending.forEach((trade, index) => {
          transactionNumbers.set(trade.id, index + 1);
        });
        filteredTrades.sort((a, b) => {
          if (a.openDate === '' && b.openDate === '') return 0;
          if (a.openDate === '') return -1;
          if (b.openDate === '') return 1;
          return new Date(b.openDate) - new Date(a.openDate);
        });
        tradesList.innerHTML = filteredTrades.map((trade, index) => {
          const transactionNumber = trade.openDate !== '' ? transactionNumbers.get(trade.id) : '';
          let holdingDays = '';
          let holdingDaysClass = '';
          if (trade.openDate !== '' && trade.closeDate !== '') {
            const openDate = new Date(trade.openDate);
            const closeDate = new Date(trade.closeDate);
            const diffTime = closeDate - openDate;
            holdingDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            if (holdingDays < 0) {
              holdingDays = '';
            }
          } else {
            holdingDays = '未平倉';
            holdingDaysClass = 'text-red-500';
          }
          const strategyOptions = strategies.map(strategy => `
            <option value="${strategy.id}" ${trade.strategyId === strategy.id ? 'selected' : ''}>${escapeHtml(strategy.name)}</option>
          `).join('');
          const externalConditionOptions = externalConditions.map(condition => `
            <option value="${condition.id}" ${trade.externalConditionId === condition.id ? 'selected' : ''}>${escapeHtml(condition.name)}</option>
          `).join('');
          return `
            <tr>
              <td class="border px-4 py-2 text-center min-w-[80px]">${transactionNumber}</td>
              <td class="border px-4 py-2 min-w-[100px]">
                <input type="date" value="${trade.openDate}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'openDate', this.value)" class="w-full p-1 border rounded trade-input" data-row-index="${trades.indexOf(trade)}" data-field="openDate">
              </td>
              <td class="border px-4 py-2 min-w-[100px]">
                <input type="date" value="${trade.closeDate}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'closeDate', this.value)" class="w-full p-1 border rounded trade-input" data-row-index="${trades.indexOf(trade)}" data-field="closeDate">
              </td>
              <td class="border px-4 py-2 text-center ${holdingDaysClass} min-w-[100px]">
                ${holdingDays}
              </td>
              <td class="border px-4 py-2 min-w-[100px]">
                <input type="text" value="${trade.returnRate}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'returnRate', this.value)" class="w-full p-1 border rounded trade-input" placeholder="+6.66 或 -2.92" data-row-index="${trades.indexOf(trade)}" data-field="returnRate" data-trade-id="${trade.id}">
              </td>
              <td class="border px-4 py-2 min-w-[100px]">
                <input type="number" value="${trade.position}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'position', this.value)" class="w-full p-1 border rounded trade-input" placeholder="部位金額" data-row-index="${trades.indexOf(trade)}" data-field="position">
              </td>
              <td class="border px-4 py-2 min-w-[150px]">
                <input type="text" value="${escapeHtml(trade.assetName)}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'assetName', this.value)" class="w-full p-1 border rounded trade-input" placeholder="輸入標的名稱" data-row-index="${trades.indexOf(trade)}" data-field="assetName">
              </td>
              <td class="border px-4 py-2 min-w-[150px]">
                <select onchange="handleTradeChange(${trades.indexOf(trade)}, 'strategyId', this.value)" class="w-full p-1 border rounded trade-input" data-row-index="${trades.indexOf(trade)}" data-field="strategyId">
                  <option value="">選擇策略</option>
                  ${strategyOptions}
                </select>
              </td>
              <td class="border px-4 py-2 min-w-[150px]">
                <select onchange="handleTradeChange(${trades.indexOf(trade)}, 'externalConditionId', this.value)" class="w-full p-1 border rounded trade-input" data-row-index="${trades.indexOf(trade)}" data-field="externalConditionId">
                  <option value="">選擇外部條件</option>
                  ${externalConditionOptions}
                </select>
              </td>
              <td class="border px-4 py-2 min-w-[200px]">
                <input type="text" value="${escapeHtml(trade.description)}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'description', this.value)" class="w-full p-1 border rounded trade-input" placeholder="輸入文字說明" data-row-index="${trades.indexOf(trade)}" data-field="description">
              </td>
              <td class="border px-4 py-2 min-w-[200px]">
                <input type="text" value="${trade.imageUrl}" oninput="handleTradeChange(${trades.indexOf(trade)}, 'imageUrl', this.value)" class="w-full p-1 border rounded trade-input" placeholder="輸入圖片URL" data-row-index="${trades.indexOf(trade)}" data-field="imageUrl">
                ${trade.imageUrl ? `<button onclick="openImageLink('${encodeURIComponent(trade.imageUrl)}')" class="mt-2 button text-sm">查看圖片</button>` : ''}
              </td>
              <td class="border px-4 py-2 text-center min-w-[80px]">
                ${trades.length > 1 ? `<button onclick="removeTrade(${trades.indexOf(trade)})" class="delete-button"><i data-lucide="trash-2"></i></button>` : ''}
              </td>
            </tr>
          `;
        }).join('');
        lucide.createIcons();
        const topScrollbarContent = document.getElementById('topScrollbarContent');
        const bottomScrollbar = document.getElementById('bottomScrollbar');
        const table = bottomScrollbar.querySelector('table');
        if (table) {
          topScrollbarContent.style.width = table.scrollWidth + 'px';
        }
        const topScrollbar = document.getElementById('topScrollbar');
        const bottomScrollDiv = document.getElementById('bottomScrollbar');
        topScrollbar.removeEventListener('scroll', syncTopToBottom);
        bottomScrollDiv.removeEventListener('scroll', syncBottomToTop);
        function syncTopToBottom() {
          bottomScrollDiv.scrollLeft = topScrollbar.scrollLeft;
        }
        function syncBottomToTop() {
          topScrollbar.scrollLeft = bottomScrollDiv.scrollLeft;
        }
        topScrollbar.addEventListener('scroll', syncTopToBottom);
        bottomScrollDiv.addEventListener('scroll', syncBottomToTop);
        topScrollbar.scrollLeft = bottomScrollDiv.scrollLeft;
      }

      function getStrategyName(strategyId) {
        const strategy = strategies.find(s => s.id === strategyId);
        return strategy ? strategy.name : '';
      }

      function getExternalConditionName(conditionId) {
        const condition = externalConditions.find(c => c.id === conditionId);
        return condition ? condition.name : '';
      }

      function handleTradeChange(index, field, value) {
        if (field === 'returnRate') {
          const cleanedValue = value.replace('%', '').trim();
          trades[index].returnRate = (cleanedValue === '' || isNaN(cleanedValue)) ? '' : cleanedValue;
        } else if (field === 'assetName') {
          trades[index].assetName = value.trim();
        } else if (field === 'strategyId') {
          trades[index].strategyId = value === '' ? null : parseInt(value, 10);
        } else if (field === 'externalConditionId') {
          trades[index].externalConditionId = value === '' ? null : parseInt(value, 10);
        } else if (field === 'openDate') {
          trades[index].openDate = value;
          const closeDate = trades[index].closeDate;
          if (closeDate !== '' && new Date(closeDate) < new Date(value)) {
            alert('平倉日不能早於開倉日。');
            trades[index].closeDate = '';
            document.querySelector(`input[data-row-index="${index}"][data-field="closeDate"]`).value = '';
          }
        } else if (field === 'closeDate') {
          trades[index].closeDate = value;
          const openDate = trades[index].openDate;
          if (openDate !== '' && new Date(value) < new Date(openDate)) {
            alert('平倉日不能早於開倉日。');
            trades[index].closeDate = '';
            document.querySelector(`input[data-row-index="${index}"][data-field="closeDate"]`).value = '';
          }
        } else if (field === 'description') {
          trades[index].description = value.trim();
        } else if (field === 'imageUrl') {
          trades[index].imageUrl = value.trim();
        } else if (field === 'position') {
          trades[index].position = value.trim();
        }
        calculateStats();
        saveData();
      }

      function openImageLink(url) {
        window.open(decodeURIComponent(url), '_blank');
      }

      function addTrade() {
        if (strategies.length === 0) {
          alert('請先新增至少一個交易策略。');
          return;
        }
        if (externalConditions.length === 0) {
          alert('請先新增至少一個外部條件。');
          return;
        }
        const newTrade = { 
          id: nextTradeId++, 
          returnRate: '', 
          position: '',
          assetName: '', 
          strategyId: null, 
          externalConditionId: null, 
          openDate: '', 
          closeDate: '',
          description: '', 
          imageUrl: '' 
        };
        trades.unshift(newTrade);
        renderTrades();
        calculateStats();
        saveData();
        setTimeout(() => {
          const newInput = document.querySelector(`input[data-trade-id="${newTrade.id}"][data-field="returnRate"]`);
          if (newInput) {
            newInput.focus();
          }
        }, 100);
      }

      function removeTrade(index) {
        trades = trades.filter((_, i) => i !== index);
        if (trades.length === 0) {
          trades.push({ id: nextTradeId++, returnRate: '', position: '', assetName: '', strategyId: null, externalConditionId: null, openDate: '', closeDate: '', description: '', imageUrl: '' });
        }
        renderTrades();
        calculateStats();
        saveData();
      }

      function openAddStrategyModal() {
        openModal('addStrategyModal');
      }

      function closeAddStrategyModal() {
        closeModal('addStrategyModal');
      }

      function addStrategy() {
        const nameInput = document.getElementById('newStrategyName');
        const descriptionInput = document.getElementById('newStrategyDescription');
        const name = nameInput.value.trim();
        const description = descriptionInput.value.trim();
        if (name === '') {
          alert('策略名稱不能為空。');
          return;
        }
        const existingStrategy = strategies.find(strategy => strategy.name === name);
        if (existingStrategy) {
          alert('策略名稱已存在，請選擇其他名稱。');
          return;
        }
        const newId = strategies.length > 0 ? Math.max(...strategies.map(s => s.id)) + 1 : 1;
        strategies.push({ id: newId, name, description });
        saveStrategies();
        renderStrategies();
        renderTrades();
        calculateStats();
        closeAddStrategyModal();
      }

      function openEditStrategyModal(strategyId) {
        const strategy = strategies.find(s => s.id === strategyId);
        if (!strategy) return;
        document.getElementById('editStrategyId').value = strategy.id;
        document.getElementById('editStrategyName').value = strategy.name;
        document.getElementById('editStrategyDescription').value = strategy.description;
        openModal('editStrategyModal');
      }

      function closeEditStrategyModal() {
        closeModal('editStrategyModal');
      }

      function updateStrategy() {
        const id = parseInt(document.getElementById('editStrategyId').value, 10);
        const name = document.getElementById('editStrategyName').value.trim();
        const description = document.getElementById('editStrategyDescription').value.trim();
        if (name === '') {
          alert('策略名稱不能為空。');
          return;
        }
        const existingStrategy = strategies.find(strategy => strategy.name === name && strategy.id !== id);
        if (existingStrategy) {
          alert('策略名稱已存在，請選擇其他名稱。');
          return;
        }
        const strategyIndex = strategies.findIndex(s => s.id === id);
        if (strategyIndex === -1) return;
        strategies[strategyIndex].name = name;
        strategies[strategyIndex].description = description;
        saveStrategies();
        renderStrategies();
        renderTrades();
        calculateStats();
        closeEditStrategyModal();
      }

      function deleteStrategy(strategyId) {
        const tradesUsingStrategy = trades.filter(trade => trade.strategyId === strategyId);
        if (tradesUsingStrategy.length > 0) {
          alert('有交易紀錄正在使用此策略，請先移除或更改相關交易紀錄。');
          return;
        }
        if (!confirm('您確定要刪除此策略嗎？此操作無法撤銷。')) {
          return;
        }
        strategies = strategies.filter(strategy => strategy.id !== strategyId);
        saveStrategies();
        renderStrategies();
        renderTrades();
        calculateStats();
      }

      function openAddExternalConditionModal() {
        openModal('addExternalConditionModal');
      }

      function closeAddExternalConditionModal() {
        closeModal('addExternalConditionModal');
      }

      function addExternalCondition() {
        const nameInput = document.getElementById('newExternalConditionName');
        const descriptionInput = document.getElementById('newExternalConditionDescription');
        const name = nameInput.value.trim();
        const description = descriptionInput.value.trim();
        if (name === '') {
          alert('外部條件名稱不能為空。');
          return;
        }
        const existingCondition = externalConditions.find(condition => condition.name === name);
        if (existingCondition) {
          alert('外部條件名稱已存在，請選擇其他名稱。');
          return;
        }
        const newId = externalConditions.length > 0 ? Math.max(...externalConditions.map(c => c.id)) + 1 : 1;
        externalConditions.push({ id: newId, name, description });
        saveExternalConditions();
        renderExternalConditions();
        renderTrades();
        calculateStats();
        closeAddExternalConditionModal();
      }

      function openEditExternalConditionModal(conditionId) {
        const condition = externalConditions.find(c => c.id === conditionId);
        if (!condition) return;
        document.getElementById('editExternalConditionId').value = condition.id;
        document.getElementById('editExternalConditionName').value = condition.name;
        document.getElementById('editExternalConditionDescription').value = condition.description;
        openModal('editExternalConditionModal');
      }

      function closeEditExternalConditionModal() {
        closeModal('editExternalConditionModal');
      }

      function updateExternalCondition() {
        const id = parseInt(document.getElementById('editExternalConditionId').value, 10);
        const name = document.getElementById('editExternalConditionName').value.trim();
        const description = document.getElementById('editExternalConditionDescription').value.trim();
        if (name === '') {
          alert('外部條件名稱不能為空。');
          return;
        }
        const existingCondition = externalConditions.find(condition => condition.name === name && condition.id !== id);
        if (existingCondition) {
          alert('外部條件名稱已存在，請選擇其他名稱。');
          return;
        }
        const conditionIndex = externalConditions.findIndex(c => c.id === id);
        if (conditionIndex === -1) return;
        externalConditions[conditionIndex].name = name;
        externalConditions[conditionIndex].description = description;
        saveExternalConditions();
        renderExternalConditions();
        renderTrades();
        calculateStats();
        closeEditExternalConditionModal();
      }

      function deleteExternalCondition(conditionId) {
        const tradesUsingCondition = trades.filter(trade => trade.externalConditionId === conditionId);
        if (tradesUsingCondition.length > 0) {
          alert('有交易紀錄正在使用此外部條件，請先移除或更改相關交易紀錄。');
          return;
        }
        if (!confirm('您確定要刪除此外部條件嗎？此操作無法撤銷。')) {
          return;
        }
        externalConditions = externalConditions.filter(condition => condition.id !== conditionId);
        saveExternalConditions();
        renderExternalConditions();
        renderTrades();
        calculateStats();
      }

      function applyFilters() {
        const strategyId = document.getElementById('strategyFilter').value;
        const externalConditionId = document.getElementById('externalConditionFilter').value;
        const startDate = document.getElementById('startDateFilter').value;
        const endDate = document.getElementById('endDateFilter').value;
        selectedStrategyFilter = strategyId === '' ? null : parseInt(strategyId, 10);
        selectedExternalConditionFilter = externalConditionId === '' ? null : parseInt(externalConditionId, 10);
        selectedStartDateFilter = startDate === '' ? null : startDate;
        selectedEndDateFilter = endDate === '' ? null : endDate;
        calculateStats();
        renderTrades();
      }

      function clearDateFilters() {
        document.getElementById('startDateFilter').value = '';
        document.getElementById('endDateFilter').value = '';
        selectedStartDateFilter = null;
        selectedEndDateFilter = null;
        applyFilters();
      }

      function shiftEndDate(days) {
        const endDateInput = document.getElementById('endDateFilter');
        let endDate = endDateInput.value ? new Date(endDateInput.value) : null;
        if (endDate) {
          endDate.setDate(endDate.getDate() + days);
          endDateInput.value = formatDate(endDate);
        } else {
          alert('請先設定結束日期，再進行調整。');
        }
        applyFilters();
      }

      function formatDate(date) {
        return date.toISOString().split('T')[0];
      }

      // 計算統計數據，所有計算均基於目前的篩選條件 validTrades
      function calculateStats() {
        // 依據篩選條件計算有效交易
        let validTrades = trades.filter(trade => 
          trade.returnRate !== '' && !isNaN(parseFloat(trade.returnRate))
        );
        if (selectedStrategyFilter !== null) {
          validTrades = validTrades.filter(trade => trade.strategyId === selectedStrategyFilter);
        }
        if (selectedExternalConditionFilter !== null) {
          validTrades = validTrades.filter(trade => trade.externalConditionId === selectedExternalConditionFilter);
        }
        if (selectedStartDateFilter !== null && selectedStartDateFilter !== '') {
          const startDate = new Date(selectedStartDateFilter);
          validTrades = validTrades.filter(trade => trade.openDate && new Date(trade.openDate) >= startDate);
        }
        if (selectedEndDateFilter !== null && selectedEndDateFilter !== '') {
          const endDate = new Date(selectedEndDateFilter);
          validTrades = validTrades.filter(trade => trade.openDate && new Date(trade.openDate) <= endDate);
        }
        // 若無有效交易則重置顯示
        if (validTrades.length === 0) {
          document.getElementById('totalTrades').textContent = '0';
          document.getElementById('winRate').textContent = '0% (0勝0敗)';
          document.getElementById('riskRewardRatio').textContent = '0';
          document.getElementById('avgWin').textContent = '+0';
          document.getElementById('avgLoss').textContent = '-0';
          document.getElementById('maxWin').textContent = '+0';
          document.getElementById('maxLoss').textContent = '-0';
          document.getElementById('expectedValue').textContent = '0';
          document.getElementById('totalReturn').textContent = '0';
          removeColorClasses(['expectedValue', 'totalReturn']);
          document.getElementById('avgWinningPosition').textContent = '$0';
          document.getElementById('avgLosingPosition').textContent = '$0';
          document.getElementById('unclosedTradeCount').textContent = '0';
          document.getElementById('unclosedPositionTotal').textContent = '$0 (0%)';
          document.getElementById('roi').textContent = '0%';
          document.getElementById('freeCapital').textContent = '$0 (0%)';
          document.getElementById('capitalUsed').textContent = '$0 (0%)';
          return;
        }
        const results = validTrades.map(trade => parseFloat(trade.returnRate));
        const wins = results.filter(result => result > 0);
        const losses = results.filter(result => result < 0);
        const winRate = (wins.length / results.length) * 100;
        // 這裡的 avgWinRate、avgLossRate、maxWinRate、maxLossRate 為百分比參考，不作後續顯示
        const avgWinRate = wins.length > 0 ? wins.reduce((a, b) => a + b) / wins.length : 0;
        const avgLossRate = losses.length > 0 ? losses.reduce((a, b) => a + b) / losses.length : 0;
        const maxWinRate = wins.length > 0 ? Math.max(...wins) : 0;
        const maxLossRate = losses.length > 0 ? Math.min(...losses) : 0;

        // 使用 validTrades（已過濾）計算有部位資料的交易
        const tradesWithPosition = validTrades.filter(trade =>
          trade.position !== '' && !isNaN(parseFloat(trade.position)) && parseFloat(trade.position) > 0 &&
          trade.returnRate !== '' && !isNaN(parseFloat(trade.returnRate))
        );
        let totalReturnAmount = 0;
        // 從總操作資金中取得值
        const totalOpCapInput = document.getElementById('totalOperatingCapital').value;
        const opCap = parseFloat(totalOpCapInput);
        if (tradesWithPosition.length > 0) {
          totalReturnAmount = tradesWithPosition.reduce((sum, trade) => sum + (parseFloat(trade.returnRate) / 100 * parseFloat(trade.position)), 0);
          // 總報酬以總操作資金的百分比
          let totalReturnPercentage = opCap > 0 ? (totalReturnAmount / opCap) * 100 : 0;
          // 平均獲利與平均虧損金額
          const winsWithPosition = tradesWithPosition.filter(trade => parseFloat(trade.returnRate) > 0);
          const lossesWithPosition = tradesWithPosition.filter(trade => parseFloat(trade.returnRate) < 0);
          const avgWinAmount = winsWithPosition.length > 0 ? winsWithPosition.reduce((sum, trade) => sum + (parseFloat(trade.returnRate) / 100 * parseFloat(trade.position)), 0) / winsWithPosition.length : 0;
          const avgLossAmount = lossesWithPosition.length > 0 ? lossesWithPosition.reduce((sum, trade) => sum + (parseFloat(trade.returnRate) / 100 * parseFloat(trade.position)), 0) / lossesWithPosition.length : 0;
          const maxWinAmount = winsWithPosition.length > 0 ? Math.max(...winsWithPosition.map(trade => (parseFloat(trade.returnRate) / 100 * parseFloat(trade.position)))) : 0;
          const maxLossAmount = lossesWithPosition.length > 0 ? Math.min(...lossesWithPosition.map(trade => (parseFloat(trade.returnRate) / 100 * parseFloat(trade.position)))) : 0;
          // 期望值：平均每筆交易的回報金額
          const expectedValueAmount = totalReturnAmount / tradesWithPosition.length;
          let expectedValuePercentage = opCap > 0 ? (expectedValueAmount / opCap) * 100 : 0;
          
          // 更新「分析結果」區塊
          document.getElementById('expectedValue').textContent = `${formatMoney(expectedValueAmount, 0)} (${opCap > 0 ? formatNumberNoSign(expectedValuePercentage, 2) : '0.00'}%)`;
          document.getElementById('totalReturn').textContent = `${formatMoney(totalReturnAmount, 0)} (${opCap > 0 ? formatNumberNoSign(totalReturnPercentage, 2) : '0.00'}%)`;
          // 風報比以平均獲利金額 / 平均虧損金額（取絕對值）
          var riskRewardRatio = avgLossAmount !== 0 ? (avgWinAmount / Math.abs(avgLossAmount)) : 0;
          document.getElementById('riskRewardRatio').textContent = formatNumberNoSign(riskRewardRatio, 2);
          // 顯示平均獲利、平均虧損、最大獲利、最大虧損：金額及其佔總操作資金百分比
          document.getElementById('avgWin').textContent = `${formatMoney(avgWinAmount, 0)} (${opCap > 0 ? formatNumberNoSign((avgWinAmount / opCap) * 100, 2) : '0.00'}%)`;
          document.getElementById('avgLoss').textContent = `${formatMoney(avgLossAmount, 0)} (${opCap > 0 ? formatNumberNoSign((Math.abs(avgLossAmount) / opCap) * 100, 2) : '0.00'}%)`;
          document.getElementById('maxWin').textContent = `${formatMoney(maxWinAmount, 0)} (${opCap > 0 ? formatNumberNoSign((maxWinAmount / opCap) * 100, 2) : '0.00'}%)`;
          document.getElementById('maxLoss').textContent = `${formatMoney(maxLossAmount, 0)} (${opCap > 0 ? formatNumberNoSign((Math.abs(maxLossAmount) / opCap) * 100, 2) : '0.00'}%)`;
        } else {
          document.getElementById('avgWin').textContent = `(${formatNumber(avgWinRate, false, 2)}%)`;
          document.getElementById('avgLoss').textContent = `(${formatNumber(avgLossRate, false, 2)}%)`;
          document.getElementById('maxWin').textContent = `(${formatNumber(maxWinRate, false, 2)}%)`;
          document.getElementById('maxLoss').textContent = `(${formatNumber(maxLossRate, false, 2)}%)`;
          document.getElementById('expectedValue').textContent = `(${formatNumber(totalReturnRate, false, 2)}%)`;
          document.getElementById('totalReturn').textContent = `(${formatNumber(totalReturnRate, false, 2)}%)`;
          document.getElementById('riskRewardRatio').textContent = '0';
        }

        document.getElementById('totalTrades').textContent = formatTradeCount(results.length);
        document.getElementById('winRate').textContent = `${formatNumber(winRate.toFixed(2))}% (${wins.length}勝${losses.length}敗)`;

        // 部位統計，使用 validTrades
        const winningTrades = validTrades.filter(trade => 
          trade.position !== '' && !isNaN(parseFloat(trade.position)) && parseFloat(trade.position) > 0 &&
          trade.returnRate !== '' && !isNaN(parseFloat(trade.returnRate)) && parseFloat(trade.returnRate) > 0
        );
        const losingTrades = validTrades.filter(trade => 
          trade.position !== '' && !isNaN(parseFloat(trade.position)) && parseFloat(trade.position) > 0 &&
          trade.returnRate !== '' && !isNaN(parseFloat(trade.returnRate)) && parseFloat(trade.returnRate) < 0
        );
        const avgWinningPosition = winningTrades.length > 0 ? winningTrades.reduce((sum, trade) => sum + parseFloat(trade.position), 0) / winningTrades.length : 0;
        const avgLosingPosition = losingTrades.length > 0 ? losingTrades.reduce((sum, trade) => sum + parseFloat(trade.position), 0) / losingTrades.length : 0;
        document.getElementById('avgWinningPosition').textContent = formatMoney(avgWinningPosition, 0);
        document.getElementById('avgLosingPosition').textContent = formatMoney(avgLosingPosition, 0);

        // 未平倉統計（依然以全體有效交易 validTrades 計算）
        const unclosedTrades = validTrades.filter(trade => trade.openDate !== '' && (!trade.closeDate || trade.closeDate.trim() === ''));
        const unclosedTradeCount = unclosedTrades.length;
        const unclosedPositionSum = unclosedTrades.reduce((sum, trade) => sum + (parseFloat(trade.position) || 0), 0);
        document.getElementById('unclosedTradeCount').textContent = unclosedTradeCount;
        let unclosedPercentage = 0;
        if (!isNaN(opCap) && opCap > 0) {
          unclosedPercentage = (unclosedPositionSum / opCap) * 100;
        }
        document.getElementById('unclosedPositionTotal').textContent = formatMoney(unclosedPositionSum, 0) + " (" + formatNumberNoSign(unclosedPercentage, 2) + "%)";
        
        // 資金績效統計
        let roi = 0;
        if (!isNaN(opCap) && opCap > 0) {
          roi = (totalReturnAmount / opCap) * 100;
        }
        let freeCapital = opCap - unclosedPositionSum;
        let freePercentage = opCap > 0 ? (freeCapital / opCap) * 100 : 0;
        document.getElementById('roi').textContent = formatNumberNoSign(roi, 2) + "%";
        document.getElementById('freeCapital').textContent = formatMoney(freeCapital, 0) + " (" + formatNumberNoSign(freePercentage, 2) + "%)";
        document.getElementById('capitalUsed').textContent = formatMoney(unclosedPositionSum, 0) + " (" + formatNumberNoSign(unclosedPercentage, 2) + "%)";
        
        const expectedValueElem = document.getElementById('expectedValue');
        if (expectedValueElem.textContent.indexOf('+') !== -1) {
          expectedValueElem.classList.add('text-red-500');
          expectedValueElem.classList.remove('text-green-500');
        } else if (expectedValueElem.textContent.indexOf('-') !== -1) {
          expectedValueElem.classList.add('text-green-500');
          expectedValueElem.classList.remove('text-red-500');
        } else {
          expectedValueElem.classList.remove('text-red-500', 'text-green-500');
        }
        const totalReturnElem = document.getElementById('totalReturn');
        if (totalReturnElem.textContent.indexOf('+') !== -1) {
          totalReturnElem.classList.add('text-red-500');
          totalReturnElem.classList.remove('text-green-500');
        } else if (totalReturnElem.textContent.indexOf('-') !== -1) {
          totalReturnElem.classList.add('text-green-500');
          totalReturnElem.classList.remove('text-red-500');
        } else {
          totalReturnElem.classList.remove('text-red-500', 'text-green-500');
        }
      }

      function removeColorClasses(elementIds) {
        elementIds.forEach(id => {
          const elem = document.getElementById(id);
          elem.classList.remove('text-red-500', 'text-green-500');
        });
      }

      // 初始化
      loadStrategies();
      loadExternalConditions();
      loadData();

      function toggleStrategyManagement() {
        const content = document.getElementById('strategyManagementContent');
        const toggleIcon = document.getElementById('strategyToggleIcon');
        const toggleButton = toggleIcon.parentElement;
        if (content.classList.contains('hidden')) {
          content.classList.remove('hidden');
          toggleIcon.setAttribute('data-lucide', 'chevron-down');
          toggleButton.innerHTML = `<i id="strategyToggleIcon" data-lucide="chevron-down" class="inline-block mr-2"></i>收合`;
        } else {
          content.classList.add('hidden');
          toggleIcon.setAttribute('data-lucide', 'chevron-right');
          toggleButton.innerHTML = `<i id="strategyToggleIcon" data-lucide="chevron-right" class="inline-block mr-2"></i>展開`;
        }
        lucide.createIcons();
        saveCollapseState();
      }

      function toggleExternalConditionManagement() {
        const content = document.getElementById('externalConditionManagementContent');
        const toggleIcon = document.getElementById('externalConditionToggleIcon');
        const toggleButton = toggleIcon.parentElement;
        if (content.classList.contains('hidden')) {
          content.classList.remove('hidden');
          toggleIcon.setAttribute('data-lucide', 'chevron-down');
          toggleButton.innerHTML = `<i id="externalConditionToggleIcon" data-lucide="chevron-down" class="inline-block mr-2"></i>收合`;
        } else {
          content.classList.add('hidden');
          toggleIcon.setAttribute('data-lucide', 'chevron-right');
          toggleButton.innerHTML = `<i id="externalConditionToggleIcon" data-lucide="chevron-right" class="inline-block mr-2"></i>展開`;
        }
        lucide.createIcons();
        saveCollapseState();
      }

      function openModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
      }

      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.add('hidden');
        const inputs = modal.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
          if (input.type !== 'hidden') {
            input.value = '';
          }
        });
      }

      function escapeHtml(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
      }

      function exportToExcel() {
        if (trades.length === 0) {
          alert('目前沒有交易紀錄可供匯出。');
          return;
        }
        const exportData = trades.map(trade => ({
          "交易ID": trade.id,
          "報酬率 (%)": trade.returnRate,
          "部位金額": trade.position,
          "標的名稱": trade.assetName,
          "策略名稱": getStrategyName(trade.strategyId),
          "外部條件": getExternalConditionName(trade.externalConditionId),
          "開倉日": trade.openDate,
          "平倉日": trade.closeDate,
          "持倉天數": calculateHoldingDays(trade.openDate, trade.closeDate),
          "文字說明": trade.description,
          "圖片URL": trade.imageUrl
        }));
        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "交易紀錄");
        const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/octet-stream' });
        const link = document.createElement('a');
        const today = new Date().toISOString().split('T')[0];
        link.href = URL.createObjectURL(blob);
        link.download = `交易紀錄_${today}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function calculateHoldingDays(openDate, closeDate) {
        if (openDate === '' && closeDate === '') return '';
        if (openDate === '' || closeDate === '') return '未平倉';
        const open = new Date(openDate);
        const close = new Date(closeDate);
        const diffTime = close - open;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        return diffDays >= 0 ? diffDays : '';
      }

      function importFromExcel(event) {
        const file = event.target.files[0];
        if (!file) {
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = e.target.result;
          let workbook;
          try {
            workbook = XLSX.read(data, { type: 'binary' });
          } catch (error) {
            alert('無法解析該文件。請確認文件為有效的Excel格式。');
            return;
          }
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
          if (jsonData.length === 0) {
            alert('Excel文件中沒有任何數據。');
            return;
          }
          const requiredFields = ["交易ID", "報酬率 (%)", "部位金額", "標的名稱", "策略名稱", "外部條件", "開倉日", "平倉日", "持倉天數", "文字說明", "圖片URL"];
          const missingFields = requiredFields.filter(field => !(field in jsonData[0]));
          if (missingFields.length > 0) {
            alert(`缺少以下必要欄位：${missingFields.join(', ')}`);
            return;
          }
          const importedTrades = jsonData.map(item => {
            const strategy = strategies.find(s => s.name === item["策略名稱"]);
            const externalCondition = externalConditions.find(c => c.name === item["外部條件"]);
            if (!strategy) {
              alert(`策略名稱 "${item["策略名稱"]}" 不存在。請先新增該策略後再匯入。`);
              return null;
            }
            if (!externalCondition) {
              alert(`外部條件名稱 "${item["外部條件"]}" 不存在。請先新增該外部條件後再匯入。`);
              return null;
            }
            const newTradeId = nextTradeId++;
            let holdingDays = item["持倉天數"];
            if (holdingDays === '' || holdingDays === '未平倉') {
              holdingDays = '未平倉';
            }
            return {
              id: newTradeId,
              returnRate: item["報酬率 (%)"],
              position: item["部位金額"],
              assetName: item["標的名稱"],
              strategyId: strategy.id,
              externalConditionId: externalCondition.id,
              openDate: item["開倉日"],
              closeDate: item["平倉日"],
              description: item["文字說明"],
              imageUrl: item["圖片URL"]
            };
          }).filter(trade => trade !== null);
          if (importedTrades.length === 0) {
            alert('沒有有效的交易紀錄被匯入。');
            return;
          }
          trades = trades.concat(importedTrades);
          renderTrades();
          calculateStats();
          saveData();
          alert(`成功匯入 ${importedTrades.length} 筆交易紀錄。`);
          document.getElementById('importExcelInput').value = '';
        };
        reader.onerror = function() {
          alert('讀取文件時發生錯誤。');
        };
        reader.readAsBinaryString(file);
      }

      function exportStrategiesToExcel() {
        if (strategies.length === 0) {
          alert('目前沒有策略資料可供匯出。');
          return;
        }
        const exportData = strategies.map(strategy => ({
          "策略ID": strategy.id,
          "策略名稱": strategy.name,
          "描述": strategy.description
        }));
        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "策略管理");
        const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/octet-stream' });
        const link = document.createElement('a');
        const today = new Date().toISOString().split('T')[0];
        link.href = URL.createObjectURL(blob);
        link.download = `策略管理_${today}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function importStrategiesFromExcel(event) {
        const file = event.target.files[0];
        if (!file) {
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = e.target.result;
          let workbook;
          try {
            workbook = XLSX.read(data, { type: 'binary' });
          } catch (error) {
            alert('無法解析該文件。請確認文件為有效的Excel格式。');
            return;
          }
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
          if (jsonData.length === 0) {
            alert('Excel文件中沒有任何數據。');
            return;
          }
          const requiredFields = ["策略ID", "策略名稱", "描述"];
          const missingFields = requiredFields.filter(field => !(field in jsonData[0]));
          if (missingFields.length > 0) {
            alert(`缺少以下必要欄位：${missingFields.join(', ')}`);
            return;
          }
          const importedStrategies = jsonData.map(item => {
            const name = item["策略名稱"].trim();
            const description = item["描述"].trim();
            const existingStrategy = strategies.find(s => s.name === name);
            if (existingStrategy) {
              alert(`策略名稱 "${name}" 已存在。請避免重複新增。`);
              return null;
            }
            const newStrategyId = nextTradeId++;
            return {
              id: newStrategyId,
              name: name,
              description: description
            };
          }).filter(strategy => strategy !== null);
          if (importedStrategies.length === 0) {
            alert('沒有有效的策略紀錄被匯入。');
            return;
          }
          strategies = strategies.concat(importedStrategies);
          renderStrategies();
          renderTrades();
          calculateStats();
          saveStrategies();
          saveData();
          alert(`成功匯入 ${importedStrategies.length} 筆策略紀錄。`);
          document.getElementById('importStrategiesInput').value = '';
        };
        reader.onerror = function() {
          alert('讀取文件時發生錯誤。');
        };
        reader.readAsBinaryString(file);
      }

      function exportExternalConditionsToExcel() {
        if (externalConditions.length === 0) {
          alert('目前沒有外部條件資料可供匯出。');
          return;
        }
        const exportData = externalConditions.map(condition => ({
          "外部條件ID": condition.id,
          "外部條件名稱": condition.name,
          "描述": condition.description
        }));
        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "外部條件管理");
        const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/octet-stream' });
        const link = document.createElement('a');
        const today = new Date().toISOString().split('T')[0];
        link.href = URL.createObjectURL(blob);
        link.download = `外部條件管理_${today}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function importExternalConditionsFromExcel(event) {
        const file = event.target.files[0];
        if (!file) {
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = e.target.result;
          let workbook;
          try {
            workbook = XLSX.read(data, { type: 'binary' });
          } catch (error) {
            alert('無法解析該文件。請確認文件為有效的Excel格式。');
            return;
          }
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
          if (jsonData.length === 0) {
            alert('Excel文件中沒有任何數據。');
            return;
          }
          const requiredFields = ["外部條件ID", "外部條件名稱", "描述"];
          const missingFields = requiredFields.filter(field => !(field in jsonData[0]));
          if (missingFields.length > 0) {
            alert(`缺少以下必要欄位：${missingFields.join(', ')}`);
            return;
          }
          const importedExternalConditions = jsonData.map(item => {
            const name = item["外部條件名稱"].trim();
            const description = item["描述"].trim();
            const existingCondition = externalConditions.find(c => c.name === name);
            if (existingCondition) {
              alert(`外部條件名稱 "${name}" 已存在。請避免重複新增。`);
              return null;
            }
            const newConditionId = nextTradeId++;
            return {
              id: newConditionId,
              name: name,
              description: description
            };
          }).filter(condition => condition !== null);
          if (importedExternalConditions.length === 0) {
            alert('沒有有效的外部條件紀錄被匯入。');
            return;
          }
          externalConditions = externalConditions.concat(importedExternalConditions);
          renderExternalConditions();
          renderTrades();
          calculateStats();
          saveExternalConditions();
          saveData();
          alert(`成功匯入 ${importedExternalConditions.length} 筆外部條件紀錄。`);
          document.getElementById('importExternalConditionsInput').value = '';
        };
        reader.onerror = function() {
          alert('讀取文件時發生錯誤。');
        };
        reader.readAsBinaryString(file);
      }
    </script>
  </div>
</body>
</html>
