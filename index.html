<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易員報告書</title>
    
    <!-- PWA 相關設定 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFE4D6">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="交易員報告書">

    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans TC', sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #FFF3E6 0%, #FFE4D6 100%);
            padding: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 2rem;
            width: 90%;
            max-width: 1200px; /* 調整寬度以適應新增區塊 */
            margin: 0 auto;
            box-shadow: 0 8px 32px rgba(184, 134, 113, 0.1);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid rgba(184, 110, 82, 0.2);
            border-radius: 8px;
            background: white;
            color: #444;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #B86E52;
            box-shadow: 0 0 0 2px rgba(184, 110, 82, 0.1);
        }

        .button {
            background: linear-gradient(135deg, #E67E51 0%, #F1945E 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(230, 126, 81, 0.2);
        }

        .delete-button {
            color: #dc2626;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .delete-button:hover {
            color: #b91c1c;
        }

        /* 新增細線樣式 */
        .divider {
            border-bottom: 1px solid #e5e7eb; /* Tailwind 的 gray-200 */
            margin: 0.5rem 0;
        }

        /* 表格樣式調整 */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background-color: #f9fafb; /* Tailwind 的 gray-50 */
            font-weight: 600;
        }

        /* 模態框樣式 */
        .modal {
            display: flex;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1 class="text-2xl font-bold text-center mb-8 text-[#B86E52]">
            交易員報告書
        </h1>

        <!-- 策略和外部條件篩選下拉選單 -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                篩選條件
            </label>
            <div class="flex space-x-4">
                <!-- 策略篩選 -->
                <div class="flex-1">
                    <label for="strategyFilter" class="block text-sm font-medium text-gray-700 mb-1">
                        篩選策略
                    </label>
                    <select id="strategyFilter" class="w-full p-2 border rounded" onchange="applyFilters()">
                        <option value="">全部策略</option>
                        <!-- 策略選項將在 JavaScript 中動態添加 -->
                    </select>
                </div>
                <!-- 外部條件篩選 -->
                <div class="flex-1">
                    <label for="externalConditionFilter" class="block text-sm font-medium text-gray-700 mb-1">
                        篩選外部條件
                    </label>
                    <select id="externalConditionFilter" class="w-full p-2 border rounded" onchange="applyFilters()">
                        <option value="">全部外部條件</option>
                        <!-- 外部條件選項將在 JavaScript 中動態添加 -->
                    </select>
                </div>
            </div>
        </div>

        <!-- 分析結果區塊 -->
        <div class="bg-gray-50 p-4 rounded mb-6">
            <h2 class="text-lg font-medium text-gray-700 mb-4">分析結果</h2>
            
            <!-- 報告書的結論 -->
            <div class="space-y-4">
                <!-- 第一行：交易數、勝率、風報比 -->
                <div class="flex justify-between font-bold text-lg">
                    <div class="flex-1 text-center">
                        <span class="text-gray-600">交易數：</span>
                        <span id="totalTrades" class="font-medium">0</span>
                    </div>
                    <div class="flex-1 text-center">
                        <span class="text-gray-600">勝率：</span>
                        <span id="winRate" class="font-medium">0% (0勝0敗)</span>
                    </div>
                    <div class="flex-1 text-center">
                        <span class="text-gray-600">風報比：</span>
                        <span id="riskRewardRatio" class="font-medium">0</span>
                    </div>
                </div>

                <!-- 第二行：期望值 -->
                <div class="flex justify-between font-bold text-lg">
                    <div class="flex-1 text-center">
                        <span class="text-gray-700">期望值：</span>
                        <span id="expectedValue" class="font-bold text-lg">
                            0.0%
                        </span>
                    </div>
                </div>

                <!-- 第三行：總報酬 -->
                <div class="flex justify-between font-bold text-lg">
                    <div class="flex-1 text-center">
                        <span class="text-gray-700">總報酬：</span>
                        <span id="totalReturn" class="font-bold text-lg">
                            0%
                        </span>
                    </div>
                </div>
            </div>

            <!-- 損益統計 -->
            <div class="mt-6">
                <h3 class="text-md font-medium text-gray-700 mb-3">
                    損益統計
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <!-- 第一行：平均獲利、平均虧損 -->
                    <div class="flex justify-between">
                        <span class="text-gray-600">平均獲利：</span>
                        <span id="avgWin" class="font-medium">+0 (+0.00%)</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">平均虧損：</span>
                        <span id="avgLoss" class="font-medium">-0 (-0.00%)</span>
                    </div>
                    <!-- 分隔線 -->
                    <div class="col-span-2 divider"></div>
                    <!-- 第二行：最大獲利、最大虧損 -->
                    <div class="flex justify-between">
                        <span class="text-gray-600">最大獲利：</span>
                        <span id="maxWin" class="font-medium">+0 (+0.00%)</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">最大虧損：</span>
                        <span id="maxLoss" class="font-medium">-0 (-0.00%)</span>
                    </div>
                    <!-- 分隔線 -->
                    <div class="col-span-2 divider"></div>
                </div>
            </div>
        </div>

        <!-- 策略管理區塊 -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-medium text-gray-700">策略管理</h2>
                <button class="button" onclick="openAddStrategyModal()">
                    新增策略
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded">
                    <thead>
                        <tr>
                            <th class="px-4 py-2">策略名稱</th>
                            <th class="px-4 py-2">描述</th>
                            <th class="px-4 py-2">操作</th>
                        </tr>
                    </thead>
                    <tbody id="strategiesList">
                        <!-- 策略記錄將在這裡動態添加為表格行 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 外部條件管理區塊 -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-medium text-gray-700">外部條件管理</h2>
                <button class="button" onclick="openAddExternalConditionModal()">
                    新增外部條件
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded">
                    <thead>
                        <tr>
                            <th class="px-4 py-2">外部條件名稱</th>
                            <th class="px-4 py-2">描述</th>
                            <th class="px-4 py-2">操作</th>
                        </tr>
                    </thead>
                    <tbody id="externalConditionsList">
                        <!-- 外部條件記錄將在這裡動態添加為表格行 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 新增策略模態框 -->
        <div id="addStrategyModal" class="modal hidden">
            <div class="bg-white p-6 rounded-lg w-96">
                <h3 class="text-lg font-medium mb-4">新增策略</h3>
                <label class="block text-sm font-medium text-gray-700 mb-2" for="newStrategyName">策略名稱</label>
                <input type="text" id="newStrategyName" class="w-full p-2 border rounded mb-4" placeholder="輸入策略名稱">
                
                <label class="block text-sm font-medium text-gray-700 mb-2" for="newStrategyDescription">描述</label>
                <textarea id="newStrategyDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入策略描述"></textarea>
                
                <div class="flex justify-end">
                    <button class="button mr-2" onclick="closeAddStrategyModal()">取消</button>
                    <button class="button" onclick="addStrategy()">新增</button>
                </div>
            </div>
        </div>

        <!-- 編輯策略模態框 -->
        <div id="editStrategyModal" class="modal hidden">
            <div class="bg-white p-6 rounded-lg w-96">
                <h3 class="text-lg font-medium mb-4">編輯策略</h3>
                <input type="hidden" id="editStrategyId">
                
                <label class="block text-sm font-medium text-gray-700 mb-2" for="editStrategyName">策略名稱</label>
                <input type="text" id="editStrategyName" class="w-full p-2 border rounded mb-4" placeholder="輸入策略名稱">
                
                <label class="block text-sm font-medium text-gray-700 mb-2" for="editStrategyDescription">描述</label>
                <textarea id="editStrategyDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入策略描述"></textarea>
                
                <div class="flex justify-end">
                    <button class="button mr-2" onclick="closeEditStrategyModal()">取消</button>
                    <button class="button" onclick="updateStrategy()">更新</button>
                </div>
            </div>
        </div>

        <!-- 新增外部條件模態框 -->
        <div id="addExternalConditionModal" class="modal hidden">
            <div class="bg-white p-6 rounded-lg w-96">
                <h3 class="text-lg font-medium mb-4">新增外部條件</h3>
                <label class="block text-sm font-medium text-gray-700 mb-2" for="newExternalConditionName">外部條件名稱</label>
                <input type="text" id="newExternalConditionName" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件名稱">
                
                <label class="block text-sm font-medium text-gray-700 mb-2" for="newExternalConditionDescription">描述</label>
                <textarea id="newExternalConditionDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件描述"></textarea>
                
                <div class="flex justify-end">
                    <button class="button mr-2" onclick="closeAddExternalConditionModal()">取消</button>
                    <button class="button" onclick="addExternalCondition()">新增</button>
                </div>
            </div>
        </div>

        <!-- 編輯外部條件模態框 -->
        <div id="editExternalConditionModal" class="modal hidden">
            <div class="bg-white p-6 rounded-lg w-96">
                <h3 class="text-lg font-medium mb-4">編輯外部條件</h3>
                <input type="hidden" id="editExternalConditionId">
                
                <label class="block text-sm font-medium text-gray-700 mb-2" for="editExternalConditionName">外部條件名稱</label>
                <input type="text" id="editExternalConditionName" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件名稱">
                
                <label class="block text-sm font-medium text-gray-700 mb-2" for="editExternalConditionDescription">描述</label>
                <textarea id="editExternalConditionDescription" class="w-full p-2 border rounded mb-4" placeholder="輸入外部條件描述"></textarea>
                
                <div class="flex justify-end">
                    <button class="button mr-2" onclick="closeEditExternalConditionModal()">取消</button>
                    <button class="button" onclick="updateExternalCondition()">更新</button>
                </div>
            </div>
        </div>

        <!-- 平均部位輸入 -->
        <div class="mb-6">
            <label for="averagePosition" class="block text-sm font-medium text-gray-700 mb-2">
                平均部位金額（選填）
            </label>
            <input
                type="number"
                id="averagePosition"
                placeholder="輸入平均部位金額"
                class="w-full p-2 border rounded"
                onchange="calculateStats()"
            >
            <div class="text-sm text-gray-500 mt-1">
                若填寫此欄位，將會計算實際金額的獲利/虧損和期望值
            </div>
        </div>

        <!-- 交易記錄區域 -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-medium text-gray-700">交易紀錄</h2>
                <button class="button" onclick="addTrade()">
                    添加交易
                </button>
            </div>
            <div class="text-sm text-gray-600 mb-2">
                請輸入交易報酬率（例如：+6.66、-2.92）、標的名稱、策略名稱、外部條件、開倉日和平倉日
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded">
                    <thead>
                        <tr>
                            <th class="px-4 py-2">交易</th>
                            <th class="px-4 py-2">開倉日</th>
                            <th class="px-4 py-2">平倉日</th>
                            <th class="px-4 py-2">持倉天數</th> <!-- 新增欄位 -->
                            <th class="px-4 py-2">報酬率 (%)</th>
                            <th class="px-4 py-2">標的名稱</th>
                            <th class="px-4 py-2">策略名稱</th>
                            <th class="px-4 py-2">外部條件</th>
                            <th class="px-4 py-2">操作</th>
                        </tr>
                    </thead>
                    <tbody id="tradesList">
                        <!-- 交易記錄將在這裡動態添加為表格行 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 可選：清除數據按鈕 -->
        <!-- <button class="button mt-4 bg-red-500" onclick="clearData()">
            清除所有數據
        </button> -->

        <script>
            // 策略列表
            let strategies = [{ id: 1, name: '默認策略', description: '這是默認策略' }];
            // 外部條件列表
            let externalConditions = [{ id: 1, name: '默認外部條件', description: '這是默認外部條件' }];
            // 交易記錄列表
            let trades = [];
            // 當前篩選條件
            let selectedStrategyFilter = null;
            let selectedExternalConditionFilter = null;

            // 新增一個全局變數來追踪下一個交易的 ID
            let nextTradeId = 1;

            // 工具函數：格式化數字，每三位加上逗號，根據是否為金額決定是否顯示符號
            function formatNumber(value, isMoneyAmount = false, decimalPlaces = 2) {
                const number = parseFloat(value);
                if (isNaN(number)) return '0';
                
                if (isMoneyAmount) {
                    return number >= 0 ? 
                        `+${number.toLocaleString(undefined, {minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces})}` : 
                        `-${Math.abs(number).toLocaleString(undefined, {minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces})}`;
                }
                return number >= 0 ? 
                    `+${number.toLocaleString(undefined, {minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces})}` : 
                    `-${Math.abs(number).toLocaleString(undefined, {minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces})}`;
            }

            // 新增工具函數：格式化數字，不帶 "+" 符號，無小數點
            function formatNumberNoSign(value, decimalPlaces = 2) {
                const number = parseFloat(value);
                if (isNaN(number)) return '0';
                return number.toLocaleString(undefined, {minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces});
            }

            // 新增工具函數：格式化交易數，不帶 "+" 符號，無小數點
            function formatTradeCount(value) {
                const number = parseInt(value, 10);
                if (isNaN(number)) return '0';
                return number.toLocaleString();
            }

            // 保存數據到 localStorage
            function saveData() {
                localStorage.setItem('trades', JSON.stringify(trades));
                const averagePosition = document.getElementById('averagePosition').value;
                localStorage.setItem('averagePosition', averagePosition);
                saveStrategies(); // 保存策略數據
                saveExternalConditions(); // 保存外部條件數據
            }

            // 保存策略數據到 localStorage
            function saveStrategies() {
                localStorage.setItem('strategies', JSON.stringify(strategies));
            }

            // 保存外部條件數據到 localStorage
            function saveExternalConditions() {
                localStorage.setItem('externalConditions', JSON.stringify(externalConditions));
            }

            // 從 localStorage 加載策略數據
            function loadStrategies() {
                const savedStrategies = JSON.parse(localStorage.getItem('strategies'));
                if (savedStrategies && Array.isArray(savedStrategies)) {
                    strategies = savedStrategies;
                } else {
                    // 如果沒有保存的策略，初始化一個默認策略
                    strategies = [{ id: 1, name: '默認策略', description: '這是默認策略' }];
                    saveStrategies();
                }
            }

            // 從 localStorage 加載外部條件數據
            function loadExternalConditions() {
                const savedExternalConditions = JSON.parse(localStorage.getItem('externalConditions'));
                if (savedExternalConditions && Array.isArray(savedExternalConditions)) {
                    externalConditions = savedExternalConditions;
                } else {
                    // 如果沒有保存的外部條件，初始化一個默認外部條件
                    externalConditions = [{ id: 1, name: '默認外部條件', description: '這是默認外部條件' }];
                    saveExternalConditions();
                }
            }

            // 從 localStorage 加載交易數據
            function loadData() {
                const savedTrades = JSON.parse(localStorage.getItem('trades'));
                const savedAveragePosition = localStorage.getItem('averagePosition');
                
                if (savedTrades && Array.isArray(savedTrades)) {
                    // 確保每個交易都有唯一的 ID
                    trades = savedTrades.map(trade => {
                        if (!trade.id) {
                            trade.id = nextTradeId++;
                        } else {
                            if (trade.id >= nextTradeId) {
                                nextTradeId = trade.id + 1;
                            }
                        }
                        return trade;
                    });
                }

                if (trades.length === 0) {
                    trades.push({ id: nextTradeId++, returnRate: '', assetName: '', strategyId: null, externalConditionId: null, openDate: '', closeDate: '' });
                }

                if (savedAveragePosition !== null) {
                    document.getElementById('averagePosition').value = savedAveragePosition;
                }
                
                renderStrategies(); // 渲染策略列表
                renderExternalConditions(); // 渲染外部條件列表
                renderTrades();
                calculateStats();
            }

            // 渲染策略列表
            function renderStrategies() {
                const strategiesList = document.getElementById('strategiesList');
                strategiesList.innerHTML = strategies.map(strategy => `
                    <tr>
                        <td class="border px-4 py-2">${strategy.name}</td>
                        <td class="border px-4 py-2">${strategy.description}</td>
                        <td class="border px-4 py-2 text-center">
                            <button onclick="openEditStrategyModal(${strategy.id})" class="mr-2">
                                <i data-lucide="edit"></i>
                            </button>
                            <button onclick="deleteStrategy(${strategy.id})" class="delete-button">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                renderStrategyFilter(); // 更新策略篩選下拉選單
                lucide.createIcons();
            }

            // 渲染策略篩選下拉選單
            function renderStrategyFilter() {
                const strategyFilter = document.getElementById('strategyFilter');
                strategyFilter.innerHTML = `
                    <option value="">全部策略</option>
                    ${strategies.map(strategy => `
                        <option value="${strategy.id}">${strategy.name}</option>
                    `).join('')}
                `;
            }

            // 渲染外部條件列表
            function renderExternalConditions() {
                const externalConditionsList = document.getElementById('externalConditionsList');
                externalConditionsList.innerHTML = externalConditions.map(condition => `
                    <tr>
                        <td class="border px-4 py-2">${condition.name}</td>
                        <td class="border px-4 py-2">${condition.description}</td>
                        <td class="border px-4 py-2 text-center">
                            <button onclick="openEditExternalConditionModal(${condition.id})" class="mr-2">
                                <i data-lucide="edit"></i>
                            </button>
                            <button onclick="deleteExternalCondition(${condition.id})" class="delete-button">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                renderExternalConditionFilter(); // 更新外部條件篩選下拉選單
                lucide.createIcons();
            }

            // 渲染外部條件篩選下拉選單
            function renderExternalConditionFilter() {
                const externalConditionFilter = document.getElementById('externalConditionFilter');
                externalConditionFilter.innerHTML = `
                    <option value="">全部外部條件</option>
                    ${externalConditions.map(condition => `
                        <option value="${condition.id}">${condition.name}</option>
                    `).join('')}
                `;
            }

            // 渲染交易記錄
            function renderTrades() {
                const tradesList = document.getElementById('tradesList');
                tradesList.innerHTML = '';

                // 根據篩選條件過濾交易紀錄
                let filteredTrades = trades;
                if (selectedStrategyFilter !== null) {
                    filteredTrades = filteredTrades.filter(trade => trade.strategyId === selectedStrategyFilter);
                }
                if (selectedExternalConditionFilter !== null) {
                    filteredTrades = filteredTrades.filter(trade => trade.externalConditionId === selectedExternalConditionFilter);
                }

                // 分配交易編號：僅對有開倉日的交易編號，根據開倉日升序
                const tradesWithOpenDate = filteredTrades.filter(trade => trade.openDate !== '');
                const sortedAscending = [...tradesWithOpenDate].sort((a, b) => new Date(a.openDate) - new Date(b.openDate));
                const transactionNumbers = new Map();
                sortedAscending.forEach((trade, index) => {
                    transactionNumbers.set(trade.id, index + 1);
                });

                // 將沒有開倉日的交易放在最頂端，排序有開倉日的交易為降序
                filteredTrades.sort((a, b) => {
                    if (a.openDate === '' && b.openDate === '') return 0;
                    if (a.openDate === '') return -1; // 無開倉日的交易排在最上方
                    if (b.openDate === '') return 1;  // 無開倉日的交易排在最上方
                    return new Date(b.openDate) - new Date(a.openDate); // 有開倉日的交易按降序排列
                });

                // 渲染排序後的交易紀錄
                tradesList.innerHTML = filteredTrades.map((trade, index) => {
                    const transactionNumber = trade.openDate !== '' ? transactionNumbers.get(trade.id) : '';
                    let holdingDays = '';
                    if (trade.openDate !== '' && trade.closeDate !== '') {
                        const openDate = new Date(trade.openDate);
                        const closeDate = new Date(trade.closeDate);
                        const timeDiff = closeDate - openDate;
                        holdingDays = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                        holdingDays = holdingDays >= 0 ? holdingDays : ''; // 確保持倉天數為正數
                    }

                    return `
                        <tr>
                            <td class="border px-4 py-2 text-center">${transactionNumber}</td>
                            <td class="border px-4 py-2">
                                <input
                                    type="date"
                                    value="${trade.openDate}"
                                    oninput="handleTradeChange(${trades.indexOf(trade)}, 'openDate', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="openDate"
                                >
                            </td>
                            <td class="border px-4 py-2">
                                <input
                                    type="date"
                                    value="${trade.closeDate}"
                                    oninput="handleTradeChange(${trades.indexOf(trade)}, 'closeDate', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="closeDate"
                                >
                            </td>
                            <td class="border px-4 py-2 text-center">
                                ${holdingDays !== '' ? holdingDays : ''}
                            </td>
                            <td class="border px-4 py-2">
                                <input
                                    type="text"
                                    value="${trade.returnRate}"
                                    oninput="handleTradeChange(${trades.indexOf(trade)}, 'returnRate', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    placeholder="+6.66 或 -2.92"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="returnRate"
                                    data-trade-id="${trade.id}"
                                >
                            </td>
                            <td class="border px-4 py-2">
                                <input
                                    type="text"
                                    value="${trade.assetName}"
                                    oninput="handleTradeChange(${trades.indexOf(trade)}, 'assetName', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    placeholder="輸入標的名稱"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="assetName"
                                >
                            </td>
                            <td class="border px-4 py-2">
                                <select
                                    onchange="handleTradeChange(${trades.indexOf(trade)}, 'strategyId', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="strategyId"
                                >
                                    <option value="">選擇策略</option>
                                    ${strategies.map(strategy => `
                                        <option value="${strategy.id}" ${trade.strategyId === strategy.id ? 'selected' : ''}>
                                            ${strategy.name}
                                        </option>
                                    `).join('')}
                                </select>
                            </td>
                            <td class="border px-4 py-2">
                                <select
                                    onchange="handleTradeChange(${trades.indexOf(trade)}, 'externalConditionId', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="externalConditionId"
                                >
                                    <option value="">選擇外部條件</option>
                                    ${externalConditions.map(condition => `
                                        <option value="${condition.id}" ${trade.externalConditionId === condition.id ? 'selected' : ''}>
                                            ${condition.name}
                                        </option>
                                    `).join('')}
                                </select>
                            </td>
                            <td class="border px-4 py-2 text-center">
                                ${trades.length > 1 ? `
                                    <button onclick="removeTrade(${trades.indexOf(trade)})" class="delete-button">
                                        <i data-lucide="trash-2"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // 重新初始化 Lucide 圖標
                lucide.createIcons();

                // 添加按鍵事件監聽器
                const tradeInputs = document.querySelectorAll('.trade-input');
                tradeInputs.forEach(input => {
                    input.addEventListener('keydown', function(event) {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            const currentRow = parseInt(this.getAttribute('data-row-index'));
                            const currentField = this.getAttribute('data-field');

                            if (currentField === 'returnRate') {
                                // 移動到標的名稱欄位
                                const nextField = 'assetName';
                                const nextInput = document.querySelector(`input[data-row-index="${currentRow}"][data-field="${nextField}"]`);
                                if (nextInput) {
                                    nextInput.focus();
                                }
                            } else if (currentField === 'assetName') {
                                // 移動到策略名稱欄位
                                const nextField = 'strategyId';
                                const nextInput = document.querySelector(`select[data-row-index="${currentRow}"][data-field="${nextField}"]`);
                                if (nextInput) {
                                    nextInput.focus();
                                }
                            } else if (currentField === 'strategyId') {
                                // 移動到外部條件欄位
                                const nextField = 'externalConditionId';
                                const nextInput = document.querySelector(`select[data-row-index="${currentRow}"][data-field="${nextField}"]`);
                                if (nextInput) {
                                    nextInput.focus();
                                }
                            } else if (currentField === 'externalConditionId') {
                                // 檢查是否為最後一筆交易，且有有效輸入
                                const trade = trades[currentRow];
                                if (trade.strategyId !== null && trade.strategyId !== '' && trade.externalConditionId !== null && trade.externalConditionId !== '' && trade.returnRate.trim() !== '' && !isNaN(trade.returnRate)) {
                                    addTrade(); // 添加新的交易欄位
                                    setTimeout(() => {
                                        const newInput = document.querySelector(`input[data-trade-id="${nextTradeId - 1}"][data-field="returnRate"]`);
                                        if (newInput) {
                                            newInput.focus(); // 聚焦到新交易的報酬率欄位
                                        }
                                    }, 100);
                                } else {
                                    // 如果當前交易有未填寫的欄位，保持在當前欄位
                                    alert('請確保報酬率、策略和外部條件已正確填寫。');
                                }
                            }
                        }
                    });
                });
            }

            // 處理交易數據變更
            function handleTradeChange(index, field, value) {
                if (field === 'returnRate') {
                    const cleanedValue = value.replace('%', '').trim();
                    if (cleanedValue === '' || isNaN(cleanedValue)) {
                        trades[index].returnRate = '';
                    } else {
                        trades[index].returnRate = cleanedValue;
                    }
                } else if (field === 'assetName') {
                    trades[index].assetName = value.trim();
                } else if (field === 'strategyId') {
                    trades[index].strategyId = value === '' ? null : parseInt(value, 10);
                } else if (field === 'externalConditionId') {
                    trades[index].externalConditionId = value === '' ? null : parseInt(value, 10);
                } else if (field === 'openDate') {
                    trades[index].openDate = value;
                    // 驗證平倉日是否早於開倉日
                    const closeDate = trades[index].closeDate;
                    if (closeDate !== '' && new Date(closeDate) < new Date(value)) {
                        alert('平倉日不能早於開倉日。');
                        trades[index].closeDate = '';
                        document.querySelector(`input[data-row-index="${index}"][data-field="closeDate"]`).value = '';
                    }
                } else if (field === 'closeDate') {
                    trades[index].closeDate = value;
                    // 驗證平倉日是否早於開倉日
                    const openDate = trades[index].openDate;
                    if (openDate !== '' && new Date(value) < new Date(openDate)) {
                        alert('平倉日不能早於開倉日。');
                        trades[index].closeDate = '';
                        document.querySelector(`input[data-row-index="${index}"][data-field="closeDate"]`).value = '';
                    }
                }
                
                // 計算統計數據和保存
                calculateStats();
                saveData(); // 保存數據
            }

            // 添加交易記錄
            function addTrade() {
                if (strategies.length === 0) {
                    alert('請先新增至少一個交易策略。');
                    return;
                }
                if (externalConditions.length === 0) {
                    alert('請先新增至少一個外部條件。');
                    return;
                }

                // 創建新交易並分配唯一的 ID
                const newTrade = { 
                    id: nextTradeId++, 
                    returnRate: '', 
                    assetName: '', 
                    strategyId: null, 
                    externalConditionId: null, 
                    openDate: '', 
                    closeDate: '' 
                };
                trades.unshift(newTrade); // 將新交易插入到陣列的最前端
                
                // 渲染交易記錄、計算統計數據並保存
                renderTrades();
                calculateStats();
                saveData(); // 保存數據

                // 聚焦到新添加的交易的報酬率輸入框
                setTimeout(() => {
                    const newInput = document.querySelector(`input[data-trade-id="${newTrade.id}"][data-field="returnRate"]`);
                    if (newInput) {
                        newInput.focus(); // 聚焦到新交易的報酬率欄位
                    }
                }, 100);
            }

            // 刪除交易記錄
            function removeTrade(index) {
                trades = trades.filter((_, i) => i !== index);
                if (trades.length === 0) {
                    trades.push({ id: nextTradeId++, returnRate: '', assetName: '', strategyId: null, externalConditionId: null, openDate: '', closeDate: '' });
                }
                renderTrades();
                calculateStats();
                saveData(); // 保存數據
            }

            // 開啟新增策略模態框
            function openAddStrategyModal() {
                document.getElementById('addStrategyModal').classList.remove('hidden');
            }

            // 關閉新增策略模態框
            function closeAddStrategyModal() {
                document.getElementById('addStrategyModal').classList.add('hidden');
                document.getElementById('newStrategyName').value = '';
                document.getElementById('newStrategyDescription').value = '';
            }

            // 新增策略
            function addStrategy() {
                const nameInput = document.getElementById('newStrategyName');
                const descriptionInput = document.getElementById('newStrategyDescription');
                const name = nameInput.value.trim();
                const description = descriptionInput.value.trim();

                if (name === '') {
                    alert('策略名稱不能為空。');
                    return;
                }

                // 檢查策略名稱是否已存在
                const existingStrategy = strategies.find(strategy => strategy.name === name);
                if (existingStrategy) {
                    alert('策略名稱已存在，請選擇其他名稱。');
                    return;
                }

                // 生成新的策略 ID
                const newId = strategies.length > 0 ? Math.max(...strategies.map(s => s.id)) + 1 : 1;

                // 新增策略
                strategies.push({ id: newId, name, description });
                saveStrategies();
                renderStrategies();
                renderTrades(); // 更新交易表格中的策略下拉選單
                calculateStats(); // 更新統計數據
                closeAddStrategyModal();
            }

            // 開啟編輯策略模態框
            function openEditStrategyModal(strategyId) {
                const strategy = strategies.find(s => s.id === strategyId);
                if (!strategy) return;

                document.getElementById('editStrategyId').value = strategy.id;
                document.getElementById('editStrategyName').value = strategy.name;
                document.getElementById('editStrategyDescription').value = strategy.description;
                document.getElementById('editStrategyModal').classList.remove('hidden');
            }

            // 關閉編輯策略模態框
            function closeEditStrategyModal() {
                document.getElementById('editStrategyModal').classList.add('hidden');
                document.getElementById('editStrategyId').value = '';
                document.getElementById('editStrategyName').value = '';
                document.getElementById('editStrategyDescription').value = '';
            }

            // 更新策略
            function updateStrategy() {
                const id = parseInt(document.getElementById('editStrategyId').value, 10);
                const name = document.getElementById('editStrategyName').value.trim();
                const description = document.getElementById('editStrategyDescription').value.trim();

                if (name === '') {
                    alert('策略名稱不能為空。');
                    return;
                }

                // 檢查策略名稱是否已存在（排除當前策略）
                const existingStrategy = strategies.find(strategy => strategy.name === name && strategy.id !== id);
                if (existingStrategy) {
                    alert('策略名稱已存在，請選擇其他名稱。');
                    return;
                }

                const strategyIndex = strategies.findIndex(s => s.id === id);
                if (strategyIndex === -1) return;

                // 更新策略
                strategies[strategyIndex].name = name;
                strategies[strategyIndex].description = description;
                saveStrategies();
                renderStrategies();
                renderTrades(); // 更新交易表格中的策略下拉選單
                calculateStats(); // 更新統計數據
                closeEditStrategyModal();
            }

            // 刪除策略
            function deleteStrategy(strategyId) {
                // 檢查是否有交易使用該策略
                const tradesUsingStrategy = trades.filter(trade => trade.strategyId === strategyId);
                if (tradesUsingStrategy.length > 0) {
                    alert('有交易紀錄正在使用此策略，請先移除或更改相關交易紀錄。');
                    return;
                }

                if (!confirm('您確定要刪除此策略嗎？此操作無法撤銷。')) {
                    return;
                }

                strategies = strategies.filter(strategy => strategy.id !== strategyId);
                saveStrategies();
                renderStrategies();
                renderTrades(); // 更新交易表格中的策略下拉選單
                calculateStats(); // 更新統計數據
            }

            // 開啟新增外部條件模態框
            function openAddExternalConditionModal() {
                document.getElementById('addExternalConditionModal').classList.remove('hidden');
            }

            // 關閉新增外部條件模態框
            function closeAddExternalConditionModal() {
                document.getElementById('addExternalConditionModal').classList.add('hidden');
                document.getElementById('newExternalConditionName').value = '';
                document.getElementById('newExternalConditionDescription').value = '';
            }

            // 新增外部條件
            function addExternalCondition() {
                const nameInput = document.getElementById('newExternalConditionName');
                const descriptionInput = document.getElementById('newExternalConditionDescription');
                const name = nameInput.value.trim();
                const description = descriptionInput.value.trim();

                if (name === '') {
                    alert('外部條件名稱不能為空。');
                    return;
                }

                // 檢查外部條件名稱是否已存在
                const existingCondition = externalConditions.find(condition => condition.name === name);
                if (existingCondition) {
                    alert('外部條件名稱已存在，請選擇其他名稱。');
                    return;
                }

                // 生成新的外部條件 ID
                const newId = externalConditions.length > 0 ? Math.max(...externalConditions.map(c => c.id)) + 1 : 1;

                // 新增外部條件
                externalConditions.push({ id: newId, name, description });
                saveExternalConditions();
                renderExternalConditions();
                renderTrades(); // 更新交易表格中的外部條件下拉選單
                calculateStats(); // 更新統計數據
                closeAddExternalConditionModal();
            }

            // 開啟編輯外部條件模態框
            function openEditExternalConditionModal(conditionId) {
                const condition = externalConditions.find(c => c.id === conditionId);
                if (!condition) return;

                document.getElementById('editExternalConditionId').value = condition.id;
                document.getElementById('editExternalConditionName').value = condition.name;
                document.getElementById('editExternalConditionDescription').value = condition.description;
                document.getElementById('editExternalConditionModal').classList.remove('hidden');
            }

            // 關閉編輯外部條件模態框
            function closeEditExternalConditionModal() {
                document.getElementById('editExternalConditionModal').classList.add('hidden');
                document.getElementById('editExternalConditionId').value = '';
                document.getElementById('editExternalConditionName').value = '';
                document.getElementById('editExternalConditionDescription').value = '';
            }

            // 更新外部條件
            function updateExternalCondition() {
                const id = parseInt(document.getElementById('editExternalConditionId').value, 10);
                const name = document.getElementById('editExternalConditionName').value.trim();
                const description = document.getElementById('editExternalConditionDescription').value.trim();

                if (name === '') {
                    alert('外部條件名稱不能為空。');
                    return;
                }

                // 檢查外部條件名稱是否已存在（排除當前外部條件）
                const existingCondition = externalConditions.find(condition => condition.name === name && condition.id !== id);
                if (existingCondition) {
                    alert('外部條件名稱已存在，請選擇其他名稱。');
                    return;
                }

                const conditionIndex = externalConditions.findIndex(c => c.id === id);
                if (conditionIndex === -1) return;

                // 更新外部條件
                externalConditions[conditionIndex].name = name;
                externalConditions[conditionIndex].description = description;
                saveExternalConditions();
                renderExternalConditions();
                renderTrades(); // 更新交易表格中的外部條件下拉選單
                calculateStats(); // 更新統計數據
                closeEditExternalConditionModal();
            }

            // 刪除外部條件
            function deleteExternalCondition(conditionId) {
                // 檢查是否有交易使用該外部條件
                const tradesUsingCondition = trades.filter(trade => trade.externalConditionId === conditionId);
                if (tradesUsingCondition.length > 0) {
                    alert('有交易紀錄正在使用此外部條件，請先移除或更改相關交易紀錄。');
                    return;
                }

                if (!confirm('您確定要刪除此外部條件嗎？此操作無法撤銷。')) {
                    return;
                }

                externalConditions = externalConditions.filter(condition => condition.id !== conditionId);
                saveExternalConditions();
                renderExternalConditions();
                renderTrades(); // 更新交易表格中的外部條件下拉選單
                calculateStats(); // 更新統計數據
            }

            // 策略和外部條件篩選功能
            function applyFilters() {
                const strategyId = document.getElementById('strategyFilter').value;
                const externalConditionId = document.getElementById('externalConditionFilter').value;

                selectedStrategyFilter = strategyId === '' ? null : parseInt(strategyId, 10);
                selectedExternalConditionFilter = externalConditionId === '' ? null : parseInt(externalConditionId, 10);

                calculateStats();
                renderTrades();
            }

            // 渲染交易記錄
            function renderTrades() {
                const tradesList = document.getElementById('tradesList');
                tradesList.innerHTML = '';

                // 根據篩選條件過濾交易紀錄
                let filteredTrades = trades;
                if (selectedStrategyFilter !== null) {
                    filteredTrades = filteredTrades.filter(trade => trade.strategyId === selectedStrategyFilter);
                }
                if (selectedExternalConditionFilter !== null) {
                    filteredTrades = filteredTrades.filter(trade => trade.externalConditionId === selectedExternalConditionFilter);
                }

                // 分配交易編號：僅對有開倉日的交易編號，根據開倉日升序
                const tradesWithOpenDate = filteredTrades.filter(trade => trade.openDate !== '');
                const sortedAscending = [...tradesWithOpenDate].sort((a, b) => new Date(a.openDate) - new Date(b.openDate));
                const transactionNumbers = new Map();
                sortedAscending.forEach((trade, index) => {
                    transactionNumbers.set(trade.id, index + 1);
                });

                // 將沒有開倉日的交易放在最頂端，排序有開倉日的交易為降序
                filteredTrades.sort((a, b) => {
                    if (a.openDate === '' && b.openDate === '') return 0;
                    if (a.openDate === '') return -1; // 無開倉日的交易排在最上方
                    if (b.openDate === '') return 1;  // 無開倉日的交易排在最上方
                    return new Date(b.openDate) - new Date(a.openDate); // 有開倉日的交易按降序排列
                });

                // 渲染排序後的交易紀錄
                tradesList.innerHTML = filteredTrades.map((trade, index) => {
                    const transactionNumber = trade.openDate !== '' ? transactionNumbers.get(trade.id) : '';
                    let holdingDays = '';
                    if (trade.openDate !== '' && trade.closeDate !== '') {
                        const openDate = new Date(trade.openDate);
                        const closeDate = new Date(trade.closeDate);
                        const timeDiff = closeDate - openDate;
                        holdingDays = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                        holdingDays = holdingDays >= 0 ? holdingDays : ''; // 確保持倉天數為正數
                    }

                    return `
                        <tr>
                            <td class="border px-4 py-2 text-center">${transactionNumber}</td>
                            <td class="border px-4 py-2">
                                <input
                                    type="date"
                                    value="${trade.openDate}"
                                    oninput="handleTradeChange(${trades.indexOf(trade)}, 'openDate', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="openDate"
                                >
                            </td>
                            <td class="border px-4 py-2">
                                <input
                                    type="date"
                                    value="${trade.closeDate}"
                                    oninput="handleTradeChange(${trades.indexOf(trade)}, 'closeDate', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="closeDate"
                                >
                            </td>
                            <td class="border px-4 py-2 text-center">
                                ${holdingDays !== '' ? holdingDays : ''}
                            </td>
                            <td class="border px-4 py-2">
                                <input
                                    type="text"
                                    value="${trade.returnRate}"
                                    oninput="handleTradeChange(${trades.indexOf(trade)}, 'returnRate', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    placeholder="+6.66 或 -2.92"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="returnRate"
                                    data-trade-id="${trade.id}"
                                >
                            </td>
                            <td class="border px-4 py-2">
                                <input
                                    type="text"
                                    value="${trade.assetName}"
                                    oninput="handleTradeChange(${trades.indexOf(trade)}, 'assetName', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    placeholder="輸入標的名稱"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="assetName"
                                >
                            </td>
                            <td class="border px-4 py-2">
                                <select
                                    onchange="handleTradeChange(${trades.indexOf(trade)}, 'strategyId', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="strategyId"
                                >
                                    <option value="">選擇策略</option>
                                    ${strategies.map(strategy => `
                                        <option value="${strategy.id}" ${trade.strategyId === strategy.id ? 'selected' : ''}>
                                            ${strategy.name}
                                        </option>
                                    `).join('')}
                                </select>
                            </td>
                            <td class="border px-4 py-2">
                                <select
                                    onchange="handleTradeChange(${trades.indexOf(trade)}, 'externalConditionId', this.value)"
                                    class="w-full p-1 border rounded trade-input"
                                    data-row-index="${trades.indexOf(trade)}"
                                    data-field="externalConditionId"
                                >
                                    <option value="">選擇外部條件</option>
                                    ${externalConditions.map(condition => `
                                        <option value="${condition.id}" ${trade.externalConditionId === condition.id ? 'selected' : ''}>
                                            ${condition.name}
                                        </option>
                                    `).join('')}
                                </select>
                            </td>
                            <td class="border px-4 py-2 text-center">
                                ${trades.length > 1 ? `
                                    <button onclick="removeTrade(${trades.indexOf(trade)})" class="delete-button">
                                        <i data-lucide="trash-2"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // 重新初始化 Lucide 圖標
                lucide.createIcons();

                // 添加按鍵事件監聽器
                const tradeInputs = document.querySelectorAll('.trade-input');
                tradeInputs.forEach(input => {
                    input.addEventListener('keydown', function(event) {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            const currentRow = parseInt(this.getAttribute('data-row-index'));
                            const currentField = this.getAttribute('data-field');

                            if (currentField === 'returnRate') {
                                // 移動到標的名稱欄位
                                const nextField = 'assetName';
                                const nextInput = document.querySelector(`input[data-row-index="${currentRow}"][data-field="${nextField}"]`);
                                if (nextInput) {
                                    nextInput.focus();
                                }
                            } else if (currentField === 'assetName') {
                                // 移動到策略名稱欄位
                                const nextField = 'strategyId';
                                const nextInput = document.querySelector(`select[data-row-index="${currentRow}"][data-field="${nextField}"]`);
                                if (nextInput) {
                                    nextInput.focus();
                                }
                            } else if (currentField === 'strategyId') {
                                // 移動到外部條件欄位
                                const nextField = 'externalConditionId';
                                const nextInput = document.querySelector(`select[data-row-index="${currentRow}"][data-field="${nextField}"]`);
                                if (nextInput) {
                                    nextInput.focus();
                                }
                            } else if (currentField === 'externalConditionId') {
                                // 檢查是否為最後一筆交易，且有有效輸入
                                const trade = trades[currentRow];
                                if (trade.strategyId !== null && trade.strategyId !== '' && trade.externalConditionId !== null && trade.externalConditionId !== '' && trade.returnRate.trim() !== '' && !isNaN(trade.returnRate)) {
                                    addTrade(); // 添加新的交易欄位
                                    setTimeout(() => {
                                        const newInput = document.querySelector(`input[data-trade-id="${nextTradeId - 1}"][data-field="returnRate"]`);
                                        if (newInput) {
                                            newInput.focus(); // 聚焦到新交易的報酬率欄位
                                        }
                                    }, 100);
                                } else {
                                    // 如果當前交易有未填寫的欄位，保持在當前欄位
                                    alert('請確保報酬率、策略和外部條件已正確填寫。');
                                }
                            }
                        }
                    });
                });
            }

            // 處理交易數據變更
            function handleTradeChange(index, field, value) {
                if (field === 'returnRate') {
                    const cleanedValue = value.replace('%', '').trim();
                    if (cleanedValue === '' || isNaN(cleanedValue)) {
                        trades[index].returnRate = '';
                    } else {
                        trades[index].returnRate = cleanedValue;
                    }
                } else if (field === 'assetName') {
                    trades[index].assetName = value.trim();
                } else if (field === 'strategyId') {
                    trades[index].strategyId = value === '' ? null : parseInt(value, 10);
                } else if (field === 'externalConditionId') {
                    trades[index].externalConditionId = value === '' ? null : parseInt(value, 10);
                } else if (field === 'openDate') {
                    trades[index].openDate = value;
                    // 驗證平倉日是否早於開倉日
                    const closeDate = trades[index].closeDate;
                    if (closeDate !== '' && new Date(closeDate) < new Date(value)) {
                        alert('平倉日不能早於開倉日。');
                        trades[index].closeDate = '';
                        document.querySelector(`input[data-row-index="${index}"][data-field="closeDate"]`).value = '';
                    }
                } else if (field === 'closeDate') {
                    trades[index].closeDate = value;
                    // 驗證平倉日是否早於開倉日
                    const openDate = trades[index].openDate;
                    if (openDate !== '' && new Date(value) < new Date(openDate)) {
                        alert('平倉日不能早於開倉日。');
                        trades[index].closeDate = '';
                        document.querySelector(`input[data-row-index="${index}"][data-field="closeDate"]`).value = '';
                    }
                }
                
                // 計算統計數據和保存
                calculateStats();
                saveData(); // 保存數據
            }

            // 計算統計數據
            function calculateStats() {
                let validTrades = trades.filter(trade => 
                    trade.returnRate !== '' && !isNaN(parseFloat(trade.returnRate))
                );

                if (selectedStrategyFilter !== null) {
                    validTrades = validTrades.filter(trade => trade.strategyId === selectedStrategyFilter);
                }

                if (selectedExternalConditionFilter !== null) {
                    validTrades = validTrades.filter(trade => trade.externalConditionId === selectedExternalConditionFilter);
                }

                if (validTrades.length === 0) {
                    // 重置統計數據
                    document.getElementById('totalTrades').textContent = '0';
                    document.getElementById('winRate').textContent = '0% (0勝0敗)';
                    document.getElementById('riskRewardRatio').textContent = '0';
                    document.getElementById('avgWin').textContent = '+0 (+0.00%)';
                    document.getElementById('avgLoss').textContent = '-0 (-0.00%)';
                    document.getElementById('maxWin').textContent = '+0 (+0.00%)';
                    document.getElementById('maxLoss').textContent = '-0 (-0.00%)';
                    document.getElementById('expectedValue').textContent = '0.0%';
                    document.getElementById('totalReturn').textContent = '0%';
                    
                    // 移除顏色類別
                    removeColorClasses(['expectedValue', 'totalReturn']);
                    
                    return;
                }

                const results = validTrades.map(trade => parseFloat(trade.returnRate));
                const wins = results.filter(result => result > 0);
                const losses = results.filter(result => result < 0);

                const winRate = (wins.length / results.length) * 100;
                const avgWinRate = wins.length > 0 ? wins.reduce((a, b) => a + b) / wins.length : 0;
                const avgLossRate = losses.length > 0 ? losses.reduce((a, b) => a + b) / losses.length : 0; // 保留負號
                const maxWinRate = wins.length > 0 ? Math.max(...wins) : 0;
                const maxLossRate = losses.length > 0 ? Math.min(...losses) : 0; // 保留負號
                const riskRewardRatio = avgLossRate !== 0 ? (avgWinRate / Math.abs(avgLossRate)) : 0;
                const expectedReturnRate = (winRate / 100 * avgWinRate) - ((100 - winRate) / 100 * Math.abs(avgLossRate));
                const totalReturnRate = results.reduce((sum, rate) => sum + rate, 0);

                // 獲取平均部位金額
                const averagePositionInput = document.getElementById('averagePosition').value;
                const averagePosition = parseFloat(averagePositionInput);

                // 計算金額
                const expectedValueAmount = (expectedReturnRate / 100) * (isNaN(averagePosition) ? 0 : averagePosition);
                const totalReturnAmount = (totalReturnRate / 100) * (isNaN(averagePosition) ? 0 : averagePosition);

                // 更新基本統計數據
                document.getElementById('totalTrades').textContent = formatTradeCount(results.length);
                document.getElementById('winRate').textContent = `${formatNumber(winRate.toFixed(2))}% (${wins.length}勝${losses.length}敗)`;
                // 使用 formatNumberNoSign 以移除 "+" 符號
                document.getElementById('riskRewardRatio').textContent = formatNumberNoSign(riskRewardRatio.toFixed(2));

                // 更新次級報告欄位
                document.getElementById('avgWin').textContent = (averagePosition && !isNaN(averagePosition) && averagePosition > 0) 
                    ? `${formatNumber((avgWinRate / 100) * averagePosition, true, 0)} (${formatNumber(avgWinRate, false, 2)}%)` 
                    : `(${formatNumber(avgWinRate, false, 2)}%)`;
                document.getElementById('avgLoss').textContent = (averagePosition && !isNaN(averagePosition) && averagePosition > 0) 
                    ? `${formatNumber((avgLossRate / 100) * averagePosition, true, 0)} (${formatNumber(avgLossRate, false, 2)}%)` 
                    : `(${formatNumber(avgLossRate, false, 2)}%)`;
                document.getElementById('maxWin').textContent = (averagePosition && !isNaN(averagePosition) && averagePosition > 0) 
                    ? `${formatNumber((maxWinRate / 100) * averagePosition, true, 0)} (${formatNumber(maxWinRate, false, 2)}%)` 
                    : `(${formatNumber(maxWinRate, false, 2)}%)`;
                document.getElementById('maxLoss').textContent = (averagePosition && !isNaN(averagePosition) && averagePosition > 0) 
                    ? `${formatNumber((maxLossRate / 100) * averagePosition, true, 0)} (${formatNumber(maxLossRate, false, 2)}%)` 
                    : `(${formatNumber(maxLossRate, false, 2)}%)`;

                // 更新 "期望值" 顯示及顏色，僅顯示到小數點第一位
                const expectedValueElem = document.getElementById('expectedValue');
                if (averagePosition && !isNaN(averagePosition) && averagePosition > 0) {
                    expectedValueElem.textContent = `${formatNumber(expectedValueAmount.toFixed(1), true, 1)} (${formatNumber(expectedReturnRate.toFixed(2), false, 2)}%)`;
                } else {
                    expectedValueElem.textContent = `(${formatNumber(expectedReturnRate.toFixed(2), false, 2)}%)`;
                }

                // 更新顏色
                if (expectedReturnRate > 0) {
                    expectedValueElem.classList.add('text-red-500');
                    expectedValueElem.classList.remove('text-green-500');
                } else if (expectedReturnRate < 0) {
                    expectedValueElem.classList.add('text-green-500');
                    expectedValueElem.classList.remove('text-red-500');
                } else {
                    expectedValueElem.classList.remove('text-red-500', 'text-green-500');
                }

                // 更新 "總報酬" 顯示及顏色，金額無小數點，百分比顯示兩位小數
                const totalReturnElem = document.getElementById('totalReturn');
                if (averagePosition && !isNaN(averagePosition) && averagePosition > 0) {
                    totalReturnElem.textContent = `${formatNumber(totalReturnAmount, true, 0)} (${formatNumber(totalReturnRate, false, 2)}%)`;
                } else {
                    totalReturnElem.textContent = `(${formatNumber(totalReturnRate, false, 2)}%)`;
                }

                // 更新顏色
                if (totalReturnRate > 0) {
                    totalReturnElem.classList.add('text-red-500');
                    totalReturnElem.classList.remove('text-green-500');
                } else if (totalReturnRate < 0) {
                    totalReturnElem.classList.add('text-green-500');
                    totalReturnElem.classList.remove('text-red-500');
                } else {
                    totalReturnElem.classList.remove('text-red-500', 'text-green-500');
                }
            }

            // 移除特定元素的顏色類別
            function removeColorClasses(elementIds) {
                elementIds.forEach(id => {
                    const elem = document.getElementById(id);
                    elem.classList.remove('text-red-500', 'text-green-500');
                });
            }

            // 初始化
            loadStrategies();
            loadExternalConditions();
            loadData(); // 載入數據

            // 監聽平均部位金額的變化以保存數據
            document.getElementById('averagePosition').addEventListener('change', function() {
                calculateStats();
                saveData(); // 保存數據
            });

            // 可選：添加清除數據的功能
            // 若需要添加清除數據的按鈕，取消以下註解並在適當位置添加按鈕
            /*
            function clearData() {
                if (confirm('您確定要清除所有數據嗎？此操作無法撤銷。')) {
                    localStorage.removeItem('trades');
                    localStorage.removeItem('averagePosition');
                    localStorage.removeItem('strategies');
                    localStorage.removeItem('externalConditions');
                    trades = [{ id: nextTradeId++, returnRate: '', assetName: '', strategyId: null, externalConditionId: null, openDate: '', closeDate: '' }];
                    strategies = [{ id: 1, name: '默認策略', description: '這是默認策略' }];
                    externalConditions = [{ id: 1, name: '默認外部條件', description: '這是默認外部條件' }];
                    document.getElementById('averagePosition').value = '';
                    renderStrategies();
                    renderExternalConditions();
                    renderTrades();
                    calculateStats();
                }
            }
            */
        </script>
    </div>
</body>
</html>
